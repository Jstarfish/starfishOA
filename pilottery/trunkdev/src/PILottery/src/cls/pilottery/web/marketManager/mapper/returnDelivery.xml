<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.marketManager.dao.ReturnDeliveryDao">
	<resultMap id="returnDeliveryMap" type="cls.pilottery.web.marketManager.entity.ReturnDeliveryOrder" >
	    <id column="RETURN_NO" property="returnNo" jdbcType="CHAR" />
	    <result column="MARKET_MANAGER_ADMIN" property="marketManagerAdmin"/>
	    <result column="APPLY_DATE" property="applyDate" />
	    <result column="APPLY_TICKETS" property="applyTickets" />
	    <result column="APPLY_AMOUNT" property="applyAmount" />
	    <result column="FINANCE_ADMIN" property="financeAdmin"/>
	    <result column="APPROVE_DATE" property="approveDate" />
	    <result column="APPROVE_REMARK" property="approveRemark" />
	    <result column="ACT_TICKETS" property="actTickets" />
	    <result column="ACT_AMOUNT" property="actAmount" />
	    <result column="STATUS" property="status"/>
	    <result column="IS_DIRECT_AUDITED" property="isDirectAudited" />
	    <result column="DIRECT_AMOUNT" property="directAmount" />
	    <result column="RECEIVE_ORG" property="receiveOrg" />
	    <result column="RECEIVE_WH" property="receiveWh"/>
	    <result column="RECEIVE_MANAGER" property="receiveManager" />
	    <result column="RECEIVE_DATE" property="receiveDate"  />
	    <result column="MARKET_MANAGER_NAME" property="marketAdminName"/>
	    <result column="WAREHOUSE_MANAGER" property="warehouseManager" />
	    <result column="FINANCE_ADMIN_NAME" property="financeAdminName"  />
	    <collection property="rdDetail" ofType="cls.pilottery.web.marketManager.entity.ReturnDeliveryDetail">
			<id column="SEQUENCE_NO" property="sequenceNo" />
		    <result column="RETURN_NO" property="returnNo" />
		    <result column="PLAN_CODE" property="planCode" />
		    <result column="TICKETS" property="tickets" />
		    <result column="PACKAGES" property="packages" />
		    <result column="AMOUNT" property="amount" />
		    <result column="PLAN_NAME" property="planName" />
		</collection>
	</resultMap>
	
	<select id="getReturnDeliveryList" parameterType="cls.pilottery.web.marketManager.form.ReturnDeliveryForm"	resultMap="returnDeliveryMap">
		select * from (
		select tab.*,rownum rn from (
			SELECT RETURN_NO,
			       MARKET_MANAGER_ADMIN,
			       b.ADMIN_LOGIN MARKET_MANAGER_NAME,
			       RECEIVE_MANAGER,
			       d.ADMIN_LOGIN WAREHOUSE_MANAGER,
			       APPLY_DATE,
			       APPLY_TICKETS,
			       APPLY_AMOUNT,
			       FINANCE_ADMIN,
			       c.ADMIN_LOGIN FINANCE_ADMIN_NAME,
			       STATUS
			  FROM SALE_RETURN_RECODER a
			  LEFT JOIN ADM_INFO b ON (a.MARKET_MANAGER_ADMIN = b.ADMIN_ID)
			  LEFT JOIN ADM_INFO c ON (a.FINANCE_ADMIN = c.ADMIN_ID)
			  LEFT JOIN ADM_INFO d ON (a.RECEIVE_MANAGER = d.ADMIN_ID)
			 WHERE a.MARKET_MANAGER_ADMIN = #{currentUserId}
		<if test="queryNo != null and queryNo != ''">
			AND A.RETURN_NO = #{queryNo}
		</if>
		<if test="queryDate != null and queryDate != ''">
			AND to_char(a.APPLY_DATE,'yyyy-mm-dd') = #{queryDate}
		</if>
		<![CDATA[ ) TAB ) where rn > ${beginNum} and rn <= ${endNum} 
		ORDER BY APPLY_DATE DESC
		]]>
	</select>

	<select id="getReturnDeliveryCount" parameterType="cls.pilottery.web.marketManager.form.ReturnDeliveryForm"	resultType="Integer">
		SELECT count(1)
		FROM SALE_RETURN_RECODER
		WHERE MARKET_MANAGER_ADMIN = #{currentUserId}
		<if test="queryNo != null and queryNo != ''">
			AND RETURN_NO = #{queryNo}
		</if>
		<if test="queryDate != null and queryDate != ''">
			AND to_char(APPLY_DATE,'yyyy-mm-dd') = #{queryDate}
		</if>
	</select> 
	
	<select id="getReturnDeliverySeq" resultType="string">
		select F_GET_SALE_RETURN_RECODER_SEQ from dual
	</select>
	
	<insert id="saveReturnDeliveryDetail" parameterType="cls.pilottery.web.marketManager.entity.ReturnDeliveryDetail">
		INSERT INTO SALE_RETURN_APPLY_DETAIL(RETURN_NO, SEQUENCE_NO, PLAN_CODE, TICKETS, PACKAGES, AMOUNT)
		VALUES (#{returnNo},F_GET_DETAIL_SEQUENCE_NO_SEQ,#{planCode},#{tickets},#{packages},#{amount})
	</insert>
	
	<insert id="saveReturnDelivery" parameterType="cls.pilottery.web.marketManager.entity.ReturnDeliveryOrder">
		INSERT INTO SALE_RETURN_RECODER(RETURN_NO, MARKET_MANAGER_ADMIN, APPLY_DATE, APPLY_TICKETS, APPLY_AMOUNT, IS_DIRECT_AUDITED,STATUS)
		VALUES (#{returnNo},#{marketManagerAdmin},sysdate,#{applyTickets},#{applyAmount},0,1)
	</insert>
	
	<insert id="saveReturnDeliveryDirect" parameterType="cls.pilottery.web.marketManager.entity.ReturnDeliveryOrder">
		INSERT INTO SALE_RETURN_RECODER(RETURN_NO, MARKET_MANAGER_ADMIN, APPLY_DATE, APPLY_TICKETS, APPLY_AMOUNT,APPROVE_DATE,APPROVE_REMARK,DIRECT_AMOUNT,IS_DIRECT_AUDITED, STATUS)
		VALUES (#{returnNo},#{marketManagerAdmin},sysdate,#{applyTickets},#{applyAmount},sysdate,'The system automatically approved',#{directAmount},1,7)
	</insert>
	
	<select id="getDirectAmount" resultType="long">
		select SYS_DEFAULT_VALUE from SYS_PARAMETER where SYS_DEFAULT_SEQ = 1
	</select>
	
	<select id="getReturnDeliveryDetail" parameterType="string" resultMap="returnDeliveryMap">
		WITH orders as (
		SELECT RETURN_NO,
		       MARKET_MANAGER_ADMIN,
		       b.ADMIN_LOGIN MARKET_MANAGER_NAME,
		       RECEIVE_MANAGER,
		       d.ADMIN_LOGIN WAREHOUSE_MANAGER,
		       APPLY_DATE,
		       APPLY_TICKETS,
		       APPLY_AMOUNT,
		       FINANCE_ADMIN,
		       c.ADMIN_LOGIN FINANCE_ADMIN_NAME,
		       STATUS,
		       APPROVE_REMARK
		  FROM SALE_RETURN_RECODER a
		  LEFT JOIN ADM_INFO b ON (a.MARKET_MANAGER_ADMIN = b.ADMIN_ID)
		  LEFT JOIN ADM_INFO c ON (a.FINANCE_ADMIN = c.ADMIN_ID)
		  LEFT JOIN ADM_INFO d ON (a.RECEIVE_MANAGER = d.ADMIN_ID)
		 WHERE RETURN_NO = #{returnNo}
		),
		detail as (
		select RETURN_NO, SEQUENCE_NO, X.PLAN_CODE,FULL_NAME AS PLAN_NAME,TICKETS, PACKAGES, AMOUNT 
		from SALE_RETURN_APPLY_DETAIL x, game_plans y
		where x.plan_code = y.plan_code
		and RETURN_NO = #{returnNo}
		)
		SELECT orders.*,detail.SEQUENCE_NO, detail.PLAN_CODE,detail.PLAN_NAME,detail.TICKETS, detail.PACKAGES , detail.AMOUNT  
		from detail,orders
		where detail.RETURN_NO(+) = orders.RETURN_NO
	</select>
	
	<update id="modifyReturnDeliveryStatus" parameterType="map">
		update SALE_RETURN_RECODER set status = #{status} where RETURN_NO = #{returnNo}
	</update>
	
	<delete id="deleteReturnDeliveryDetails" parameterType="string">
		delete from SALE_RETURN_APPLY_DETAIL where RETURN_NO = #{returnNo}
	</delete>
	
	<update id="updateReturnDeliveryDirect" parameterType="cls.pilottery.web.marketManager.entity.ReturnDeliveryOrder">
		UPDATE SALE_RETURN_RECODER
		SET MARKET_MANAGER_ADMIN = #{marketManagerAdmin},
			APPLY_DATE = SYSDATE,
			APPLY_TICKETS = #{applyTickets},
			APPLY_AMOUNT = #{applyAmount},
			APPROVE_DATE = SYSDATE,
			APPROVE_REMARK = 'The system automatically approved',
			DIRECT_AMOUNT = #{directAmount},
			IS_DIRECT_AUDITED = 1,
			STATUS = 7
		WHERE RETURN_NO = #{returnNo}
	</update>
	
	<update id="updateReturnDelivery" parameterType="cls.pilottery.web.marketManager.entity.ReturnDeliveryOrder">
		UPDATE SALE_RETURN_RECODER
		SET MARKET_MANAGER_ADMIN = #{marketManagerAdmin},
			APPLY_DATE = SYSDATE,
			APPLY_TICKETS = #{applyTickets},
			APPLY_AMOUNT = #{applyAmount},
			IS_DIRECT_AUDITED = 0,
			STATUS = 1
		WHERE RETURN_NO = #{returnNo}
	</update>
</mapper>
