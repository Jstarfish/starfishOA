<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.system.dao.RoleDao">
	<resultMap type="cls.pilottery.web.system.model.Role" id="role">
		<id column="ROLE_ID" property="id" />
		<result column="ROLE_NAME" property="name" />
		<result column="IS_ACTIVE" property="active" />
		<result column="ROLE_COMMENT" property="comment" />
		<result column="ROLE_CODE" property="code" />
	</resultMap>


	<resultMap type="cls.pilottery.web.system.model.PrivilegeTree"
		id="privilegeTree">
		<result column="id" property="id" jdbcType="DECIMAL" />
		<result column="pid" property="pid" jdbcType="DECIMAL" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="checked" property="checked" jdbcType="BOOLEAN" />
	</resultMap>

	<!-- 关联查询 -->
	<resultMap type="cls.pilottery.web.system.model.Role" id="roleMap"
		extends="role">
<!-- 		<collection property="privilegeList" -->
<!-- 			ofType="cls.pilottery.web.system.model.Privilege" column="ROLE_ID" -->
<!-- 			select="getRolePrivilege" /> -->
	</resultMap>

	<select id="getRoleCount" parameterType="cls.pilottery.web.system.model.Role"
		resultType="Integer">
		select count(1) from ADM_ROLE r where 1=1
		<if test="id != null and id != 0">
			and r.ROLE_ID = ${id}
		</if>
	</select>

	<!-- note:oracle分页查询，a.*是查询别名是a的表的所有列，rownum rn就是将行rownum起个别名rn -->
	<select id="getRoleList" parameterType="cls.pilottery.web.system.model.Role"
		resultMap="role">
		select * from (
		select a.*,rownum rn from (
		select * from ADM_ROLE r
		where 1=1
		<if test="id != null and id != 0">
			and r.ROLE_ID = ${id}
		</if>
	<![CDATA[ order by r.ROLE_ID) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<select id="getAllRoleList" resultMap="role">
		select * from ADM_ROLE r
		order by r.ROLE_ID
	</select>
	
	 <!-- 根据role表中的id查询角色信息 -->  
    <select id="getRoleById" parameterType="long" resultMap="roleMap">  
        select * from ADM_ROLE where ROLE_ID = #{id}  
    </select> 
    <select id="getRoleByName" parameterType="string" resultMap="roleMap">  
        select * from ADM_ROLE where ROLE_NAME = #{name}  
    </select> 
    
    <!-- 从用户角色信息表中 查询当前用户下的角色数量  note: 注意resultMap和resultType的区别 这里返回值是integer类型的-->
	<select id="getCountAdminRole" parameterType="long"
		resultType="Integer">
		 select count(*) from ADM_ROLE_ADMIN a where a.ROLE_ID = #{id}
	</select>
	
	<!-- 删除角色 -->
	<!-- 根据用户ID删除角色用户对应表中该用户的所有角色 -->  
    <delete id="deleteRole" parameterType="cls.pilottery.web.system.model.Role">  
        delete from ADM_ROLE where ROLE_ID = #{id}
    </delete> 
    
       <!-- 新增角色 -->  
    <insert id="saveRole" parameterType="cls.pilottery.web.system.model.Role">  
    	 <selectKey resultType="java.lang.Long" order="BEFORE" keyProperty="id">
    	 <!-- note：为了解决mybatis主键不能添加的问题 -->
			 SELECT f_get_adm_id_seq FROM DUAL
		</selectKey> 
        insert into ADM_ROLE(ROLE_ID,ROLE_NAME,ROLE_COMMENT) values(#{id},#{name},#{comment})  
    </insert> 
    
        <!-- 修改角色信息 -->  
    <update id="updateRole" parameterType="cls.pilottery.web.system.model.Role">  
        update ADM_ROLE r set r.ROLE_NAME=#{name},r.ROLE_COMMENT=#{comment} where r.ROLE_ID=#{id}
    </update> 
    
    <!-- 新增角色用户 -->
 	<update id="saveRoleUser" statementType="CALLABLE" parameterType="cls.pilottery.web.system.model.Role">
		 {call p_roleuser_create(
    	        #{id,mode=IN,jdbcType=NUMERIC},
    	        #{users,mode=IN,jdbcType=VARCHAR},
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}	        
		 	)
		 }
	</update>

	<!-- 查询所有角色 -->
	<select id="getRoleInfo" parameterType="cls.pilottery.web.system.form.RoleForm"
		resultType="cls.pilottery.web.system.model.Role">
		select A.ROLE_ID as roleId,
		A.ROLE_NAME as roleName
		from ADM_ROLE A
		where 1 = 1
		and A.IS_ACTIVE!=0
	</select>

<!-- 根据父id查询权限 -->
	<select id="selectPrivilegeCode" parameterType="String"
		resultMap="privilegeTree">
		select p.privilege_id as id,
		p.privilege_parent as pid,
		p.privilege_name as name,
		nvl2(r.privilege_id, 1, 0) as checked
		from adm_privilege p
		left join adm_role_privilege r
		on p.privilege_id = r.privilege_id
		and r.role_id = #{id}
	connect by nocycle prior r.privilege_id = p.privilege_parent
		order by p.privilege_parent 
	</select>

	<!-- 删除RoleId下的所有privalegeId -->
	<delete id="deletePrivilege" parameterType="String">
		DELETE FROM ADM_ROLE_PRIVILEGE
		WHERE ROLE_ID = #{id}
	</delete>
	
	<!-- 插入角色-权限信息 -->
 	<insert  id="saveRoleBatchPrivilege" parameterType="java.util.List">
		insert into ADM_ROLE_PRIVILEGE
		(ROLE_ID,
		PRIVILEGE_ID) values 
	  <foreach collection="list" item="item" index="index"  
	        separator=","> 
	        ( #{item.roleId}, #{item.priId})  
	    </foreach> 
	</insert> 
	 
	 <update id="saveRoleBatchPrivileges" parameterType="cls.pilottery.web.system.model.BatchRolePrivilege"
        statementType="CALLABLE">
        {call p_roleprivilege_create (
        #{roleid,mode=IN,jdbcType=NUMERIC},#{pids,mode=IN,jdbcType=VARCHAR},
        #{errorCode,mode=OUT,jdbcType=NUMERIC},#{errorMessage,mode=OUT,jdbcType=VARCHAR}
        )
        }
    </update>

	<!-- 根据角色ID删除角色权限对应表中该角色的所有权限 -->
	<delete id="deleteRolePrivilege" parameterType="String">
		delete from
		ADM_ROLE_PRIVILEGE where ROLE_ID = #{id}
	</delete>
</mapper>
