<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.lottery.dao.RefundqueryDao">
	<resultMap type="cls.pilottery.oms.lottery.model.SaleCancelInfo"
		id="saleCancelInfo">
		<id column="GUI_CANCEL_FLOW" property="id" />
		<result column="SALE_TSN" property="saleTsn" />
		<result column="APPLYFLOW_SELL" property="applyflowSell" />
		<result column="CANCEL_TSN" property="cancelTsn" />
		<result column="SALE_AGENCY_CODE" property="saleAgencyCode" />
		<result column="CANCEL_ORG_CODE" property="cancelAgencyCode" />
		<result column="GAME_CODE" property="gameCode" />
		<result column="ISSUE_NUMBER" property="issueNumer" />
		<result column="CANCEL_AMOUNT" property="cancelAmount" />
		<result column="CANCELER_NAME" property="canceler" />
		<result column="CANCELER_ADMIN" property="cancelerAdmin" />
		<result column="CANCEL_TIME" property="cancelTime" />
		<result column="CANCEL_COMM" property="cancelComm" />
		<result column="IS_SUCCESS" property="isSuccess" />
		<result column="HTML_TEXT" property="htmlText" />


	</resultMap>
	<select id="getSaleCancelcount" parameterType="cls.pilottery.oms.lottery.form.SaleCancelInfoForm"
		resultType="Integer">
		select count(1)
		from SALE_CANCELINFO s
		left join INF_GAMES ga
		on s.game_code = ga.game_code
		where 1=1

		<if test="canceler != null and canceler !=''">
			and s.CANCELER_NAME = #{canceler}  
        </if>
		<if test="satrtcancelTime != null and satrtcancelTime != ''">  
           <![CDATA[and to_char(s.CANCEL_TIME,'yyyy-MM-dd') >=#{satrtcancelTime}]]>
		</if>
		<if test="endcancelTime!=null and endcancelTime!=''">
         <![CDATA[and  to_char(s.CANCEL_TIME,'yyyy-MM-dd')<=#{endcancelTime}]]>
		</if>
		<if test="areaCode!=null and areaCode!=''">
			<if test="areaCode!=0">
			and	s.CANCEL_ORG_CODE like #{ areaCode}||'%'
        	</if>
		</if>
	</select>
	<select id="getSaleCancelList" parameterType="cls.pilottery.oms.lottery.form.SaleCancelInfoForm"
		resultType="cls.pilottery.oms.lottery.vo.SaleCancelInfoVo">
		select *
		from (select b.*,rownum rn from  (select s.CANCELER_NAME as canceler,
		s.cancel_time as cancelTime,
		s.gui_cancel_flow as id,
		ga.short_name as gameName,
		s.is_success as isSuccess,
		s.cancel_amount as cancelAmount,
		s.sale_tsn as saleTsn,
		s.sale_agency_code as saleAgencyCode,
		s.CANCEL_ORG_CODE as cancelAgencyCode,
		s.cancel_comm as cancelComm,
		s.cancel_tsn as cancelTsn
	
		from SALE_CANCELINFO s
		left join INF_GAMES ga
		on s.game_code = ga.game_code
		where 1 = 1

		<if test="canceler != null and canceler !=''">
			and s.CANCELER_NAME = #{canceler}  
        </if>
		<if test="satrtcancelTime != null and satrtcancelTime != ''">  
           <![CDATA[and to_char(s.CANCEL_TIME,'yyyy-MM-dd') >=#{satrtcancelTime}]]>
		</if>
		<if test="endcancelTime!=null and endcancelTime!=''">
         <![CDATA[and  to_char(s.CANCEL_TIME,'yyyy-MM-dd')<=#{endcancelTime}]]>
		</if>
		<if test="areaCode!=null and areaCode!=''">
			<if test="areaCode!=0">
			and	s.CANCEL_ORG_CODE like #{ areaCode}||'%'
        	</if>
		</if>
		 order by s.cancel_time desc
		) b ) where
    <![CDATA[
      rn  >
    ${beginNum}  and rn  <= ${endNum}
    ]]>
	</select>
	<select id="getRefundflow" parameterType="Long" resultType="String">
		select f_get_sale_guicancel_seq(#{pcode}) id from dual
  </select>
	<insert id="saveRefund" parameterType="cls.pilottery.oms.lottery.form.RefundForm">
		insert into SALE_CANCELINFO
		  (GUI_CANCEL_FLOW,
		  <if test="reqtsn!=null and reqtsn!=''">
		     SALE_TSN,
		  </if>
		<if test="reqfnticket!=null and reqfnticket!=''">
		 APPLYFLOW_SELL,
		</if>
		  <if test="tsn!=null and tsn!=''">
		    CANCEL_TSN,
		  </if>
		 <if test="saleagencycode!=null ">
		   SALE_AGENCY_CODE,
		 </if>
		 <if test="rescancelagencycode!=null ">
		   CANCEL_ORG_CODE,
		 </if>
		  <if test="gamecode !=null">
		   GAME_CODE,
		  </if>
		  <if test="issuenumber!=null">
		    ISSUE_NUMBER,
		  </if>
		 <if test="cancelamount!=null">
		 	CANCEL_AMOUNT,
		 </if>
		   <if test="canceler!=null">
		   CANCELER_NAME,
		   </if>
		   <if test="datetime!=null">
		    CANCEL_TIME,
		   </if>
		  <if test="cancelCommision!=null">
		    CANCEL_COMM,
		  </if>
		 <if test="cancelerAdmin!=null">
		  CANCELER_ADMIN
		 </if>
		 <if test="htmltext!=null and htmltext!=''">
		   ,HTML_TEXT
		 </if>)
		values
		  (#{pid},
		  <if test="reqtsn!=null and reqtsn!=''">
		   #{reqtsn},
		   </if>
		   <if test="reqfnticket!=null and reqfnticket!=''">
		   #{reqfnticket},
		   </if>
		   <if test="tsn!=null and tsn!=''">
		   #{tsn},
		   </if>
		   <if test="saleagencycode!=null ">
		   #{saleagencycode},
		   </if>
		   <if test="rescancelagencycode!=null ">
		   #{rescancelagencycode},
		   </if>
		   <if test="gamecode !=null">
		   #{gamecode},
		   </if>
		   <if test="issuenumber!=null">
		   #{issuenumber},
		   </if>
		   <if test="cancelamount!=null">
		   #{cancelamount},
		   </if>
		    <if test="canceler!=null">
		   #{canceler},
		   </if>
		    <if test="canceler!=null">
		   #{datetime},
		   </if>
		   <if test="cancelCommision!=null">
		   #{cancelCommision},
		   </if>
		    <if test="cancelerAdmin!=null">
		   #{cancelerAdmin}
		   </if>
		    <if test="htmltext!=null and htmltext!=''">
		   ,
		   #{htmltext}
		   </if>
   
   )
  </insert>
	<select id="getSaleCanelinfoByid" parameterType="String"
		resultType="cls.pilottery.oms.lottery.vo.SaleCancelInfoVo">
		select s.CANCELER_NAME as canceler,
		s.cancel_time as cancelTime,
		s.gui_cancel_flow as id,
		ga.short_name as gameName,
		s.is_success as isSuccess,
		s.cancel_amount as cancelAmount,
		s.sale_tsn as saleTsn,
		s.sale_agency_code as saleAgencyCode,
		s.CANCEL_ORG_CODE as cancelAgencyCode,
		s.cancel_comm as cancelComm,
		s.cancel_tsn as cancelTsn,
		s.game_code as gameCode,
		s.GUI_CANCEL_FLOW as id,
		s.issue_number as issueNumer,
		 to_date(s.HTML_TEXT,'yyyy-mm-dd hh24:mi:ss') as saleTime,
		 to_char(s.sale_agency_code,'0000000000') as saleAgencyCodeFormat,
		to_char(s.CANCEL_ORG_CODE,'0000000000') as cancelAgencyCodeFormat
		from SALE_CANCELINFO s
		left join INF_GAMES ga
		on s.game_code = ga.game_code
		
		where 1 = 1
		and trim(s.gui_cancel_flow)=#{id} 
  </select>
   <select id="getGameName" parameterType="Long" resultType="String">
   select ga.short_name as gameName from INF_GAMES ga where ga.game_code=#{gameCode}
  </select>
    <select id="getSaleCanelinfoByTsn" parameterType="String"
		resultType="cls.pilottery.oms.lottery.vo.SaleCancelInfoVo">
	select s.CANCELER_NAME as canceler,
    s.cancel_time as cancelTime,
    s.gui_cancel_flow as id,
    ga.short_name as gameName,
    s.is_success as isSuccess,
    s.cancel_amount as cancelAmount,
    s.sale_tsn as saleTsn,
    s.sale_agency_code as saleAgencyCode,
    s.CANCEL_ORG_CODE as cancelAgencyCode,
    s.cancel_comm as cancelComm,
    s.cancel_tsn as cancelTsn,
    s.game_code as gameCode,
    s.GUI_CANCEL_FLOW as id,
    s.issue_number as issueNumer,
     to_date(s.HTML_TEXT,'yyyy-mm-dd hh24:mi:ss') as saleTime,
     to_char(s.sale_agency_code,'0000000000') as saleAgencyCodeFormat,
	to_char(s.CANCEL_ORG_CODE,'0000000000') as cancelAgencyCodeFormat
    from SALE_CANCELINFO s
    left join INF_GAMES ga
    on s.game_code = ga.game_code
    where 1 = 1
    and s.SALE_TSN=#{tsn} 
  </select>
</mapper>