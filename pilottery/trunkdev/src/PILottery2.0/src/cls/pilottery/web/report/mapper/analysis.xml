<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.report.dao.AnalysisStatisticsDao">
	<select id="getAgencyInfoList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		with agency as (
			SELECT AGENCY_CODE agencyCode,
	               AGENCY_NAME agencyName,
	               ADMIN_REALNAME marketManager,
	               AREA_NAME areaName,
	               TELEPHONE telephone,
	               CONTACT_PERSON contactPerson,
	               A.ADDRESS address,
	               to_char(AGENCY_ADD_TIME,'yyyy-mm-dd') addTime,
	               CONTRACT_NO contractNo,
	               CREDIT_LIMIT credit,
	               ORG_CODE orgCode,
	               ORG_NAME orgName,
	               A.Status status
	          FROM INF_AGENCYS A
	          left join INF_AGENCY_EXT using (AGENCY_CODE)
	          left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	          left join adm_info on (MARKET_MANAGER_ID = ADMIN_ID)
	          left join INF_AREAS using (AREA_CODE)
	          left join inf_orgs using (org_code)
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		join comm using (agencyCode)      
		where 1=1
		  <if test="beginDate != null and beginDate != ''">
				AND addTime between #{beginDate} and #{endDate}
		  </if>
		  <if test="institutionCode != null and institutionCode != ''">
				AND orgCode = #{institutionCode}
		  </if>
		  <if test="cuserOrg != '00'">
				and orgCode = #{cuserOrg}
		  </if>
		  <if test="outletCode != null and outletCode !=''">
				and agencyCode = #{outletCode}
		  </if>
		  <if test="status != null and status !=''">
				and status = #{status}
		  </if>
		  ORDER BY orgCode,agencyCode
	</select>
	
	<select id="getNoSaleOutletsList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		WITH AGENCY AS (
			SELECT AGENCY_CODE agencyCode,
	                AGENCY_NAME agencyName,
	                TELEPHONE telephone,
	                CONTACT_PERSON contactPerson,
	                a.ADDRESS address,
	                TO_CHAR (AGENCY_ADD_TIME, 'yyyy-mm-dd') addTime,
	                CONTRACT_NO contractNo,
	                CREDIT_LIMIT credit,
	                ORG_CODE orgCode,
	                ORG_NAME orgName,
	                a.Status status
	           FROM inf_agencys a
	           left join inf_orgs using (org_code)
	           left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	           left join INF_AGENCY_EXT using (AGENCY_CODE)
			 WHERE status = 1
			   AND agency_code NOT IN
		              (SELECT agency_code
		                 FROM his_agency_fund
		                WHERE flow_type = 7
		                <if test="beginDate != null and beginDate != ''">
							AND calc_date between #{beginDate} and #{endDate}
						</if>
					   )
				<if test="cuserOrg != '00'">
					AND agency_code in (select agency_code from inf_agencys where org_code = #{cuserOrg})
			  	</if>
			  	<if test="institutionCode != null and institutionCode != ''">
			  		AND agency_code in (select agency_code from inf_agencys where org_code = #{institutionCode})
	  			</if>
		   	   
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		join comm using (agencyCode) 
		ORDER BY orgCode,agencyCode
	</select>
	
	<!-- 根据系统（电脑票、即开票）查询部门销售统计 -->
	<select id="getInstFundReportByLotTypeList" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.*,org_name orgName from (
			select 0 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(sale, 0)+nvl(lot_sale, 0) as saleAmount,
			       nvl(sale_comm, 0)+nvl(lot_sale_comm, 0) as saleComm,
			       nvl(paid, 0)+nvl(lot_paid, 0) as payout,
			       nvl(pay_comm, 0)+nvl(lot_pay_comm, 0) as payoutComm,
			       nvl(rtv, 0)+nvl(lot_rtv, 0) as returnAmount,
			       nvl(rtv_comm, 0)+nvl(lot_rtv_comm, 0) as returnComm,
			       nvl(CENTER_PAY, 0)+nvl(lot_CENTER_PAY, 0) as centerPayAmount,
			       nvl(CENTER_PAY_COMM, 0)+nvl(lot_CENTER_PAY_COMM, 0) as centerPayComm,
			       nvl(LOT_CENTER_RTV,0) as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			union all      
			select 1 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(sale, 0) as saleAmount,
			       nvl(sale_comm, 0) as saleComm,
			       nvl(paid, 0) as payout,
			       nvl(pay_comm, 0) as payoutComm,
			       nvl(rtv, 0) as returnAmount,
			       nvl(rtv_comm, 0) as returnComm,
			       nvl(CENTER_PAY, 0) as centerPayAmount,
			       nvl(CENTER_PAY_COMM, 0) as centerPayComm,
			       0 as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			union all 
			select 2 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(lot_sale, 0) as saleAmount,
			       nvl(lot_sale_comm, 0) as saleComm,
			       nvl(lot_paid, 0) as payout,
			       nvl(lot_pay_comm, 0) as payoutComm,
			       nvl(lot_rtv, 0) as returnAmount,
			       nvl(lot_rtv_comm, 0) as returnComm,
			       nvl(lot_CENTER_PAY, 0) as centerPayAmount,
			       nvl(lot_CENTER_PAY_COMM, 0) as centerPayComm,
			       nvl(LOT_CENTER_RTV,0) as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			 ) tab 
			 join inf_orgs on (tab.orgCode = inf_orgs.org_code)
			 where tjType = #{tjType}
			 order by balanceDate desc,orgCode
	</select>
	
	<select id="getInstFundReportByLotTypeSum" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.* from (
			select 0 as tjType,
			       sum(nvl(sale, 0)+nvl(lot_sale, 0)) as saleAmount,
			       sum(nvl(sale_comm, 0)+nvl(lot_sale_comm, 0)) as saleComm,
			       sum(nvl(paid, 0)+nvl(lot_paid, 0)) as payout,
			       sum(nvl(pay_comm, 0)+nvl(lot_pay_comm, 0)) as payoutComm,
			       sum(nvl(rtv, 0)+nvl(lot_rtv, 0)) as returnAmount,
			       sum(nvl(rtv_comm, 0)+nvl(lot_rtv_comm, 0)) as returnComm,
			       sum(nvl(CENTER_PAY, 0)+nvl(lot_CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(CENTER_PAY_COMM, 0)+nvl(lot_CENTER_PAY_COMM, 0)) as centerPayComm,
			       sum(nvl(LOT_CENTER_RTV,0)) as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			union all
			select 1 as tjType,
			       sum(nvl(sale, 0)) as saleAmount,
			       sum(nvl(sale_comm, 0)) as saleComm,
			       sum(nvl(paid, 0)) as payout,
			       sum(nvl(pay_comm, 0)) as payoutComm,
			       sum(nvl(rtv, 0)) as returnAmount,
			       sum(nvl(rtv_comm, 0)) as returnComm,
			       sum(nvl(CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(CENTER_PAY_COMM, 0)) as centerPayComm,
			       0 as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			union all 
			select 2 as tjType,
			       sum(nvl(lot_sale, 0)) as saleAmount,
			       sum(nvl(lot_sale_comm, 0)) as saleComm,
			       sum(nvl(lot_paid, 0)) as payout,
			       sum(nvl(lot_pay_comm, 0)) as payoutComm,
			       sum(nvl(lot_rtv, 0)) as returnAmount,
			       sum(nvl(lot_rtv_comm, 0)) as returnComm,
			       sum(nvl(lot_CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(lot_CENTER_PAY_COMM, 0)) as centerPayComm,
			       sum(nvl(LOT_CENTER_RTV,0)) as cancelAmount
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="cuserOrg != '00'">
			  	   	AND ORG_CODE = #{cuserOrg}
			  	</if>
			 ) tab 
			 where tjType = #{tjType}
	</select>
	
	<select id="getAgentFundByLotType" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.*,tab.org_code orgCode,org_name orgName from (
		
			select 1 tjType,
				   CALC_DATE as balanceDate,
				   org_code,
			       nvl(CARRY_AMOUNT, 0) as saleAmount,
			       nvl(ORG_COMM_AMOUNT,0) saleComm,
			       nvl(ORG_RETURN_AMOUNT, 0) as returnAmount ,
			       nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0) as returnComm,
			       nvl(ORG_CENTER_PAY_AMOUNT, 0) as centerPayAmount,
			       nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0) as centerPayComm ,
			       nvl(ORG_AGENCY_PAY_AMOUNT, 0) as payout,
			       nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0) as payoutComm
			  from v_his_agent_fund_report
			 where CALC_DATE between #{beginDate} and #{endDate}
			 union all 
			 select 2 tjType,
				   CALC_DATE as balanceDate,
				   org_code,
			       nvl(CARRY_AMOUNT, 0) as saleAmount,
			       nvl(ORG_COMM_AMOUNT,0) saleComm,
			       nvl(ORG_RETURN_AMOUNT, 0) as returnAmount,
			       nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0) as returnComm,
			       nvl(ORG_CENTER_PAY_AMOUNT, 0) as centerPayAmount,
			       nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0) as centerPayComm ,
			       nvl(ORG_AGENCY_PAY_AMOUNT, 0) as payout,
			       nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0) as payoutComm
			  from v_his_agent_fund_report
			 where CALC_DATE between #{beginDate} and #{endDate}
		  ) tab
		  right join inf_orgs using (org_code)
		  where ORG_TYPE = 2
			<if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		</if>
	  		<if test="cuserOrg != '00'">
		  	   	AND ORG_CODE = #{cuserOrg}
		  	</if>
		  order by balanceDate desc,orgCode
	</select>
	<select id="getAgentFundByLotTypeSum" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select  
			   sum(nvl(CHARGE_AMOUNT, 0)) as topUp ,
		       sum(nvl(WITHDRAW_AMOUNT, 0)) as withdraw,
		       sum(nvl(CARRY_AMOUNT, 0)) as saleAmount,
		       sum(nvl(ORG_COMM_AMOUNT,0)) saleComm,
		       sum(nvl(ORG_RETURN_AMOUNT, 0)) as returnAmount ,
		       sum(nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0)) as returnComm,
		       sum(nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0)) as payoutComm,
		       sum(nvl(ORG_AGENCY_PAY_AMOUNT, 0)) as payout,
		       sum(nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0)) as centerPayComm ,
		       sum(nvl(ORG_CENTER_PAY_AMOUNT, 0)) as centerPayAmount
		  from v_his_agent_fund_report
		  join inf_orgs using (org_code)
		  where CALC_DATE between #{beginDate} and #{endDate} and ORG_TYPE = 2
		    <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		</if>
	  		<if test="cuserOrg != '00'">
		  	   	AND ORG_CODE = #{cuserOrg}
		  	</if>
	</select>
</mapper>