<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.pos.system.dao.OrderManageDao">
	<resultMap id="pcOrderMap" type="cls.pilottery.pos.system.model.PurchaseOrderResponse">
		<result column="orderNo" property="orderNo" />
		<result column="time" property="time" />
		<result column="status" property="status" />
		<collection property="detailList" ofType="cls.pilottery.pos.system.model.PurchaseOrderDetail">
			<result column="planCode" property="planCode" />
			<result column="planName" property="planName" />
			<result column="tickets" property="tickets" />
			<result column="amount" property="amount" />
		</collection>
	</resultMap>
	<resultMap id="posDeliveryMap" type="cls.pilottery.web.sales.entity.DeliveryOrder">
		<id column="DO_NO" property="doNo" />
		<result column="APPLY_ADMIN" property="applyAdmin" />
		<result column="APPLY_DATE" property="applyDate" />
		<result column="WH_CODE" property="whCode" />
		<result column="WH_ORG" property="org" />
		<result column="WH_ADMIN" property="managerAdmin" />
		<result column="WH_ADMIN_NAME" property="managerAdminName" />
		<result column="OUT_DATE" property="outDate" />
		<result column="STATUS" property="status" />
		<result column="TOTAL_TICKETS" property="totalTickets" />
		<result column="TOTAL_AMOUNT" property="totalAmount" />
		<result column="ADMIN_REALNAME" property="applyAdminName" />
		<result column="ORG_NAME" property="orgName" />
		<result column="REMARK" property="remark" />
		<collection property="deliveryDetail" ofType="cls.pilottery.web.sales.entity.DeliveryOrderDetail">
			<id column="DO_NO" property="doNo" />
			<id column="SEQUENCE_NO" property="sequenceNo" />
			<result column="PLAN_CODE" property="planCode" />
			<result column="PLAN_NAME" property="planName" />
			<result column="PACKAGES" property="packages" />
			<result column="TICKETS" property="tickets" />
			<result column="AMOUNT" property="amount" />
		</collection>
		<collection property="doRelation" ofType="cls.pilottery.web.sales.entity.DeliveryOrderRelation">
			<id column="DO_NO" property="doNo" />
			<id column="ORDER_NO" property="orderNo" />
		</collection>
	</resultMap>
	
	<select id="getPosDeliveryList" parameterType="map"	resultType="cls.pilottery.pos.system.model.PosDeliveryOrder">
		select deliveryOrder,time,status,tickets,amount from (      
			select t.*,rownum rnum from (         
				select  DO_NO deliveryOrder, 
				        TO_CHAR(APPLY_DATE,'MM-DD HH24:MI') time, 
				        STATUS status, 
				        TICKETS tickets, 
				        AMOUNT amount
				from SALE_DELIVERY_ORDER
				WHERE 1 = 1   
				<if test="userId != null and userId != ''">
					AND APPLY_ADMIN = #{userId}
				</if>
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and DO_NO < #{lastId} ]]>
				</if>
				order by time desc
				) t 
			<![CDATA[ ) where rnum <= #{pageCount} ]]>
	</select>
	
	<select id="getPosDeliveryDetail" parameterType="string"	resultMap="posDeliveryMap">
		with orders as (
		    SELECT DO_NO,
		           APPLY_ADMIN,
		           APPLY_DATE,
		           WH_CODE,
		           WH_ORG,
		           OUT_DATE,
		           STATUS,
		           TICKETS TOTAL_TICKETS,
		           AMOUNT TOTAL_AMOUNT,
		           B.ADMIN_REALNAME,
		           ORG_NAME,
		           WH_ADMIN,
				   D.ADMIN_REALNAME WH_ADMIN_NAME,
		           REMARK
		      FROM SALE_DELIVERY_ORDER a
		           LEFT JOIN ADM_INFO b ON (a.APPLY_ADMIN = b.ADMIN_ID)
		           LEFT JOIN INF_ORGS c ON (a.WH_ORG = c.ORG_CODE)
		           LEFT JOIN ADM_INFO d ON (a.WH_ADMIN = d.ADMIN_ID)
		     WHERE DO_NO = #{deliveryOrderNo}
		),
		details as (
		    select DO_NO, SEQUENCE_NO, x.PLAN_CODE,y.SHORT_NAME as plan_name, TICKETS, PACKAGES, AMOUNT
		    from SALE_DELIVERY_ORDER_DETAIL x,game_plans y
		    where x.plan_code = y.plan_code
		    and DO_NO = #{deliveryOrderNo}
		),
		porder as (
            select DO_NO,ORDER_NO from SALE_DELIVERY_ORDER_ALL where DO_NO = #{deliveryOrderNo}
        )
		select orders.DO_NO,APPLY_ADMIN,APPLY_DATE, WH_CODE, WH_ORG, OUT_DATE,STATUS,TOTAL_TICKETS,TOTAL_AMOUNT,ADMIN_REALNAME,ORG_NAME,REMARK,WH_ADMIN,WH_ADMIN_NAME,
		details.*,porder.order_no
		from orders,details,porder
		where orders.do_no = details.do_no
		and orders.do_no = porder.do_no(+)
	</select>
	
	<select id="getMktFundFlow" parameterType="map"	resultType="cls.pilottery.pos.system.model.MktFundFlowDetail">
		select TRADE_TIME time, FLOW_TYPE type,CHANGE_AMOUNT amount,ACC_NO accNo from 
		(
			select ROWNUM rnum,t.* from (
				select to_char(TRADE_TIME,'MM-DD HH24:MI') TRADE_TIME, FLOW_TYPE,CHANGE_AMOUNT,A.ACC_NO
				from ACC_MM_ACCOUNT a ,FLOW_MARKET_MANAGER b 
				where a.acc_NO = B.ACC_NO
					and a.market_admin = #{userId}
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and REF_NO < #{lastId} ]]>
				</if> 
				order by trade_time desc
			) t
		<![CDATA[ ) where rnum <= #{pageCount} ]]>
	</select>
	
	<select id="getMktFundBalance" parameterType="int"	resultType="cls.pilottery.pos.system.model.MktFundFlowResponse">
		select CREDIT_LIMIT credit,ACCOUNT_BALANCE balance from ACC_MM_ACCOUNT where MARKET_ADMIN = #{userId}
	</select>
	
	<select id="getInventoryList" parameterType="long"	resultType="cls.pilottery.pos.system.model.MktInventoryDetail">
		SELECT plan_code planCode,
		       SHORT_NAME planName,
		       TICKETS tickets,
		       AMOUNT amount
		  FROM ACC_MM_TICKETS LEFT JOIN GAME_PLANS USING (plan_code)
		 WHERE MARKET_ADMIN = #{userId}
	</select>
	
	<select id="getPosPurchaseOrderList" parameterType="map" resultMap="pcOrderMap">
		with detail as (
			SELECT order_no,
				   a.PLAN_CODE planCode,
			       SHORT_NAME planName,
			       TICKETS tickets,
			       AMOUNT amount
			  FROM SALE_ORDER_APPLY_DETAIL a, GAME_PLANS b
			 WHERE a.plan_code = b.plan_code 
		),
		pcorder as (
		select * from (      
			select t.*,rownum rnum from (         
				select  ORDER_NO orderNo, 
				        APPLY_DATE, 
				        STATUS status
				from SALE_ORDER 
				where 1 = 1  
				<if test="userId != null and userId != ''">
					AND (APPLY_ADMIN = #{userId} or APPLY_AGENCY in (select AGENCY_CODE from INF_AGENCYS where MARKET_MANAGER_ID = #{userId}))
				</if>
				<if test="status != null and status != ''">
					AND status = #{status}
				</if>
				<if test="outletCode != null and outletCode != ''">
					and APPLY_AGENCY = #{outletCode}
				</if>
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and ORDER_NO < #{lastId} ]]>
				</if>
				) t 
			<![CDATA[ ) where rnum <= #{pageCount} ]]>
		)
		select pcorder.orderNo,TO_CHAR(pcorder.APPLY_DATE,'MM-DD HH24:MI') time,pcorder.status,detail.planCode,detail.planName,detail.tickets,detail.amount
		from pcorder,detail 
		where pcorder.orderNO = detail.order_no
		order by pcorder.APPLY_DATE desc
	</select>
	
	<select id="getMMInventoryDaliyList" parameterType="map" resultType="cls.pilottery.pos.system.model.mm.MMInventoryDaliy020501Res">
		WITH base
		     AS (SELECT CALC_DATE,
		                PLAN_CODE,
		                CLOSE_INV,
		                GOT_TICKETS,
		                SALED_TICKETS,
		                CANCELED_TICKETS,
		                RETURN_TICKETS,
		                BROKEN_TICKETS
		           FROM HIS_MM_INVENTORY
		          WHERE MARKET_ADMIN = #{userId}
		          <if test="follow != null and follow != ''">
					  <![CDATA[ AND CALC_DATE <= #{follow} ]]>
				  </if>
		          ),
		     rtl
		     AS (SELECT *
		           FROM base UNPIVOT (tickets
		                     FOR inv_type
		                     IN  (GOT_TICKETS AS '1',
		                         SALED_TICKETS AS '2',
		                         CANCELED_TICKETS AS '3',
		                         RETURN_TICKETS AS '4',
		                         BROKEN_TICKETS AS '5',
		                         CLOSE_INV AS '9')))
		  select calc_date calcDate,inv_type type, short_name plan, tickets from (                        
			  select rownum,t.* from (                         
			      SELECT calc_date,inv_type, short_name, tickets
			        FROM rtl
			        join GAME_PLANS using (plan_code)
			    ORDER BY calc_date desc,inv_type, plan_code
			<![CDATA[  ) t where rownum < #{count}  ]]>
		 )
	</select>
	
	<select id="getMMCapitalDaliyList" parameterType="map" resultType="cls.pilottery.pos.system.model.mm.MMCapitalDaliy020508Res">
		with days as (
		    <![CDATA[select d_day calc_date from HIS_DIM_DWM where to_date(d_day,'yyyy-mm-dd') < sysdate-1 ]]>
		    <if test="follow != null and follow != ''">
			  	<![CDATA[ AND CALC_DATE <= #{follow} ]]>
		  	</if>
		),
		sales as (
		    select CALC_DATE,AMOUNT from days join HIS_MM_FUND using(calc_date) WHERE MARKET_ADMIN = #{userId} AND FLOW_TYPE = 9
		),
		withdraw as (
		    select CALC_DATE,AMOUNT from days join HIS_MM_FUND using(calc_date) WHERE MARKET_ADMIN = #{userId} AND FLOW_TYPE = 14
		),
		repay as (
		    select CALC_DATE,AMOUNT from days join HIS_MM_FUND using(calc_date) WHERE MARKET_ADMIN = #{userId} AND FLOW_TYPE = 10
		),
		balance as (
		    select CALC_DATE,AF_ACCOUNT_BALANCE AMOUNT from days join HIS_MM_FUND using(calc_date) WHERE MARKET_ADMIN = #{userId} AND FLOW_TYPE = 0
		)
		select calc_date calcDate,flow_type dealtype,amount from (
			select rownum,t.* from ( 
				select calc_date,'1' flow_type,nvl(amount,0) amount from days left join sales using(calc_date)
				union
				select calc_date,'2' flow_type,nvl(amount,0) amount from days left join withdraw using(calc_date)
				union
				select calc_date,'3' flow_type,nvl(amount,0) amount from days left join repay using(calc_date)
				union
				select calc_date,'4' flow_type,nvl(amount,0) amount from days left join balance using(calc_date)
				order by calc_date desc,flow_type
			) t
		<![CDATA[  ) t where rownum< #{count} ]]>
	</select>
	
	<select id="getMMTransRecordSummary" parameterType="map" resultType="cls.pilottery.pos.system.model.mm.MMDealRecordSmry020502Res">
		select deal_time time,deal_type dealtype,agency_code outletCode,AMOUNT amount,flow_no dealNo from (
		    select rownum,t.* from 
		        (select *
		          from (select SALE_TIME deal_time,
		                       agency_code,
		                       1 as deal_type,
		                       sum(SALE_AMOUNT) AMOUNT,
		                       SGR_NO flow_no
		                  from flow_sale
		                 WHERE 1=1
			            <if test="follow != null and follow != ''">
						  	<![CDATA[ AND SALE_TIME < #{follow} ]]>
					  	</if>
		                 group by SALE_TIME,agency_code,SGR_NO
		                union all
		                select CANCEL_TIME,
		                       agency_code,
		                       3 as deal_type,
		                       sum(SALE_AMOUNT) SALE_AMOUNT,
		                       SGI_NO
		                  from FLOW_CANCEL
		                 WHERE 1=1
			            <if test="follow != null and follow != ''">
						  	<![CDATA[ AND SALE_TIME < #{follow} ]]>
					  	</if>
		                 group by CANCEL_TIME,agency_code,SGI_NO
		                union all
		                select pay_time, PAY_AGENCY, 2 as deal_type, SUCC_AMOUNT, DJXQ_NO
		                  from SALE_PAID
		                 WHERE 1=1
			            <if test="follow != null and follow != ''">
						  	<![CDATA[ AND pay_time < #{follow} ]]>
					  	</if>
		                  )
                  WHERE agency_code IN (SELECT AGENCY_CODE FROM inf_agencys WHERE MARKET_MANAGER_ID = #{userId})   
                        order by deal_time desc
		     <![CDATA[  ) t where rownum< #{count} ]]>             
		)
	</select>
	
	<select id="getMMSaleDetailFund" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.MMSalesDetail020503Res">
		select CREATE_DATE time,agency_code outletCode,sum(SALE_AMOUNT) saleAmount,sum(COMM_AMOUNT) saleComm
		from WH_GOODS_RECEIPT 
		join FLOW_SALE using (sgr_no)
		where sgr_no = #{_parameter}    
		group by CREATE_DATE,agency_code
	</select>
	<select id="getMMSaleDetailPlanList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.PlanList020503Res">
		select SHORT_NAME plan,sum(tickets) tickets,sum(amount) amount
		 from WH_GOODS_RECEIPT_DETAIL 
		 join GAME_PLANS using (plan_code)
		 where sgr_no = #{_parameter}
		group by SHORT_NAME
		order by SHORT_NAME
	</select>
	<select id="getMMSaleDetailRecordList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.TagList020503Res">
		select plan_code||'-'||batch_no||'-'||unitCode tagNo,amount from (
		    select plan_code,batch_no,decode(VALID_NUMBER,1,trunk_no,2,box_no,package_no) unitCode,amount 
		    from WH_GOODS_RECEIPT_DETAIL where sgr_no = #{_parameter}
		    order by SEQUENCE_NO
		)
	</select>
	
	<select id="getMMPayoutDetailFund" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.MMPayoutDetail020504Res">
		select a.PAY_AGENCY outletCode,
			a.PAY_TIME time,
			a.SUCC_TICKETS winTickets,
			a.SUCC_AMOUNT winAmount,
			a.PLAN_TICKETS scanTickets,
			nvl(sum(COMM_AMOUNT),0) payoutComm
		from SALE_PAID a
		join SALE_PAID_DETAIL  using (DJXQ_NO)
		left join FLOW_PAY using (PAY_FLOW)
		WHERE DJXQ_NO = #{_parameter}
		group by a.PAY_AGENCY,a.PAY_TIME,a.SUCC_TICKETS,a.SUCC_AMOUNT,a.PLAN_TICKETS
	</select>
	<select id="getMMPayoutDetailPlanList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.PrizeLevelList020504Res">
		select PAY_AMOUNT levelAmount,sum(PAY_AMOUNT) amount,count(1) tickets from SALE_PAID_DETAIL 
		join FLOW_PAY using (PAY_FLOW)
		where DJXQ_NO = #{_parameter}
		group by PAY_AMOUNT
		order by PAY_AMOUNT desc
	</select>
	<select id="getMMPayoutDetailRecordList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.TagList020504Res">
		select PLAN_CODE||'-'|| BATCH_NO||'-'||PACKAGE_NO||'-'||TICKET_NO tagNo,PAID_STATUS payStatus,REWARD_AMOUNT amount, decode(IS_OLD_TICKET,1,'old','') ticketFlag
		from SALE_PAID_DETAIL 
		where DJXQ_NO = #{_parameter}
	</select>
	
	<select id="getMMReturnDetailFund" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.MMReturnDetail020505Res">
		select AGENCY_CODE outletCode,CANCEL_TIME time,sum(sale_amount) returnAmount,sum(comm_amount) returnComm
		from flow_cancel where sgi_no = #{_parameter} 
		group by AGENCY_CODE,CANCEL_TIME
	</select>
	<select id="getMMReturnDetailPlanList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.PlanList020505Res">
		select SHORT_NAME plan,sum(tickets) tickets,sum(amount) amount
         from WH_GOODS_ISSUE_DETAIL 
         join GAME_PLANS using (plan_code)
         where sgi_no = #{_parameter} 
        group by SHORT_NAME
        order by SHORT_NAME
	</select>
	<select id="getMMReturnDetailRecordList" parameterType="string"	resultType="cls.pilottery.pos.system.model.mm.TagList020505Res">
		select plan_code||'-'||batch_no||'-'||unitCode tagNo,amount from (
		    select plan_code,batch_no,decode(VALID_NUMBER,1,trunk_no,2,box_no,package_no) unitCode,amount 
		    from WH_GOODS_ISSUE_DETAIL where sgi_no = #{_parameter}
		    order by SEQUENCE_NO
		)
	</select>

</mapper>
