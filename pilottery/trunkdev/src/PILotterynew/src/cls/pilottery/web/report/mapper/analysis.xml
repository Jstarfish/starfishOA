<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.report.dao.AnalysisStatisticsDao">
	<select id="getAgencyInfoList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		with agency as (
			SELECT AGENCY_CODE agencyCode,
	               AGENCY_NAME agencyName,
	               ADMIN_REALNAME marketManager,
	               AREA_NAME areaName,
	               TELEPHONE telephone,
	               CONTACT_PERSON contactPerson,
	               A.ADDRESS address,
	               to_char(AGENCY_ADD_TIME,'yyyy-mm-dd') addTime,
	               CONTRACT_NO contractNo,
	               CREDIT_LIMIT credit,
	               ORG_CODE orgCode,
	               ORG_NAME orgName,
	               A.Status status
	          FROM INF_AGENCYS A
	          left join INF_AGENCY_EXT using (AGENCY_CODE)
	          left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	          left join adm_info on (MARKET_MANAGER_ID = ADMIN_ID)
	          left join INF_AREAS using (AREA_CODE)
	          left join inf_orgs using (org_code)
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		join comm using (agencyCode)      
		where 1=1
		  <if test="beginDate != null and beginDate != ''">
				AND addTime between #{beginDate} and #{endDate}
		  </if>
		  <if test="institutionCode != null and institutionCode != ''">
				AND orgCode = #{institutionCode}
		  </if>
		  <if test="cuserOrg != '00'">
				and orgCode = #{cuserOrg}
		  </if>
		  <if test="outletCode != null and outletCode !=''">
				and agencyCode = #{outletCode}
		  </if>
		  <if test="status != null and status !=''">
				and status = #{status}
		  </if>
		  ORDER BY orgCode,agencyCode
	</select>
	
	
	<select id="getNoSaleOutletsList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		WITH AGENCY AS (
			SELECT AGENCY_CODE agencyCode,
	                AGENCY_NAME agencyName,
	                TELEPHONE telephone,
	                CONTACT_PERSON contactPerson,
	                a.ADDRESS address,
	                TO_CHAR (AGENCY_ADD_TIME, 'yyyy-mm-dd') addTime,
	                CONTRACT_NO contractNo,
	                CREDIT_LIMIT credit,
	                ORG_CODE orgCode,
	                ORG_NAME orgName,
	                a.Status status
	           FROM inf_agencys a
	           left join inf_orgs using (org_code)
	           left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	           left join INF_AGENCY_EXT using (AGENCY_CODE)
			 WHERE status = 1
			   AND agency_code NOT IN
		              (SELECT agency_code
		                 FROM his_agency_fund
		                WHERE flow_type = 7
		                <if test="beginDate != null and beginDate != ''">
							AND calc_date between #{beginDate} and #{endDate}
						</if>
					   )
				<if test="cuserOrg != '00'">
					AND agency_code in (select agency_code from inf_agencys where org_code = #{cuserOrg})
			  	</if>
			  	<if test="institutionCode != null and institutionCode != ''">
			  		AND agency_code in (select agency_code from inf_agencys where org_code = #{institutionCode})
	  			</if>
		   	   
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		join comm using (agencyCode) 
		ORDER BY orgCode,agencyCode
	</select>
</mapper>