<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cls.pilottery.web.capital.dao.TopUpsDao">
	<resultMap id="TopUpsMap"
		type="cls.pilottery.web.capital.model.paymodel.TopUps">
		<id column="FUND_NO" property="fundNo" jdbcType="CHAR" />
		<result column="ACCOUNT_TYPE" property="accountType" jdbcType="DECIMAL" />
		<result column="AO_CODE" property="aoCode" jdbcType="VARCHAR" />
		<result column="AO_NAME" property="aoName" jdbcType="VARCHAR" />
		<result column="ACC_NO" property="accNo" jdbcType="CHAR" />
		<result column="OPER_AMOUNT" property="operAmount" jdbcType="DECIMAL" />
		<result column="BE_ACCOUNT_BALANCE" property="beforeBalance" jdbcType="DECIMAL" />
		<result column="AF_ACCOUNT_BALANCE" property="afterBalance" jdbcType="DECIMAL" />
		<result column="OPER_TIME" property="operTime" jdbcType="TIMESTAMP" />
		<result column="OPER_ADMIN" property="operAdmin" jdbcType="DECIMAL" />
		<result column="ADMIN_REALNAME" property="realName" jdbcType="VARCHAR" />
	</resultMap>

	<select id="getTopUpsList" parameterType="cls.pilottery.web.capital.form.TopUpsForm"
		resultMap="TopUpsMap">
		select * from (
		select tab.*,rownum rn from (
		select a.fund_no,
		a.ao_code,
		a.ao_name,
		a.oper_admin,
		a.oper_amount,
		g.af_account_balance,
		a.oper_time,
		b.admin_realname
		from fund_charge_center a 
		left join adm_info b
		on (a.oper_admin = b.admin_id and a.account_type = 1)
		left join flow_org g
		on (a.fund_no = g.ref_no and g.flow_type = 1)
		where 1 = 1
		<!-- <if test="aoCode != null and aoCode != ''">
			AND a.ao_code = #{aoCode}
		</if> -->
		<if test="operTime != null and operTime != ''">
			AND to_char(a.oper_time,'yyyy-mm-dd') = #{operTime}
		</if>
		 <if test="aoCode != '00'">
			and a.AO_CODE=#{aoCode}
		</if> 
			and a.ACCOUNT_TYPE =1
			ORDER BY oper_time DESC
		<![CDATA[ ) TAB ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<!-- 分页记录总数 -->
	<select id="getTopUpsCount" parameterType="cls.pilottery.web.capital.form.TopUpsForm"
		resultType="Integer">
		SELECT count(1)
		FROM (select a.fund_no,
		a.ao_code,
		a.ao_name,
		a.oper_admin,
		a.oper_amount,
		g.af_account_balance,
		a.oper_time,
		b.admin_realname
		from fund_charge_center a 
		left join adm_info b
		on (a.oper_admin = b.admin_id and a.account_type = 1)
		left join flow_org g
		on (a.fund_no = g.ref_no and g.flow_type = 1)
		where 1 = 1
		<if test="operTime != null and operTime != ''">
			AND to_char(oper_time,'yyyy-mm-dd') = #{operTime}
		</if>
		<if test="aoCode != '00'">
			and AO_CODE=#{aoCode}
		</if>
		AND ACCOUNT_TYPE=1
		)
	</select>

	<select id="getTopUpsInfo" parameterType="String"
		resultType="cls.pilottery.web.capital.model.paymodel.TopUps">
		select
		a.ao_code,
		a.ao_name,
		a.oper_amount,
		a.be_account_balance,
		a.af_account_balance,
		a.oper_admin,
		a.oper_time
		from fund_charge_center a
		where 1 = 1 and a.ao_code = #{aoCode}
	</select>

	<!-- 根据部门名称查询此部门的部门编码 -->
	<select id="getOrgInfoByOrgCode" parameterType="String"
		resultType="cls.pilottery.web.institutions.model.InfOrgs">
		select a.ORG_NAME as orgName,
		a.ORG_CODE as orgCode
		from INF_ORGS a
		where 1 = 1 and a.ORG_CODE=#{orgCode,jdbcType=VARCHAR}
	</select>

	<!-- 根据部门名称查询此部门的部门编码 是从账户表里边查出的余额 -->
	<select id="getOrgBalanceByOrgCode" parameterType="String"
		resultType="cls.pilottery.web.capital.model.InstitutionAccount">
		select a.ORG_CODE as orgCode,
		<!-- nvl2(a.account_balance, a.account_balance, 0) as beforeBalance, -->
		a.account_balance as accountBalance,
		b.org_name as orgName
		from ACC_ORG_ACCOUNT a
		left join INF_ORGS b
		on a.org_code = b.org_code
		where 1 = 1 and a.ORG_CODE=#{orgCode,jdbcType=VARCHAR}
	</select>

	<!-- 部门充值 -->
	<update id="insititutionTopUps" statementType="CALLABLE"
		parameterType="cls.pilottery.web.capital.form.TopUpsForm">
		{call p_institutions_topup(
		#{orgCode,mode=IN,jdbcType=VARCHAR},
		#{operAmount,mode=IN,jdbcType=NUMERIC},
		#{operAdmin,mode=IN,jdbcType=NUMERIC},
		#{fundNo,mode=OUT,jdbcType=VARCHAR},
		#{beforeBalance,mode=OUT,jdbcType=NUMERIC},
		#{afterBalance,mode=OUT,jdbcType=NUMERIC},
		#{c_errcode,mode=OUT,jdbcType=NUMERIC},
		#{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		)
		}
	</update>

	<!-- 查询缴款凭证所需信息 -->
	<select id="getTopUpsByPk" parameterType="java.lang.String"
		resultMap="TopUpsMap">
		select a.ao_code,
	        a.ao_name,
	        a.oper_amount,
	        a.be_account_balance,
	       <!--  a.af_account_balance, -->
	        a.oper_time,
	        a.oper_admin,
	        b.admin_realname,
	        g.af_account_balance  
	   from fund_charge_center a
	   left join adm_info b
	     on (a.oper_admin = b.admin_id and a.account_type = 1)
	    left join flow_org g
	     on (a.fund_no = g.ref_no and g.flow_type = 1)
	  where a.fund_no = #{param1}
	</select>
</mapper>