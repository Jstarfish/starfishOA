<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cls.pilottery.web.items.dao.ItemCheckDao">

	<resultMap type="cls.pilottery.web.items.model.ItemCheck" id="itemCheckMap">
		<id column="CHECK_NO" property="checkNo"/>
		<result column="CHECK_NAME" property="checkName"/>
		<result column="CHECK_DATE" property="checkDate"/>
		<result column="CHECK_ADMIN" property="checkAdmin"/>
		<result column="ADMIN_REALNAME" property="checkAdminName"/><!-- Foreign Table -->
		<result column="CHECK_WAREHOUSE" property="checkWarehouse"/>
		<result column="WAREHOUSE_NAME" property="checkWarehouseName"/><!-- Foreign Table -->
		<result column="STATUS" property="status"/>
	</resultMap>
	
	<resultMap type="cls.pilottery.web.items.model.ItemQuantity" id="itemQuantityMap">
    	<id column="ITEM_CODE" property="itemCode"/>
    	<result column="WAREHOUSE_CODE" property="warehouseCode"/>
    	<result column="ITEM_NAME" property="itemName"/>
    	<result column="WAREHOUSE_NAME" property="warehouseName"/><!-- Foreign Table -->
    	<result column="QUANTITY" property="quantity"/>
    </resultMap>
    
    <resultMap type="cls.pilottery.web.items.model.ItemCheckDetail" id="itemCheckDetailMap">
    	<id column="CHECK_NO" property="checkNo"/>
    	<result column="ITEM_CODE" property="itemCode"/>
    	<result column="ITEM_NAME" property="itemName"/><!-- Foreign Table -->
    	<result column="BEFORE_QUANTITY" property="beforeQuantity"/>
    	<result column="CHECK_QUANTITY" property="checkQuantity"/><!-- Foreign Table -->
    </resultMap>

	<!-- 获得物品盘点记录总数 -->
	<select id="getItemCheckCount" parameterType="cls.pilottery.web.items.form.ItemCheckQueryForm" resultType="Integer">
		SELECT COUNT(1)
		  FROM ITEM_CHECK C
		    LEFT JOIN WH_INFO W ON W.WAREHOUSE_CODE = C.CHECK_WAREHOUSE
		 WHERE 1 = 1
		 <if test="checkCode != null and checkCode != ''">
		   AND C.CHECK_NO = #{checkCode}
		 </if>
		 <if test="checkName != null and checkName != ''">
		   AND C.CHECK_NAME = #{checkName}
		 </if>
		 <if test="checkDate != null and checkDate != ''">
		   AND TO_CHAR(C.CHECK_DATE, 'yyyy-mm-dd') = #{checkDate}
		 </if>
		 <if test="warehouseCode != null and warehouseCode != ''">
		   AND C.CHECK_WAREHOUSE = #{warehouseCode}
		 </if>
		 <if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
           AND W.ORG_CODE = #{sessionOrgCode}
         </if>
	</select>
	
	<!-- 获得物品盘点记录列表 -->
	<select id="getItemCheckList" parameterType="cls.pilottery.web.items.form.ItemCheckQueryForm" resultMap="itemCheckMap">
		SELECT * FROM (
			SELECT R.*, ROWNUM AS RN FROM (
				SELECT C.CHECK_NO,
				       C.CHECK_NAME,
				       TO_CHAR(C.CHECK_DATE,'yyyy-mm-dd hh24:mm:ss') AS CHECK_DATE,
				       C.CHECK_ADMIN,
				       U.ADMIN_REALNAME,
				       C.CHECK_WAREHOUSE,
				       W.WAREHOUSE_NAME,
				       C.STATUS
				  FROM ITEM_CHECK C
				    LEFT JOIN ADM_INFO U ON U.ADMIN_ID = C.CHECK_ADMIN
				    LEFT JOIN WH_INFO W ON W.WAREHOUSE_CODE = C.CHECK_WAREHOUSE
				 WHERE 1 = 1
				 <if test="checkCode != null and checkCode != ''">
				   AND C.CHECK_NO = #{checkCode}
				 </if>
				 <if test="checkName != null and checkName != ''">
				   AND C.CHECK_NAME = #{checkName}
				 </if>
				 <if test="checkDate != null and checkDate != ''">
		           AND TO_CHAR(C.CHECK_DATE, 'yyyy-mm-dd') = #{checkDate}
		         </if>
		         <if test="warehouseCode != null and warehouseCode != ''">
		   		   AND C.CHECK_WAREHOUSE = #{warehouseCode}
		 	     </if>
		 		 <if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        		   AND W.ORG_CODE = #{sessionOrgCode}
         		 </if>
		         ORDER BY C.CHECK_NO DESC, C.CHECK_NAME ASC
   <![CDATA[) R
   		) WHERE RN > ${beginNum} AND RN <= ${endNum} ]]>
	</select>
	
	<!-- 获得选择仓库下所有的在库物品（用于添加盘点记录） -->
	<!-- 包括quantity为0的物品，如果一物品已被删除，则它在item_quantity表中不存在 -->
	<select id="getAvailableItemForCheck" parameterType="String" resultMap="itemQuantityMap">
		SELECT Q.ITEM_CODE,
		       Q.ITEM_NAME,
		       Q.QUANTITY
		  FROM ITEM_QUANTITY Q
		 WHERE Q.WAREHOUSE_CODE = #{warehouseCode}
	</select>
	
	<!-- 新增盘点记录 -->
	<update id="addItemCheck" statementType="CALLABLE" parameterType="cls.pilottery.web.items.form.NewItemCheckForm">
		{CALL P_ITEM_CHECK_STEP1(
			#{checkAdmin,mode=IN,jdbcType=NUMERIC},
			#{checkName,mode=IN,jdbcType=VARCHAR},
			#{warehouseCode,mode=IN,jdbcType=VARCHAR},
			#{checkItemSet,mode=IN,jdbcType=VARCHAR},
			#{checkCode,mode=OUT,jdbcType=VARCHAR},
			#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    		#{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		)}
	</update>
	
	<!-- 获得盘点物品记录明细（盘点前及盘点后） -->
	<select id="getItemCheckListDetails" parameterType="String" resultMap="itemCheckDetailMap">
		SELECT BE.CHECK_NO,
		       BE.ITEM_CODE,
		       I.ITEM_NAME,
		       BE.QUANTITY AS BEFORE_QUANTITY,
		       AF.QUANTITY AS CHECK_QUANTITY
		  FROM ITEM_CHECK_DETAIL_BE BE
		    LEFT JOIN ITEM_CHECK_DETAIL_AF AF ON (BE.CHECK_NO = AF.CHECK_NO AND BE.ITEM_CODE = AF.ITEM_CODE)
		    LEFT JOIN ITEM_ITEMS I ON (I.ITEM_CODE = BE.ITEM_CODE)
		 WHERE BE.CHECK_NO = #{checkNo}
	</select>
	
	<!-- 获得盘点备注 -->
	<select id="getRemarkByCheckNo" parameterType="String" resultType="String">
		SELECT REMARK
		  FROM ITEM_CHECK
		 WHERE CHECK_NO = #{checkNo}
	</select>
	
	<!-- 修改物品盘点单状态 -->
	<update id="updateStatusCompleteCheck" parameterType="String">
		UPDATE ITEM_CHECK
		   SET STATUS = 2
		 WHERE CHECK_NO = #{checkNo}
	</update>
	
	<!-- 删除物品盘点记录 -->
	<delete id="deleteItemCheck" parameterType="String">
		DELETE FROM ITEM_CHECK
		 WHERE CHECK_NO = #{checkNo}
	</delete>
	
	<!-- 删除物品盘点前明细记录 -->
	<delete id="deleteItemCheckDetailBefore" parameterType="String">
		DELETE FROM ITEM_CHECK_DETAIL_BE
		 WHERE CHECK_NO = #{checkNo}
	</delete>
	
	<!-- 删除物品盘点后明细记录 -->
	<delete id="deleteItemCheckDetailAfter" parameterType="String">
		DELETE FROM ITEM_CHECK_DETAIL_AF
		 WHERE CHECK_NO = #{checkNo}
	</delete>

</mapper>