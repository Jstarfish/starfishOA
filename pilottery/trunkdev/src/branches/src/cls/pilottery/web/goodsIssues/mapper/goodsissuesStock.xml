<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.goodsIssues.dao.GoodsIssuesDao">


<select id="getOrgslList"  resultType="cls.pilottery.web.institutions.model.InfOrgs">
select orgs.org_code as orgCode,
 orgs.org_name as orgName
  from INF_ORGS orgs
 where 1 = 1
   and orgs.ORG_STATUS = 1

</select>
<select id="getGoodsIssuesStockInfoByCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesStockVo">
select bi.stb_no  as stbNo,
       a.org_name as deliveringUnit,
       b.org_name as receivingUnit

  from WH_GOODS_ISSUE gi, SALE_TRANSFER_BILL bi, INF_ORGS a, INF_ORGS b
 where gi.ref_no = bi.stb_no
   and a.org_code = bi.send_org
   and bi.RECEIVE_ORG = b.org_code
   and gi.sgi_no=#{sgiNo}
</select>
<select id="getGoodsIssuesStockDetilListByCode"  parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesStockDetailVo">
     select gp.plan_code as planCode,
       gp.full_name as planName,
       de.tickets   as tickets,
       de.amount    as amount

  from WH_GOODS_ISSUE       gi,
       SALE_TRANSFER_BILL   bi,
       game_plans           gp,
       SALE_TB_APPLY_DETAIL de
 where gi.ref_no = bi.stb_no
   and de.plan_code = gp.plan_code
   and bi.stb_no = de.stb_no
      
   and gi.sgi_no =#{sgiNo}
</select>
<select id="getGoodsIssuesDetilListByCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">
select distinct de.valid_number as validNumber,
                de.batch_no     as batchNo,
                de.trunk_no     as trunkNo,
                de.box_no       as boxNo,
                de.package_no   as packageNo,
                de.tickets      as tickets,
                de.amount       as amount,
                gd.REWARD_GROUP as rewardNo,
                de.plan_code    as planCode,
                gp.full_name    as planName
  from 
       WH_GOODS_ISSUE_DETAIL de left join
       Wh_Ticket_Package       gd on (de.trunk_no=gd.trunk_no or de.box_no=gd.box_no or de.package_no=gd.package_no)
      left join game_plans            gp on gp.plan_code=de.plan_code
 where 
 1=1 and gd.plan_code=de.plan_code and gd.batch_no=de.batch_no
 and
    de.sgi_no=#{sgiNo}
</select>
<select id="getGoodsIssuesDetilListByCodeSum" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">
select de.valid_number as validNumber,
       
       de.plan_code as planCode,
        gp.full_name as planName,
       nvl(sum(de.tickets), 0) as tickets,
       nvl(sum(de.amount), 0) as amount
  from WH_GOODS_ISSUE_DETAIL de
  left join game_plans gp
    on gp.plan_code = de.plan_code
 where 1 = 1
   and  de.sgi_no=#{sgiNo}
  group by de.plan_code, de.valid_number,gp.full_name


</select>
<select id="getGoodsIssuesByCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesVo">
select 
       gi.issue_tickets as tickets,
       gi.act_issue_tickets as actTickets,
       gi.remark as remark

  from WH_GOODS_ISSUE  gi

 where 1=1
   and gi.sgi_no =#{sgiNo}
</select>
<select id="getGoodsIssuesStockPirnt" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesVo">
select g.ISSUE_END_TIME as sendDate,
a.admin_realname as sendManger
  from WH_GOODS_ISSUE g left join adm_info a on a.admin_id=g.CREATE_ADMIN
 where 1 = 1
   and g.ref_no=#{refNo}

</select>
<select id="getGoodsIssuesStockDetailPirnt" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesStockDetailVo">
select de.plan_code    as planCode,
       g.full_name     as planName,
       sum(de.tickets)      as tickets,
       sum(de.amount)       as amount,
       de.BATCH_NO      as batchNo,
       g.ticket_amount as tickAmount
  from WH_GOODS_ISSUE_DETAIL de, game_plans g
 where g.plan_code = de.plan_code
   and de.ref_no=#{refNo}
group by de.plan_code,g.full_name,de.batch_no,g.ticket_amount
</select>
<select id="getGoodsIssuesStockSumPirnt" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssuesStockDetailVo">
select nvl(sum(de.tickets),0)      as tickets,
       nvl(sum(de.amount),0)       as amount
       
  from WH_GOODS_ISSUE_DETAIL de where 1=1
   and de.ref_no=#{refNo}

</select>
<select id="getIssuseTransGameBystbNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo">
select g.plan_code            as planCode,
       g.full_name            as planName,
       gb.batch_no            as batchNo,
       g.ticket_amount        as amount,
       de.TICKETS_EVERY_GROUP as ticketsEveryGroup from (select *
  from game_plans p
 where p.plan_code in (select d.plan_code
                         from sale_tb_apply_detail d
                        where d.stb_no =#{stbNo})) g,GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
                        where 1 = 1
   and g.plan_code = gb.plan_code
   and g.plan_code = de.plan_code
      
   and de.status = 1

</select>
<select id="getSaleDeliverOrderGameBystbNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo">
select g.plan_code            as planCode,
       g.full_name            as planName,
       gb.batch_no            as batchNo,
       g.ticket_amount        as amount,
       de.TICKETS_EVERY_GROUP as ticketsEveryGroup from (select *
  from game_plans p
 where p.plan_code in (select d.plan_code
                         from SALE_DELIVERY_ORDER_DETAIL d
                        where d.do_no=#{doNo})) g,GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
                        where 1 = 1
   and g.plan_code = gb.plan_code
   and g.plan_code = de.plan_code
      
   and de.status = 1

</select>
<select id="getSaleActTicktsByCode" parameterType="String" resultType="Long">
select b.act_tickets  from SALE_TRANSFER_BILL b where b.stb_no=#{stbNo}
</select>
<select id="getSaletbTicksInfoByCode" parameterType="cls.pilottery.web.goodsIssues.model.GoodIssuesParamt" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">

select d.stb_no,
       d.plan_code as planCode,
       p.full_name as planName,
       d.tickets  as actTickts,
       nvl(r.trunk, 0) as  trunk,
       nvl(r.box, 0) as box,
       nvl(r.pkg, 0)  as pkg,
       nvl(r.tickets, 0) as tickets
  from sale_tb_apply_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(case valid_number when 1 then 1 else 0 end) as trunk,
                    sum(case valid_number when 2 then 1 else 0 end) as box,
                    sum(case valid_number when 3 then 1 else 0 end) as pkg,
                    sum(tickets) as tickets
               from wh_goods_issue_detail where  ref_no =#{stbNo}
              group by ref_no, plan_code) r
    on (d.stb_no = r.ref_no and d.plan_code = r.plan_code)

 

 where d.stb_no =#{stbNo}

 



</select>
<select id="getGoodsIssuseOutTicksInfoByCode" parameterType="cls.pilottery.web.goodsIssues.model.GoodIssuesParamt" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">

select d.do_no,
       d.plan_code as planCode,
       p.full_name as planName ,
       d.tickets as actTickts,
       nvl(r.trunk, 0)  as trunk,
       nvl(r.box, 0) as box,
       nvl(r.pkg, 0) as pkg,
       nvl(r.tickets, 0) as tickets
  from sale_delivery_order_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(case valid_number when 1 then 1 else 0 end) as trunk,
                    sum(case valid_number when 2 then 1 else 0 end) as box,
                    sum(case valid_number when 3 then 1 else 0 end) as pkg,
                    sum(tickets) as tickets
               from wh_goods_issue_detail where  ref_no =#{doNo} 
              group by ref_no, plan_code) r
    on (d.do_no = r.ref_no and d.plan_code = r.plan_code)

 where d.do_no = #{doNo}


</select>
<select id="getSaleActTicktsDiffByCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">
select d.stb_no,
       d.plan_code as planCode,
       p.full_name as planName,
       d.tickets as receivableTickets,
       nvl(r.tickets, 0) as receivabedTickets,
       d.tickets -nvl(r.tickets, 0) as diff
  from sale_tb_apply_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(tickets) as tickets
               from wh_goods_issue_detail
          
              group by ref_no, plan_code) r
    on (d.stb_no = r.ref_no and d.plan_code = r.plan_code)

 where d.stb_no = #{stbNo}

</select>
<select id="getGoodsIssuseOutTicksInfoDiffByCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">
select d.do_no,
       d.plan_code as planCode,
       p.full_name as planName,
       d.tickets as receivableTickets,
       nvl(r.tickets, 0) as receivabedTickets,
       d.tickets- nvl(r.tickets, 0) as diff
  from sale_delivery_order_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(tickets) as tickets
               from wh_goods_issue_detail
               --where ref_no = ''
              group by ref_no, plan_code) r
    on (d.do_no = r.ref_no and d.plan_code = r.plan_code)

 where d.do_no =#{doNo}

</select>
</mapper>
