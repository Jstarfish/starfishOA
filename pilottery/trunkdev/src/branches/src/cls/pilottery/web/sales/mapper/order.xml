<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.sales.dao.OrderDao">
	<resultMap id="orderMap" type="cls.pilottery.web.sales.entity.PurchaseOrder">
		<id column="ORDER_NO" property="orderNo" jdbcType="CHAR" />
		<result column="APPLY_ADMIN" property="applyAdmin" />
		<result column="APPLY_DATE" property="applyDate" />
		<result column="APPLY_AGENCY" property="applyAgency" />
		<result column="SENDER_ADMIN" property="senderAdmin" />
		<result column="SEND_WAREHOUSE" property="sendWarehouse" />
		<result column="SEND_DATE" property="sendDate" />
		<result column="CARRIER_ADMIN" property="carrierAdmin" />
		<result column="CARRY_DATE" property="carryDate" />
		<result column="STATUS" property="status" />
		<result column="IS_INSTANT_ORDER" property="isInstantOrder" />
		<result column="APPLY_TICKETS" property="applyTickets" />
		<result column="APPLY_AMOUNT" property="applyAmount" />
		<result column="GOODS_TICKETS" property="goodsTickets" />
		<result column="GOODS_AMOUNT" property="goodsAmount" />
		<result column="APPLY_NAME" property="applyName"/>
		<result column="APPLY_CONTACT" property="applyContact"/>
		<result column="REMARK" property="remark"/>
		<collection property="orderDetail"	ofType="cls.pilottery.web.sales.entity.PurchaseOrderDetail">
			<id column="ORDER_NO" property="orderNo"/>
			<id column="SEQUENCE_NO" property="sequenceNo" />
			<result column="PLAN_CODE" property="planCode" />
			<result column="PLAN_NAME" property="planName" />
			<result column="PACKAGES" property="packages" />
			<result column="TICKETS" property="tickets" />
			<result column="AMOUNT" property="amount" />
			<result column="REMARK" property="remark" />
		</collection>
	</resultMap>

	<select id="getOrderList" parameterType="cls.pilottery.web.sales.form.OrderForm"
		resultMap="orderMap">
		select * from (
		select tab.*,rownum rn from (
		SELECT ORDER_NO, APPLY_ADMIN, APPLY_DATE, APPLY_AGENCY, SENDER_ADMIN,
			SEND_WAREHOUSE, SEND_DATE, CARRIER_ADMIN, CARRY_DATE, STATUS,
			IS_INSTANT_ORDER, APPLY_TICKETS, APPLY_AMOUNT, GOODS_TICKETS,
			GOODS_AMOUNT,
			b.ADMIN_REALNAME APPLY_NAME
			FROM SALE_ORDER a
			LEFT JOIN ADM_INFO b ON (a.APPLY_ADMIN = b.ADMIN_ID)
		WHERE a.APPLY_ADMIN = #{currentUserId}
		<if test="purchaseOrderNo != null and purchaseOrderNo != ''">
			AND a.ORDER_NO = #{purchaseOrderNo}
		</if>
		<if test="applyDate != null and applyDate != ''">
			AND to_char(a.APPLY_DATE,'yyyy-mm-dd') = #{applyDate}
		</if>
		<![CDATA[ ) TAB ) where rn > ${beginNum} and rn <= ${endNum} 
		ORDER BY APPLY_DATE DESC
		]]>
	</select>

	<select id="getOrderCount" parameterType="cls.pilottery.web.sales.form.OrderForm"
		resultType="Integer">
		SELECT count(1)
		FROM SALE_ORDER
		WHERE APPLY_ADMIN = #{currentUserId}
		<if test="purchaseOrderNo != null and purchaseOrderNo != ''">
			AND ORDER_NO = #{purchaseOrderNo}
	    </if>
		<if test="applyDate != null and applyDate != ''">
			AND to_char(APPLY_DATE,'yyyy-mm-dd') = #{applyDate}
	    </if>
	</select>
	
	<select id="getOrderListForInquery" parameterType="cls.pilottery.web.sales.form.OrderForm"
		resultMap="orderMap">
		select * from (
		select tab.*,rownum rn from (
		SELECT ORDER_NO, APPLY_ADMIN, APPLY_DATE, APPLY_AGENCY, SENDER_ADMIN,
			SEND_WAREHOUSE, SEND_DATE, CARRIER_ADMIN, CARRY_DATE, STATUS,
			IS_INSTANT_ORDER, APPLY_TICKETS, APPLY_AMOUNT, GOODS_TICKETS,
			GOODS_AMOUNT,
			b.ADMIN_REALNAME APPLY_NAME
			FROM SALE_ORDER a
			LEFT JOIN ADM_INFO b ON (a.APPLY_ADMIN = b.ADMIN_ID)
		WHERE A.STATUS != 2
		<if test="purchaseOrderNo != null and purchaseOrderNo != ''">
			AND a.ORDER_NO = #{purchaseOrderNo}
		</if>
		<if test="cuserOrg != '00'">
			and (a.APPLY_ADMIN in (select admin_id from adm_info where ADMIN_ORG in (select org_code from INF_ORGS where ORG_CODE = #{cuserOrg}))
				)
		</if>
		<if test="applyDate != null and applyDate != ''">
			AND to_char(a.APPLY_DATE,'yyyy-mm-dd') = #{applyDate}
		</if>
		ORDER BY APPLY_DATE DESC
		<![CDATA[ ) TAB ) where rn > ${beginNum} and rn <= ${endNum} 
		ORDER BY APPLY_DATE DESC
		]]>
	</select>

	<select id="getOrderCountForInquery" parameterType="cls.pilottery.web.sales.form.OrderForm"	resultType="Integer">
		SELECT count(1)
		FROM SALE_ORDER
		WHERE STATUS != 2
		<if test="purchaseOrderNo != null and purchaseOrderNo != ''">
			AND ORDER_NO = #{purchaseOrderNo}
	    </if>
	    <if test="cuserOrg != '00'">
			and (APPLY_ADMIN in (select admin_id from adm_info where ADMIN_ORG in (select org_code from INF_ORGS where ORG_CODE = #{cuserOrg}))
				)
		</if>
		<if test="applyDate != null and applyDate != ''">
			AND to_char(APPLY_DATE,'yyyy-mm-dd') = #{applyDate}
	    </if>
	</select>
	
	<update id="modifyOrderStatus" parameterType="java.util.Map">
		update SALE_ORDER set status = #{status}
		where ORDER_NO = #{purchaseOrderNo}
	</update>
	
	<select id="getPlanList" resultType="cls.pilottery.web.sales.model.PlanModel">
		SELECT a.PLAN_CODE planCode,
		       FULL_NAME planName,
		       TICKET_AMOUNT ticketAmount,
		       TICKETS_EVERY_PACK packTickets
		  FROM GAME_PLANS a, GAME_BATCH_IMPORT_DETAIL b
		 WHERE a.PLAN_CODE = b.PLAN_CODE AND b.status = 1
		 GROUP BY a.PLAN_CODE,FULL_NAME,TICKET_AMOUNT,TICKETS_EVERY_PACK
	</select>
    
    <select id="getPlanListByOrg" resultType="cls.pilottery.web.sales.model.PlanModel" parameterType="String">
        SELECT A.PLAN_CODE
        PLANCODE, A.full_name PLANNAME
        FROM
        game_plans A
        <if test="_parameter != '00'"> LEFT JOIN GAME_ORG_COMM_RATE B
            ON A.PLAN_CODE =
            B.PLAN_CODE
        </if>
        WHERE 1 = 1 
        <if test="_parameter != '00'"> AND B.ORG_CODE = #{_parameter}
        </if>ORDER
        BY PLANCODE 
    </select>
	
	<select id="getOrderSeq" resultType="String">
		select F_GET_SALE_ORDER_SEQ from dual
	</select>
	
	<insert id="savePurchaseOrder" parameterType="cls.pilottery.web.sales.entity.PurchaseOrder">
		INSERT INTO SALE_ORDER (
			ORDER_NO,
            APPLY_ADMIN,
            APPLY_DATE,
            APPLY_AGENCY,
            STATUS,
            IS_INSTANT_ORDER,
            APPLY_TICKETS,
            APPLY_AMOUNT,
            APPLY_CONTACT,
            REMARK)
     VALUES (#{orderNo},
             #{applyAdmin},
             sysdate,
             #{applyAgency},
             1,
             0,
             #{applyTickets},
             #{applyAmount},
             #{applyContact},
             #{remark}
             )
	</insert>
	
	<insert id="saveOrderDetail" parameterType="cls.pilottery.web.sales.entity.PurchaseOrderDetail">
		INSERT INTO SALE_ORDER_APPLY_DETAIL(ORDER_NO, SEQUENCE_NO, PLAN_CODE, PACKAGES, TICKETS, AMOUNT)
		VALUES (#{orderNo},F_GET_DETAIL_SEQUENCE_NO_SEQ,#{planCode},#{packages},#{tickets},#{amount})
	</insert>
	
	<select id="getPurchaseDetail" parameterType="String" resultMap="orderMap">
		select a.*,b.SEQUENCE_NO, b.PLAN_CODE,(select FULL_NAME from game_plans where plan_code = b.plan_code) PLAN_NAME, 
			b.PACKAGES,b.TICKETS, 
			b.AMOUNT
		from sale_order a,SALE_ORDER_APPLY_DETAIL b
		where a.order_no = b.order_no(+)
		and a.order_no = #{purchaseOrderNo}
	</select>
	
	<delete id="deleteOrderDetails" parameterType="String">
		DELETE FROM SALE_ORDER_APPLY_DETAIL
		WHERE ORDER_NO = #{orderSeq}
	</delete>
	
	<update id="updatePurchaseOrder" parameterType="cls.pilottery.web.sales.entity.PurchaseOrder">
		UPDATE SALE_ORDER 
		SET APPLY_DATE = sysdate,
			APPLY_AGENCY = #{applyAgency},
			STATUS = 1,
			IS_INSTANT_ORDER = 0,
			APPLY_TICKETS = #{applyTickets},
			APPLY_AMOUNT = #{applyAmount},
			APPLY_CONTACT = #{applyContact},
			REMARK = #{remark}
		WHERE ORDER_NO = #{orderNo}
	</update>
	
	<select id="getOrderListByUser" parameterType="map" resultMap="orderMap">
		with orders as (        
		    select * from  sale_order where  status = 1 and APPLY_ADMIN = #{userId}
		    <if test="deliveryOrderNo != null and deliveryOrderNo != ''">
			    union
			    select * from  sale_order 
			    where  ORDER_NO in (select ORDER_NO from SALE_DELIVERY_ORDER_ALL where do_no = #{deliveryOrderNo})
		    </if>
		)
		select * from orders
		left join SALE_ORDER_APPLY_DETAIL details using (ORDER_NO)
		order by apply_date desc
	</select>
	
	<select id="getOrderPlanList" resultType="cls.pilottery.web.sales.model.PlanModel" parameterType="map">
        with order_plan as (        
		    select plan_code planCode,sum(PACKAGES) packages,sum(TICKETS) tickets,sum(AMOUNT) amount from (
		        select PLAN_CODE,0 PACKAGES,0 TICKETS,0 AMOUNT from  SALE_ORDER_APPLY_DETAIL 
		        left join sale_order using (ORDER_NO) 
		        where status = 1 and APPLY_ADMIN = #{userId}    
		        <if test="deliveryOrderNo != null and deliveryOrderNo != ''">
			        union 
			        select PLAN_CODE, PACKAGES, TICKETS, AMOUNT from  SALE_ORDER_APPLY_DETAIL 
			        where  ORDER_NO in (select ORDER_NO from SALE_DELIVERY_ORDER_ALL where do_no = #{deliveryOrderNo})
		        </if>
		    )
		    group by plan_code
		),
		plan_info as (
		    SELECT a.PLAN_CODE planCode,
		           FULL_NAME planName,
		           TICKET_AMOUNT ticketAmount,
		           TICKETS_EVERY_PACK packTickets,
		            TICKET_AMOUNT * TICKETS_EVERY_PACK packAmount
		      FROM GAME_PLANS a, GAME_BATCH_IMPORT_DETAIL b
		     WHERE a.PLAN_CODE = b.PLAN_CODE AND b.status = 1
		     GROUP BY a.PLAN_CODE,FULL_NAME,TICKET_AMOUNT,TICKETS_EVERY_PACK  
		)
		SELECT * FROM order_plan
		LEFT JOIN plan_info USING (planCode)
	</select>
	
	<select id="getOutletCountByUser" parameterType="map" resultType="int">
		select count(1) from INF_AGENCYS where MARKET_MANAGER_ID = #{userId} and AGENCY_CODE = #{outletCode}
	</select>
</mapper>
