#include "global.h"

// crc16 look-up table
unsigned short c_crcAutodin[] = { 0x0000, 0xcc01, 0xd801, 0x1400, 0xf001,
    0x3c00, 0x2800, 0xe401, 0xa001, 0x6c00, 0x7800, 0xb401, 0x5000, 0x9c01,
    0x8801, 0x4400, 0xcc01, 0x0000, 0x1400, 0xd801, 0x3c00, 0xf001, 0xe401,
    0x2800, 0x6c00, 0xa001, 0xb401, 0x7800, 0x9c01, 0x5000, 0x4400, 0x8801,
    0xd801, 0x1400, 0x0000, 0xcc01, 0x2800, 0xe401, 0xf001, 0x3c00, 0x7800,
    0xb401, 0xa001, 0x6c00, 0x8801, 0x4400, 0x5000, 0x9c01, 0x1400, 0xd801,
    0xcc01, 0x0000, 0xe401, 0x2800, 0x3c00, 0xf001, 0xb401, 0x7800, 0x6c00,
    0xa001, 0x4400, 0x8801, 0x9c01, 0x5000, 0xf001, 0x3c00, 0x2800, 0xe401,
    0x0000, 0xcc01, 0xd801, 0x1400, 0x5000, 0x9c01, 0x8801, 0x4400, 0xa001,
    0x6c00, 0x7800, 0xb401, 0x3c00, 0xf001, 0xe401, 0x2800, 0xcc01, 0x0000,
    0x1400, 0xd801, 0x9c01, 0x5000, 0x4400, 0x8801, 0x6c00, 0xa001, 0xb401,
    0x7800, 0x2800, 0xe401, 0xf001, 0x3c00, 0xd801, 0x1400, 0x0000, 0xcc01,
    0x8801, 0x4400, 0x5000, 0x9c01, 0x7800, 0xb401, 0xa001, 0x6c00, 0xe401,
    0x2800, 0x3c00, 0xf001, 0x1400, 0xd801, 0xcc01, 0x0000, 0x4400, 0x8801,
    0x9c01, 0x5000, 0xb401, 0x7800, 0x6c00, 0xa001, 0xa001, 0x6c00, 0x7800,
    0xb401, 0x5000, 0x9c01, 0x8801, 0x4400, 0x0000, 0xcc01, 0xd801, 0x1400,
    0xf001, 0x3c00, 0x2800, 0xe401, 0x6c00, 0xa001, 0xb401, 0x7800, 0x9c01,
    0x5000, 0x4400, 0x8801, 0xcc01, 0x0000, 0x1400, 0xd801, 0x3c00, 0xf001,
    0xe401, 0x2800, 0x7800, 0xb401, 0xa001, 0x6c00, 0x8801, 0x4400, 0x5000,
    0x9c01, 0xd801, 0x1400, 0x0000, 0xcc01, 0x2800, 0xe401, 0xf001, 0x3c00,
    0xb401, 0x7800, 0x6c00, 0xa001, 0x4400, 0x8801, 0x9c01, 0x5000, 0x1400,
    0xd801, 0xcc01, 0x0000, 0xe401, 0x2800, 0x3c00, 0xf001, 0x5000, 0x9c01,
    0x8801, 0x4400, 0xa001, 0x6c00, 0x7800, 0xb401, 0xf001, 0x3c00, 0x2800,
    0xe401, 0x0000, 0xcc01, 0xd801, 0x1400, 0x9c01, 0x5000, 0x4400, 0x8801,
    0x6c00, 0xa001, 0xb401, 0x7800, 0x3c00, 0xf001, 0xe401, 0x2800, 0xcc01,
    0x0000, 0x1400, 0xd801, 0x8801, 0x4400, 0x5000, 0x9c01, 0x7800, 0xb401,
    0xa001, 0x6c00, 0x2800, 0xe401, 0xf001, 0x3c00, 0xd801, 0x1400, 0x0000,
    0xcc01, 0x4400, 0x8801, 0x9c01, 0x5000, 0xb401, 0x7800, 0x6c00, 0xa001,
    0xe401, 0x2800, 0x3c00, 0xf001, 0x1400, 0xd801, 0xcc01, 0x0000 };

// actual computation of crc value
void crc_calculate(unsigned short* crc, unsigned char* buffer, int length)
{
    unsigned short index = 0;
    unsigned short crcIndex = 0;
    unsigned short tableEntry = 0;

    for (index = 0x0; index < length; index++) {
        tableEntry = c_crcAutodin[(crcIndex & 0xF) | ((buffer[index] & 0xF) << 0x4)];
        crcIndex   = crcIndex >> 0x4 ^ tableEntry;
        tableEntry = c_crcAutodin[(crcIndex & 0xF) | (buffer[index] & 0xF0)];
        crcIndex   = crcIndex >> 0x4 ^ tableEntry;
    }
    *crc = crcIndex;
}

// return the calculated crc value of 'buf'
unsigned short calc_crc(void * buf, int len)
{
    unsigned short crc = 0;
    crc_calculate(&crc, (unsigned char *) buf, len);
    return crc;
}
