<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="cls.taishan.cncp.cmi.dao.IssueNotifyDao">
  	<select id="getMaxPresaleIssue" parameterType="Integer" resultType="cls.taishan.common.model.IssueInfo">
	  	select game_code gameCode,
		       issue_number issueNumber,
		       issue_seq issueSeq,
		       issue_status issueStatus
		  from cncp_game_issues
		 where game_code = #{_parameter}
		   and issue_number = (select max(issue_number) from cncp_game_issues where game_code = #{_parameter})
  	</select>
  	<select id="getMaxSaleIssue" resultType="cls.taishan.common.model.IssueInfo">
	  	select game_code gameCode,
		       issue_number issueNumber,
		       issue_seq issueSeq,
		       issue_status issueStatus
		  from cncp_game_issues
		 where game_code = #{_parameter}
		   and issue_number = (select max(issue_number) from cncp_game_issues where game_code = #{_parameter} and issue_status > 0)
  	</select>
  	
  	<select id="getMaxPreSaleIssueList" resultType="cls.taishan.common.model.IssueInfo">
	  	with base as
		 (select game_code, max(issue_seq) issue_seq
		    from cncp_game_issues
		   group by game_code)
		select game_code    gameCode,
		       issue_number issueNumber,
		       issue_seq    issueSeq,
		       issue_status issueStatus
		  from cncp_game_issues
		  join base
		 using (game_code, issue_seq)
  	</select>
  	<select id="getMaxSaleIssueList" parameterType="Integer" resultType="cls.taishan.common.model.IssueInfo">
		   with base as
		 (select game_code, min(issue_seq) issue_seq
		    from cncp_game_issues
		   where issue_status in (1,2,3,4)
		   group by game_code)
		select game_code    gameCode,
		       issue_number issueNumber,
		       issue_seq    issueSeq,
		       issue_status issueStatus,
		       to_char(START_SALE_TIME,'yyyymmddhh24miss') startTime,
		       to_char(END_SALE_TIME,'yyyymmddhh24miss') endTime
		  from cncp_game_issues
		  join base
		 using (game_code, issue_seq)
  	</select>
  	
  	<select id="isExsitIssueInfo" parameterType="cls.taishan.common.model.IssueInfo" resultType="int">
	  	select count(1)
		  from cncp_game_issues
		 where game_code = #{gameCode}
		   and issue_number = #{issueNumber}
  	</select>
  	
  	<update id="updateIssueInfo" parameterType="cls.taishan.common.model.IssueInfo">
  		update cncp_game_issues 
  		   set ISSUE_STATUS = #{issueStatus}
  		      ,START_SALE_TIME = to_date(#{startTime},'yyyymmddhh24miss')
  		      ,END_SALE_TIME = to_date(#{endTime},'yyyymmddhh24miss')
  		      <if test="drawNumber != null and drawNumber != ''">
  		      	,DRAW_CODE = #{drawNumber}
  		      </if>
  		 where issue_number = #{issueNumber}
  		   and game_code = #{gameCode}  
  	</update>
  	
  	<insert id="saveIssueInfo" parameterType="cls.taishan.common.model.IssueInfo">
  		insert into cncp_game_issues(GAME_CODE,ISSUE_NUMBER,ISSUE_SEQ,ISSUE_STATUS,START_SALE_TIME,END_SALE_TIME
  		<if test="drawNumber != null and drawNumber != ''">
			,DRAW_CODE
  		</if>
  		)
  		values (#{gameCode},#{issueNumber},#{issueSeq},#{issueStatus},to_date(#{startTime},'yyyymmddhh24miss'),to_date(#{endTime},'yyyymmddhh24miss')
  		<if test="drawNumber != null and drawNumber != ''">
  			,#{drawNumber}
  		</if>
  		)
  	</insert>
  	
  	<update id="processIssueReward" statementType="CALLABLE" parameterType="cls.taishan.cncp.cmi.entity.IssueReward">
  		 {call p_cncp_paid(
              #{gameCode,mode=IN,jdbcType=NUMERIC},
              #{issueNumber,mode=IN,jdbcType=NUMERIC},
              #{agencyCode,mode=IN,jdbcType=VARCHAR},
              #{errorCode,mode=OUT,jdbcType=NUMERIC},
              #{errorMsg,mode=OUT,jdbcType=VARCHAR}
              )
          }
  	</update>
  	
  </mapper>