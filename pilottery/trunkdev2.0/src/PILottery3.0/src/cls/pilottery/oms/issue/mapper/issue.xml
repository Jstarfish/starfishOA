<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.issue.dao.IssueManagementDao">
	<resultMap type="cls.pilottery.oms.issue.model.GameIssue" id="gameIssue">
		<id column="GAME_CODE" property="gameCode" />
		<id column="ISSUE_NUMBER" property="issueNumber" />
		<result column="ISSUE_SEQ" property="issueSeq" />
		<result column="ISSUE_STATUS" property="issueStatus" />
		<result column="IS_PUBLISH" property="isPublish" />
		<result column="DRAW_STATE" property="drawStatus" />
		<result column="PLAN_START_TIME" property="planStartTime" />
		<result column="PLAN_CLOSE_TIME" property="planCloseTime" />
		<result column="PLAN_REWARD_TIME" property="planRewardTime" />
		<result column="REAL_START_TIME" property="realStartTime" />
		<result column="REAL_CLOSE_TIME" property="realCloseTime" />
		<result column="REAL_REWARD_TIME" property="realRewardTime" />
		<result column="ISSUE_END_TIME" property="issueEndTime" />
		<result column="CODE_INPUT_METHOLD" property="codeInputMethold" />
		<result column="FIRST_DRAW_USER_ID" property="firstDrawUserId" />
		<result column="FIRST_DRAW_NUMBER" property="firstDrawNumber" />
		<result column="SECOND_DRAW_USER_ID" property="secondDrawUserId" />
		<result column="SECOND_DRAW_NUMBER" property="secondDrawNumber" />
		<result column="FINAL_DRAW_NUMBER" property="finalDrawNumber" />
		<result column="FINAL_DRAW_USER_ID" property="finalDrawUserId" />
		<result column="PAY_END_DAY" property="payEndDay" />
		<result column="POOL_START_AMOUNT" property="poolStartAmount" />
		<result column="POOL_CLOSE_AMOUNT" property="poolCloseAmount" />
		<result column="ISSUE_SALE_AMOUNT" property="issueSaleAmount" />
		<result column="ISSUE_SALE_TICKETS" property="issueSaleTickets" />
		<result column="ISSUE_SALE_BETS" property="issueSaleBets" />
		<result column="ISSUE_CANCEL_AMOUNT" property="issueCancelAmount" />
		<result column="ISSUE_CANCEL_TICKETS" property="issueCancelTickets" />
		<result column="ISSUE_CANCEL_BETS" property="issueCancelBets" />
		<result column="WINNING_AMOUNT" property="winningAmount" />
		<result column="WINNING_BETS" property="winningBets" />
		<result column="WINNING_TICKETS" property="winningTickets" />
		<result column="WINNING_AMOUNT_BIG" property="winningAmountBig" />
		<result column="WINNING_TICKETS_BIG" property="winningTicketsBig" />
		<result column="ISSUE_RICK_AMOUNT" property="issueRickAmount" />
		<result column="ISSUE_RICK_TICKETS" property="issueRickTickets" />
		<result column="WINNING_RESULT" property="winningResult" />
		<result column="REWARDING_ERROR_CODE" property="rewardingErrorCode" />
		<result column="REWARDING_ERROR_MESG" property="rewardingErrorMesg" />
		<result column="CALC_WINNING_CODE" property="calcWinningCode" />
		<result column="firstDrawUserName" property="firstDrawUserName" />
		<result column="secondDrawUserName" property="secondDrawUserName" />
	</resultMap>
	<resultMap type="cls.pilottery.oms.issue.model.GameIssuePrizeDetail" id="gameIssuePrizeDetail">
		<id column="GAME_CODE" property="gameCode" />
		<id column="ISSUE_NUMBER" property="issueNumber" />
		<result column="agency_code" property="agencyCode" />
		<result column="agency_name" property="agencyName" />
		<result column="area_code" property="areaCode" />
		<result column="area_name" property="areaName" />
		<result column="prize_level" property="prizeLevel" />
		<result column="prize_name" property="prizeName" />
		<result column="is_hd_prize" property="isHdPrize" />
		<result column="winning_count" property="winningCount" />
		<result column="single_bet_reward" property="singleBetReward" />
	</resultMap>
	<resultMap type="cls.pilottery.oms.issue.model.GameParameterControlView" id="gameParameterControlView">
		<result column="GAME_CODE" property="gameCode" />
		<result column="LIMIT_BIG_PRIZE" property="limitBigPrize" />
		<result column="LIMIT_PAYMENT" property="limitPayment" />
		<result column="LIMIT_PAYMENT2" property="limitPayment2"/>
		<result column="LIMIT_CANCEL2" property="limitCancel2"/>
		<result column="CANCEL_SEC" property="cancelSec" />
		<result column="SALER_PAY_LIMIT" property="salerPayLimit" />
		<result column="SALER_CANCEL_LIMIT" property="salerCancelLimit" />
		<result column="ISSUE_CLOSE_ALERT_TIME" property="issueCloseAlertTime" />
	</resultMap>

	<select id="getGameInfo" resultType="cls.pilottery.oms.issue.model.GameInfo">
		SELECT GAME_CODE gameCode,
		GAME_MARK gameMark,
		BASIC_TYPE basicType,
		FULL_NAME fullName,
		SHORT_NAME shortName,
		ISSUING_ORGANIZATION issuingOrganization
		FROM inf_games
    </select>
    
    <select id="getgameIssueByPK" parameterType="long" resultMap="gameIssue">  
        SELECT GAME_CODE,
		       ISSUE_NUMBER,
		       ISSUE_SEQ,
		       ISSUE_STATUS,
		       IS_PUBLISH,
		       DRAW_STATE,
		       PLAN_START_TIME,
		       PLAN_CLOSE_TIME,
		       PLAN_REWARD_TIME,
		       REAL_START_TIME,
		       REAL_CLOSE_TIME,
		       REAL_REWARD_TIME,
		       ISSUE_END_TIME,
		       CODE_INPUT_METHOLD,
		       FIRST_DRAW_USER_ID,
		       FIRST_DRAW_NUMBER,
		       SECOND_DRAW_USER_ID,
		       SECOND_DRAW_NUMBER,
		       FINAL_DRAW_NUMBER,
		       FINAL_DRAW_USER_ID,
		       PAY_END_DAY,
		       POOL_START_AMOUNT,
		       POOL_CLOSE_AMOUNT,
		       ISSUE_SALE_AMOUNT,
		       ISSUE_SALE_TICKETS,
		       ISSUE_SALE_BETS,
		       ISSUE_CANCEL_AMOUNT,
		       ISSUE_CANCEL_TICKETS,
		       ISSUE_CANCEL_BETS,
		       WINNING_AMOUNT,
		       WINNING_BETS,
		       WINNING_TICKETS,
		       WINNING_AMOUNT_BIG,
		       WINNING_TICKETS_BIG,
		       ISSUE_RICK_AMOUNT,
		       ISSUE_RICK_TICKETS,
		       WINNING_RESULT,
		       REWARDING_ERROR_CODE,
		       REWARDING_ERROR_MESG,
		       CALC_WINNING_CODE,
		       b.admin_realname firstDrawUserName,
		       c.admin_realname secondDrawUserName
		  FROM iss_game_issue a
		  left join adm_info b on a.FIRST_DRAW_USER_ID = b.admin_id
		  left join adm_info c on a.SECOND_DRAW_USER_ID = c.admin_id
		 where GAME_CODE=#{param1} and ISSUE_NUMBER=#{param2}
    </select> 

	<select id="getGameIssueListCountSingle" parameterType="cls.pilottery.oms.issue.form.IssueManagementForm"
		resultType="Integer">
		select count(1) from iss_game_issue d where d.GAME_CODE= #{gameCode}
		<if test="isPublish != null and isPublish != ''">
			and d.IS_PUBLISH=#{isPublish}
		</if>
		<if test="issueNumber != null and issueNumber != ''">
			and d.ISSUE_NUMBER=#{issueNumber}
		</if>
		<if test="openDate != null and openDate != ''">
			and to_char(d.plan_start_time,'yyyy-MM-dd')=#{openDate}
		</if>
		<if test="issueStatus == 1">
			and d.ISSUE_STATUS=0
		</if>
		<if test="issueStatus == 2">
			and d.ISSUE_STATUS=1
		</if>
		<if test="issueStatus == 3">
			and d.ISSUE_STATUS in (2,3)
		</if>
		<if test="issueStatus == 4">
			and d.ISSUE_STATUS=4
		</if>
		<if test="issueStatus == 5">
			and d.ISSUE_STATUS=5
		</if>
		<if test="issueStatus == 6">
			and d.ISSUE_STATUS in (6,7,8,9,10,11,12)
		</if>
		<if test="issueStatus == 7">
			and d.ISSUE_STATUS=13
		</if>
	</select>
	<select id="getGameIssueListSingle" parameterType="cls.pilottery.oms.issue.form.IssueManagementForm"
		resultMap="gameIssue">
		select * from (
		select a.*,rownum rn from (
		select * from iss_game_issue
		d where d.GAME_CODE=#{gameCode}
		<if test="isPublish != null and isPublish != ''">
			and d.IS_PUBLISH=#{isPublish}
		</if>
		<if test="issueNumber != null and issueNumber != ''">
			and d.ISSUE_NUMBER=#{issueNumber}
		</if>
		<if test="openDate != null and openDate != ''">
			and to_char(d.plan_start_time,'yyyy-MM-dd')=#{openDate}
		</if>
		<if test="issueStatus == 1">
			and d.ISSUE_STATUS=0
		</if>
		<if test="issueStatus == 2">
			and d.ISSUE_STATUS=1
		</if>
		<if test="issueStatus == 3">
			and d.ISSUE_STATUS in (2,3)
		</if>
		<if test="issueStatus == 4">
			and d.ISSUE_STATUS=4
		</if>
		<if test="issueStatus == 5">
			and d.ISSUE_STATUS=5
		</if>
		<if test="issueStatus == 6">
			and d.ISSUE_STATUS in (6,7,8,9,10,11,12)
		</if>
		<if test="issueStatus == 7">
			and d.ISSUE_STATUS=13
		</if>
	<![CDATA[ order by d.ISSUE_NUMBER desc) a ) where rn > #{beginNum} and rn <= #{endNum} ]]>
	</select>
	
	 <select id="getGameIssuePrizeDetail" parameterType="long" resultMap="gameIssuePrizeDetail">  
        select * from v_game_issue_prize_detail t where t.GAME_CODE=#{param1}
    		 and t.issue_number = #{param2}
    		 and t.is_hd_prize = 1
    		 order by t.agency_code
    </select> 

 	<delete id="deleteIssue" statementType="CALLABLE" parameterType="cls.pilottery.oms.issue.model.GameIssue">  
        {
        	call p_om_issue_delete(
			 	#{gameCode,mode=IN,jdbcType=NUMERIC},
			 	#{issueNumber,mode=IN,jdbcType=NUMERIC},
			 	#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	   		#{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		 	)	
		}	
    </delete>  
    
    <select id="getGameIssuePrizeRule" parameterType="short" resultType="cls.pilottery.oms.issue.model.GameIssuePrizeRule">  
        select  GAME_CODE gameCode, 
		        ISSUE_NUMBER issueNumber, 
		        PRIZE_LEVEL prizeLevel, 
		        PRIZE_NAME prizeName,  
		        LEVEL_PRIZE levelPrize
         from iss_game_prize_rule t where t.GAME_CODE=#{param1}
    		 and t.issue_number = #{param2}
	 		order by t.disp_order asc
    </select> 
    
    <update id="updateGameIssuePrizeRule" parameterType="cls.pilottery.oms.issue.model.GameIssuePrizeRule">  
        update iss_game_prize_rule r set 
	        r.LEVEL_PRIZE=#{levelPrize}
        	where r.GAME_CODE=#{gameCode}
        	and r.ISSUE_NUMBER=#{issueNumber}
        	and r.PRIZE_LEVEL=#{prizeLevel}
    </update>
    
    <update id="updateCalcWinningCode" parameterType="cls.pilottery.oms.game.model.GameIssue">  
        update iss_game_issue r set 
        	r.CALC_WINNING_CODE=#{calcWinningCode}
        	where r.GAME_CODE=#{gameCode} 
        	and r.ISSUE_NUMBER=#{issueNumber}
    </update>

     <select id="getMaxPublishIssueNumber" parameterType="cls.pilottery.oms.issue.form.IssueManagementForm" resultType="long">  
        select max(ISSUE_NUMBER) from (select * from (select ISSUE_NUMBER from iss_game_issue 
            where GAME_CODE=#{gameCode} and IS_PUBLISH=0
	    <![CDATA[ order by ISSUE_NUMBER) where rownum <= ${publishNumbers}) ]]>
    </select>
    
    <select id="getMinPublishIssueNumber" parameterType="cls.pilottery.oms.issue.form.IssueManagementForm" resultType="long">  
        select min(ISSUE_NUMBER) from (select * from (select ISSUE_NUMBER from iss_game_issue 
            where GAME_CODE=#{gameCode} and IS_PUBLISH=0
	    <![CDATA[ order by ISSUE_NUMBER) where rownum <= ${publishNumbers}) ]]>
    </select>
    
    <select id="getUnPublishCount" parameterType="short" resultType="Integer">
		select count(1) from iss_game_issue d where d.GAME_CODE=#{gameCode} and IS_PUBLISH=0
	</select>
	
	<update id="updateIssuePublish" parameterType="cls.pilottery.oms.issue.form.IssueManagementForm">  
	    update iss_game_issue r set r.IS_PUBLISH=1
	          where r.GAME_CODE=#{gameCode} and r.ISSUE_NUMBER in (
			      select * from (select ISSUE_NUMBER from iss_game_issue 
			          where GAME_CODE=#{gameCode} and IS_PUBLISH=0
	    <![CDATA[ order by ISSUE_NUMBER) where rownum <= #{publishNumber}) ]]>
    </update>
    
    <select id="getControlView" parameterType="short" resultMap="gameParameterControlView">  
        select * from v_gp_control where GAME_CODE=#{gameCode}
    </select> 
    
    <select id="getLastIssue"  parameterType="cls.pilottery.oms.issue.form.IssueManagementForm" resultMap="gameIssue">
		select * from iss_game_issue d 
			where d.GAME_CODE=#{gameCode} and d.issue_number = 
				( select max(issue_number) 
					from iss_game_issue 
					where GAME_CODE=#{gameCode}
					<if test="beginDay != null">
					and to_char(PLAN_START_TIME,'yyyy-MM-dd')='${beginDay}'
					</if>
				)
	</select>
	
	<select id="getMaxIssueNumber" parameterType="short" resultType="long">
		select max(ISSUE_NUMBER) from iss_game_issue d where d.GAME_CODE=#{gameCode}
	</select>
	
	<select id="getMaxIssueSeq" parameterType="short" resultType="long">
		select max(ISSUE_SEQ) from iss_game_issue where GAME_CODE=#{gameCode}
	</select>
	
	<select id="getMaxIssueByGame" parameterType="long" resultMap="gameIssue">  
        SELECT GAME_CODE,
		       ISSUE_NUMBER,
		       ISSUE_SEQ,
		       ISSUE_STATUS,
		       IS_PUBLISH,
		       DRAW_STATE,
		       PLAN_START_TIME,
		       PLAN_CLOSE_TIME,
		       PLAN_REWARD_TIME,
		       REAL_START_TIME,
		       REAL_CLOSE_TIME,
		       REAL_REWARD_TIME,
		       ISSUE_END_TIME,
		       CODE_INPUT_METHOLD,
		       FIRST_DRAW_USER_ID,
		       FIRST_DRAW_NUMBER,
		       SECOND_DRAW_USER_ID,
		       SECOND_DRAW_NUMBER,
		       FINAL_DRAW_NUMBER,
		       FINAL_DRAW_USER_ID,
		       PAY_END_DAY,
		       POOL_START_AMOUNT,
		       POOL_CLOSE_AMOUNT,
		       ISSUE_SALE_AMOUNT,
		       ISSUE_SALE_TICKETS,
		       ISSUE_SALE_BETS,
		       ISSUE_CANCEL_AMOUNT,
		       ISSUE_CANCEL_TICKETS,
		       ISSUE_CANCEL_BETS,
		       WINNING_AMOUNT,
		       WINNING_BETS,
		       WINNING_TICKETS,
		       WINNING_AMOUNT_BIG,
		       WINNING_TICKETS_BIG,
		       ISSUE_RICK_AMOUNT,
		       ISSUE_RICK_TICKETS,
		       WINNING_RESULT,
		       REWARDING_ERROR_CODE,
		       REWARDING_ERROR_MESG,
		       CALC_WINNING_CODE
		  FROM iss_game_issue 
		 WHERE GAME_CODE=#{gameCode} 
		   AND ISSUE_SEQ = (SELECT MAX(ISSUE_SEQ) FROM ISS_GAME_ISSUE WHERE GAME_CODE=#{gameCode})
	</select> 
	
</mapper>