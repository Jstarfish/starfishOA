<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.business.dao.UpdatePlanDao">

	 <resultMap type="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan" id="planResult">
		<id column="SCHEDULE_ID" property="planId" />		
		<result column="Schedule_Name" property="planName" />
		<result column="Term_Type" property="termType" />
		<result column="ADAPT_TERM_TYPES" property="terminalTypes" javaType="cls.pilottery.oms.business.model.TerminalType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.TerminalTypeTypeHandler" />
		<result column="Pkg_Ver" property="softNo" />		
		<result column="SCHEDULE_STATUS" property="planStatus" />
		
		<result column="create_date" property="createDate" />
		<result column="exec_date" property="executeDate" />
		<result column="update_date" property="updateDate" />
		<result column="cancel_date" property="cancelDate" />
		
		<result column="FINISHED" property="finished" />
		<result column="TOTAL" property="total" />
	 </resultMap>
	
	 <resultMap type="cls.pilottery.oms.business.model.tmversionmodel.PlanTermProgress" id="termProgress">
		<id column="SCHEDULE_ID" property="planId" />		
		<result column="TERMINAL_CODE" property="termCode" />
		<result column="TERMINAL_CODE_TOCHAR" property="termCodeTochar" />
		<result column="PKG_VER" property="pkgVer" />
			
		<result column="DL_START_DATE" property="startDate" />		
		<result column="DL_FILENAME" property="curFile" />		
		<result column="DL_PROC" property="curFileProgress" />
		
		<result column="IS_COMP_DL" property="isComplete" />
		<result column="DL_END_DATE" property="endDate" />
		
	
	 </resultMap>
	 
	 <select id="countPlanList" parameterType="cls.pilottery.oms.business.form.tmversionform.PlanQueryForm" resultType="Integer" >
		
		SELECT 
		    COUNT(1)
		FROM
		(SELECT  		  
		    A.SCHEDULE_ID,COUNT(Terminal_Code)
        FROM
          UPG_UPGRADEPLAN A, UPG_UPGRADEPROC B

		WHERE A.SCHEDULE_ID = B.SCHEDULE_ID(+)
			<if test="terminalCode != null and terminalCode != 0">
		 	  and B.Terminal_Code = ${terminalCode}
		    </if>
		    <if test="planState != null and planState != 0">
		 	  and A.SCHEDULE_STATUS = ${planState}
		    </if>
		    <if test="packageVersion != null and packageVersion != 0">
		 	  and replace(A.Pkg_Ver,'.') = replace(#{packageVersion},'.')
		    </if>
		    <if test="fromDateString != null and fromDateString != ''">
		 	   <![CDATA[  and to_date(to_char(A.Schedule_Cr_Date,'yyyy-MM-dd'),'yyyy-MM-dd') >=  to_date('${fromDateString}','yyyy-mm-dd') ]]>
		    </if>
		    <if test="toDateString != null and toDateString != ''">
		 	   <![CDATA[  and to_date(to_char(A.Schedule_Cr_Date,'yyyy-MM-dd'),'yyyy-MM-dd') <=  to_date('${toDateString}','yyyy-mm-dd') ]]>
		    </if>
		GROUP BY 
		  A.SCHEDULE_ID
		  )
		 	
	</select>
	
	 <select id="queryPlanList" parameterType="cls.pilottery.oms.business.form.tmversionform.PlanQueryForm" resultMap="planResult">
	  SELECT * from (
	  SELECT a.*,rownum rn from (
	 	SELECT  
		  A.SCHEDULE_ID,
		  A.Schedule_Name,
		  A.Term_Type,
		  A.Term_Type ADAPT_TERM_TYPES,
		  A.Pkg_Ver,
		  A.SCHEDULE_STATUS,
		  
		  to_char(A.Schedule_Cr_Date,'YYYY-MM-DD HH24:MI:SS') as create_date,
		  to_char(A.Schedule_Exec_Date,'YYYY-MM-DD HH24:MI:SS') as exec_date,
		  to_char(A.SCHEDULE_SW_DATE,'YYYY-MM-DD HH24:MI:SS') as update_date,
		  to_char(A.Schedule_Cancel_Date,'YYYY-MM-DD HH24:MI:SS') as cancel_date,

		  
		  nvl(SUM(IS_COMP_DL),0) AS  FINISHED,
		  COUNT(Terminal_Code) AS TOTAL
        FROM
          UPG_UPGRADEPLAN A, UPG_UPGRADEPROC B

		WHERE A.SCHEDULE_ID = B.SCHEDULE_ID(+)
			<if test="terminalCode != null and terminalCode != 0">
		 	  and B.Terminal_Code = ${terminalCode}
		    </if>
		    <if test="planState != null and planState != 0">
		 	  and A.SCHEDULE_STATUS = ${planState}
		    </if>
		    <if test="packageVersion != null and packageVersion != 0">
		 	  and replace(A.Pkg_Ver,'.') = replace(#{packageVersion},'.')
		    </if>
		    <if test="fromDateString != null and fromDateString != ''">
		 	   <![CDATA[  and to_date(to_char(A.Schedule_Cr_Date,'yyyy-MM-dd'),'yyyy-MM-dd') >=  to_date('${fromDateString}','yyyy-mm-dd') ]]>
		    </if>
		    <if test="toDateString != null and toDateString != ''">
		 	   <![CDATA[  and to_date(to_char(A.Schedule_Cr_Date,'yyyy-mm-dd'), 'yyyy-mm-dd') <=  to_date('${toDateString}','yyyy-mm-dd') ]]>
		    </if>
		GROUP BY 
		  A.SCHEDULE_ID,
		  A.Schedule_Name,
		  A.Term_Type,
		  A.Pkg_Ver,
		  A.SCHEDULE_STATUS,
		  A.Schedule_Cr_Date,
		  A.Schedule_Exec_Date,
		  A.SCHEDULE_SW_DATE,
		  A.Schedule_Cancel_Date
		
	  <![CDATA[ ORDER BY   A.Schedule_Id desc ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	 </select>

	 <select id="selectPlanTermProgress" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan" resultMap="termProgress">
	 	SELECT 
	 		SCHEDULE_ID,
	 		TERMINAL_CODE,
	 		TERMINAL_CODE TERMINAL_CODE_TOCHAR,
	 		PKG_VER,
	 		to_char(DL_START_DATE,'YYYY-MM-DD HH24:MI:SS') DL_START_DATE, 
	 		DL_FILENAME,
	 		nvl(DL_PROC,0)||'%' DL_PROC,
	 		IS_COMP_DL,	 		
	 		to_char(DL_END_DATE,'YYYY-MM-DD HH24:MI:SS') DL_END_DATE
	 		
	 	FROM UPG_UPGRADEPROC
	 	WHERE SCHEDULE_ID = #{planId}
	 </select>
     <!-- insert plan begin -->
	 <select id="selectMaxPlanId" resultType="Integer" >
	 	SELECT MAX(SCHEDULE_ID) FROM UPG_UPGRADEPLAN
	 </select>
	 
	 <resultMap type="cls.pilottery.oms.business.model.tmversionmodel.PlanTerminal" id="planTerminal">
		<id column="TERMINAL_CODE" property="terminalCode" />
	 </resultMap>	 
	 <select id="selectPlanTerminal" parameterType="cls.pilottery.oms.business.model.tmversionmodel.PlanTerminalRange" resultMap="planTerminal">
		SELECT TERMINAL_CODE
		FROM
			SALER_TERMINAL
		WHERE
		     <![CDATA[   TERMINAL_CODE >= #{minTerminalCode} and TERMINAL_CODE <= #{maxTerminalCode} ]]> 
		ORDER BY TERMINAL_CODE
		    
	</select>

    <insert id="intserPlan" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
   	
	   	INSERT INTO UPG_UPGRADEPLAN
	  	VALUES(  			
		  #{planId},
		  #{planName},
		  #{pkgVer},
		  #{termType},
		  1,
		  to_date(#{updateDate},'yyyy-mm-dd hh24:mi:ss'),
		  sysdate,		  
		  NULL,
		  NULL
		  )	
    </insert>
     <insert id="intserPlanTerminal" parameterType="cls.pilottery.oms.business.model.tmversionmodel.PlanTerminal">
   	
	    INSERT INTO UPG_UPGRADEPROC
	  	VALUES(  			
		  #{terminalCode},
		  #{planId},
		  #{packVer,mode=IN,jdbcType=VARCHAR,jdbcType=CHAR},
		  0,
		  NULL,
		  NULL,	  
		  NULL,
		  NULL
		  )	
    </insert>
    <!-- insert plan  end -->
    
    <update id="updatePlan" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
   	
   		{call p_om_updplan_modify (
		 		
		 		#{planId,mode=IN,jdbcType=NUMERIC},
    	        #{planName,mode=IN,jdbcType=VARCHAR},
		 		#{softNo,mode=IN,jdbcType=VARCHAR},
		 		#{updateDate,mode=IN,jdbcType=VARCHAR},
		 		#{c_errcode,mode=OUT,jdbcType=NUMERIC},
   	        	#{c_errmsg,mode=OUT,jdbcType=VARCHAR}

		 	)
		 }
	  	
    </update>
    
     <update id="updateUpdateTime" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
   	
	   	UPDATE UPG_UPGRADEPLAN
	   	SET 
	   
	   		SCHEDULE_SW_DATE = to_date(#{updateDate},'yyyy-mm-dd hh24:mi:ss')
	   	WHERE
	   		SCHEDULE_ID = #{planId}
	  	
    </update>
    <update id="updateUpdateTimeToNow" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
   	
	   	UPDATE UPG_UPGRADEPLAN
	   	SET 
	   
	   		SCHEDULE_SW_DATE = sysdate
	   	WHERE
	   		SCHEDULE_ID = #{planId}
	  	
    </update>
    
    <update id="updatePlanStatus" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
   	
	   	UPDATE UPG_UPGRADEPLAN
	   	SET 
	   
	   		SCHEDULE_STATUS = #{planStatus}
	   		<!-- 执行计划 -->
	   		<if test="planStatus==2" >
	   			,SCHEDULE_EXEC_DATE = sysdate
	   		</if>
	   		<!-- 取消计划 -->
	   		<if test="planStatus==3">
	   			,SCHEDULE_CANCEL_DATE = sysdate
	   		</if>
	   		
	   	WHERE
	   		SCHEDULE_ID = #{planId}
	  	
    </update>
    
    <select id="ifExistPlanName" parameterType="java.util.HashMap" resultType="Integer">
    	select count(1) from UPG_UPGRADEPLAN t where trim(t.SCHEDULE_NAME) = #{planName} <if test="oPlanName!=null and oPlanName!=''"> and trim(t.SCHEDULE_NAME)!=#{oPlanName}</if>
    </select>
    
    <update id="addUpgradePlan" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.tmversionmodel.UpdatePlan">
    	{call p_om_updplan_create (
		 		
    	        #{planName,mode=IN,jdbcType=VARCHAR},
    	        #{termType,mode=IN,jdbcType=NUMERIC},
    	        #{softNo,mode=IN,jdbcType=VARCHAR},
    	        #{updateDate,mode=IN,jdbcType=VARCHAR},
    	        #{cityCode,mode=IN,jdbcType=VARCHAR},
    	        #{termCodes,mode=IN,jdbcType=VARCHAR},
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
   	        	#{c_errmsg,mode=OUT,jdbcType=VARCHAR},
   	        	#{planId,mode=OUT,jdbcType=NUMERIC}
		 	)
		 }
    </update>
    
    <select id="isCorrectTerminalNo" parameterType="java.util.HashMap" resultType="Integer">
    	select count(1) from SALER_TERMINAL t where t.terminal_code = #{termNo} and t.term_type_id = #{termType}
    </select>
    
</mapper>
