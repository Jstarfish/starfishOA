<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.report.dao.AnalysisStatisticsDao">
	<select id="getAgencyInfoList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		with agency as (
			SELECT AGENCY_CODE agencyCode,
	               AGENCY_NAME agencyName,
	               ADMIN_REALNAME marketManager,
	               AREA_NAME areaName,
	               TELEPHONE telephone,
	               CONTACT_PERSON contactPerson,
	               A.ADDRESS address,
	               to_char(AGENCY_ADD_TIME,'yyyy-mm-dd') addTime,
	               CONTRACT_NO contractNo,
	               CREDIT_LIMIT credit,
	               ORG_CODE orgCode,
	               ORG_NAME orgName,
	               A.Status status
	          FROM INF_AGENCYS A
	          left join INF_AGENCY_EXT using (AGENCY_CODE)
	          left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	          left join adm_info on (MARKET_MANAGER_ID = ADMIN_ID)
	          left join INF_AREAS using (AREA_CODE)
	          left join inf_orgs using (org_code)
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		left join comm using (agencyCode)      
		where 1=1
		  <if test="beginDate != null and beginDate != ''">
				AND addTime between #{beginDate} and #{endDate}
		  </if>
		  <if test="institutionCode != null and institutionCode != ''">
				AND orgCode = #{institutionCode}
		  </if>
		  <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND orgCode IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		  <if test="outletCode != null and outletCode !=''">
				and agencyCode = #{outletCode}
		  </if>
		  <if test="status != null and status !=''">
				and status = #{status}
		  </if>
		  ORDER BY addTime desc,orgCode,agencyCode
	</select>
	
	<select id="getNoSaleOutletsList"  resultType="cls.pilottery.web.report.model.OutletInfoVO" parameterType="cls.pilottery.web.report.form.AnalysisStatisticsForm">
		WITH AGENCY AS (
			SELECT AGENCY_CODE agencyCode,
	                AGENCY_NAME agencyName,
	                TELEPHONE telephone,
	                CONTACT_PERSON contactPerson,
	                a.ADDRESS address,
	                TO_CHAR (AGENCY_ADD_TIME, 'yyyy-mm-dd') addTime,
	                CONTRACT_NO contractNo,
	                CREDIT_LIMIT credit,
	                ORG_CODE orgCode,
	                ORG_NAME orgName,
	                a.Status status
	           FROM inf_agencys a
	           left join inf_orgs using (org_code)
	           left join ACC_AGENCY_ACCOUNT using (AGENCY_CODE)
	           left join INF_AGENCY_EXT using (AGENCY_CODE)
			 WHERE status = 1
			  <![CDATA[ AND to_char(agency_add_time,'yyyy-mm-dd') < #{beginDate} ]]>
			   AND agency_code NOT IN
		              (SELECT agency_code
		                 FROM his_agency_fund
		                WHERE flow_type = 7
		                <if test="beginDate != null and beginDate != ''">
							AND calc_date between #{beginDate} and #{endDate}
						</if>
					   )
			  	<if test="institutionCode != null and institutionCode != ''">
			  		AND agency_code in (select agency_code from inf_agencys where org_code = #{institutionCode})
	  			</if>
	  			<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		   	   
		),
		comm as (
		    select agency_code agencyCode,sale_comm saleComm,pay_comm payComm from GAME_AGENCY_COMM_RATE     
		    group by agency_code,sale_comm,pay_comm
		)          
		select * from agency
		left join comm using (agencyCode) 
		ORDER BY orgCode,agencyCode
	</select>
	
	<!-- 根据系统（电脑票、即开票）查询部门销售统计 -->
	<select id="getInstFundReportByLotTypeList" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.*,org_name orgName from (
			select 0 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(sale, 0)+nvl(lot_sale, 0) as saleAmount,
			       nvl(sale_comm, 0)+nvl(lot_sale_comm, 0) as saleComm,
			       nvl(paid, 0)+nvl(lot_paid, 0) as payout,
			       nvl(pay_comm, 0)+nvl(lot_pay_comm, 0) as payoutComm,
			       nvl(rtv, 0)+nvl(lot_rtv, 0) as returnAmount,
			       nvl(rtv_comm, 0)+nvl(lot_rtv_comm, 0) as returnComm,
			       nvl(CENTER_PAY, 0)+nvl(lot_CENTER_PAY, 0) as centerPayAmount,
			       nvl(CENTER_PAY_COMM, 0)+nvl(lot_CENTER_PAY_COMM, 0) as centerPayComm,
			       nvl(LOT_CENTER_RTV,0) as cancelAmount,
			       nvl(LOT_CENTER_RTV_COMM,0) as centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			union all      
			select 1 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(sale, 0) as saleAmount,
			       nvl(sale_comm, 0) as saleComm,
			       nvl(paid, 0) as payout,
			       nvl(pay_comm, 0) as payoutComm,
			       nvl(rtv, 0) as returnAmount,
			       nvl(rtv_comm, 0) as returnComm,
			       nvl(CENTER_PAY, 0) as centerPayAmount,
			       nvl(CENTER_PAY_COMM, 0) as centerPayComm,
			       0 as cancelAmount,
			       0 as centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			union all 
			select 2 as tjType,
			       CALC_DATE as balanceDate,
			       org_code as orgCode,
			       nvl(lot_sale, 0) as saleAmount,
			       nvl(lot_sale_comm, 0) as saleComm,
			       nvl(lot_paid, 0) as payout,
			       nvl(lot_pay_comm, 0) as payoutComm,
			       nvl(lot_rtv, 0) as returnAmount,
			       nvl(lot_rtv_comm, 0) as returnComm,
			       nvl(lot_CENTER_PAY, 0) as centerPayAmount,
			       nvl(lot_CENTER_PAY_COMM, 0) as centerPayComm,
			       nvl(LOT_CENTER_RTV,0) as cancelAmount,
			       nvl(LOT_CENTER_RTV_COMM,0) as centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 ) tab 
			 join inf_orgs on (tab.orgCode = inf_orgs.org_code)
			 where tjType = #{tjType}
			 order by balanceDate desc,orgCode
	</select>
	
	<select id="getInstFundReportByLotTypeSum" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.* from (
			select 0 as tjType,
			       sum(nvl(sale, 0)+nvl(lot_sale, 0)) as saleAmount,
			       sum(nvl(sale_comm, 0)+nvl(lot_sale_comm, 0)) as saleComm,
			       sum(nvl(paid, 0)+nvl(lot_paid, 0)) as payout,
			       sum(nvl(pay_comm, 0)+nvl(lot_pay_comm, 0)) as payoutComm,
			       sum(nvl(rtv, 0)+nvl(lot_rtv, 0)) as returnAmount,
			       sum(nvl(rtv_comm, 0)+nvl(lot_rtv_comm, 0)) as returnComm,
			       sum(nvl(CENTER_PAY, 0)+nvl(lot_CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(CENTER_PAY_COMM, 0)+nvl(lot_CENTER_PAY_COMM, 0)) as centerPayComm,
			       sum(nvl(LOT_CENTER_RTV,0)) as cancelAmount,
			       sum(nvl(LOT_CENTER_RTV_COMM,0)) as centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			union all
			select 1 as tjType,
			       sum(nvl(sale, 0)) as saleAmount,
			       sum(nvl(sale_comm, 0)) as saleComm,
			       sum(nvl(paid, 0)) as payout,
			       sum(nvl(pay_comm, 0)) as payoutComm,
			       sum(nvl(rtv, 0)) as returnAmount,
			       sum(nvl(rtv_comm, 0)) as returnComm,
			       sum(nvl(CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(CENTER_PAY_COMM, 0)) as centerPayComm,
			       0 as cancelAmount,
			       0 centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			union all 
			select 2 as tjType,
			       sum(nvl(lot_sale, 0)) as saleAmount,
			       sum(nvl(lot_sale_comm, 0)) as saleComm,
			       sum(nvl(lot_paid, 0)) as payout,
			       sum(nvl(lot_pay_comm, 0)) as payoutComm,
			       sum(nvl(lot_rtv, 0)) as returnAmount,
			       sum(nvl(lot_rtv_comm, 0)) as returnComm,
			       sum(nvl(lot_CENTER_PAY, 0)) as centerPayAmount,
			       sum(nvl(lot_CENTER_PAY_COMM, 0)) as centerPayComm,
			       sum(nvl(LOT_CENTER_RTV,0)) as cancelAmount,
			       sum(nvl(LOT_CENTER_RTV_COMM,0)) as centerCancelComm
			  from v_his_org_fund_report
			  where CALC_DATE between #{beginDate} and #{endDate}
			    <if test="institutionCode != null and institutionCode != ''">
					AND ORG_CODE = #{institutionCode}
		  		</if>
		  		<if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 ) tab 
			 where tjType = #{tjType}
	</select>
	
	<select id="getAgentFundReportByLotTypeList" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.*,tab.org_code orgCode,org_name orgName from (
			select 0 tjType,
				   CALC_DATE as balanceDate,
				   org_code,
				   nvl(SALE_AMOUNT, 0) + nvl(LOT_AGENCY_SALE_AMOUNT, 0) as saleAmount,
			       nvl(ORG_COMM_AMOUNT,0) + nvl(lot_agency_sale_comm_amount,0) saleComm,
			       nvl(ORG_RETURN_AMOUNT, 0) as returnAmount ,
			       nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0) as returnComm,
			       nvl(ORG_CENTER_PAY_AMOUNT, 0) + nvl(lot_org_center_pay_amount,0) as centerPayAmount,
			       nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0) + nvl(lot_ORG_CENTER_PAY_COMM_AMOUNT, 0) as centerPayComm ,
			       nvl(ORG_AGENCY_PAY_AMOUNT, 0) + nvl(lot_org_agency_pay_amount,0) as payout,
			       nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0) + nvl(lot_org_agency_pay_comm_amount,0) as payoutComm,
			       nvl(lot_org_center_cancel_amount,0) cancelAmount,
			       nvl(lot_agency_cancel_comm_amount,0) agencyCancelComm
			  from v_his_agent_fund_report
			 where CALC_DATE between #{beginDate} and #{endDate}
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 union all 
			select 1 tjType,
				   CALC_DATE as balanceDate,
				   org_code,
			       nvl(SALE_AMOUNT, 0) as saleAmount,
			       nvl(ORG_COMM_AMOUNT,0) saleComm,
			       nvl(ORG_RETURN_AMOUNT, 0) as returnAmount ,
			       nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0) as returnComm,
			       nvl(ORG_CENTER_PAY_AMOUNT, 0) as centerPayAmount,
			       nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0) as centerPayComm ,
			       nvl(ORG_AGENCY_PAY_AMOUNT, 0) as payout,
			       nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0) as payoutComm,
			       0 cancelAmount,
			       0 agencyCancelComm
			  from v_his_agent_fund_report
			 where CALC_DATE between #{beginDate} and #{endDate}
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 union all 
			 select 2 tjType,
				   CALC_DATE as balanceDate,
				   org_code,
			       nvl(LOT_AGENCY_SALE_AMOUNT, 0) as saleAmount,
			       nvl(lot_agency_sale_comm_amount,0) saleComm,
			       0 as returnAmount ,
			       0 as returnComm,
			       nvl(lot_org_center_pay_amount,0) as centerPayAmount,
			       nvl(lot_ORG_CENTER_PAY_COMM_AMOUNT, 0) as centerPayComm ,
			       nvl(lot_org_agency_pay_amount,0) as payout,
			       nvl(lot_org_agency_pay_comm_amount,0) as payoutComm,
			       nvl(lot_org_center_cancel_amount,0) cancelAmount,
			       nvl(lot_agency_cancel_comm_amount,0) agencyCancelComm
			  from v_his_agent_fund_report
			 where CALC_DATE between #{beginDate} and #{endDate}
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		  ) tab
		  right join inf_orgs on (tab.org_code = inf_orgs.org_code)
		  where ORG_TYPE = 2 and tjType = #{tjType}			
		  order by balanceDate desc,orgCode
	</select>
	<select id="getAgentFundReportByLotTypeSum" resultType="cls.pilottery.web.report.model.InstitutionFundVO" parameterType="cls.pilottery.web.report.form.SaleReportForm">
		select tab.* from (
			select 0 tjType,
				   sum(nvl(SALE_AMOUNT, 0) + nvl(LOT_AGENCY_SALE_AMOUNT, 0)) as saleAmount,
			       sum(nvl(ORG_COMM_AMOUNT,0) + nvl(lot_agency_sale_comm_amount,0)) saleComm,
			       sum(nvl(ORG_RETURN_AMOUNT, 0)) as returnAmount ,
			       sum(nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0)) as returnComm,
			       sum(nvl(ORG_CENTER_PAY_AMOUNT, 0) + nvl(lot_org_center_pay_amount,0)) as centerPayAmount,
			       sum(nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0) + nvl(lot_ORG_CENTER_PAY_COMM_AMOUNT, 0)) as centerPayComm ,
			       sum(nvl(ORG_AGENCY_PAY_AMOUNT, 0) + nvl(lot_org_agency_pay_amount,0)) as payout,
			       sum(nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0) + nvl(lot_org_agency_pay_comm_amount,0)) as payoutComm,
			       sum(nvl(lot_org_center_cancel_amount,0)) cancelAmount,
			       sum(nvl(lot_agency_cancel_comm_amount,0)) agencyCancelComm
			  from v_his_agent_fund_report 
			  right join inf_orgs using (org_code)
			 where CALC_DATE between #{beginDate} and #{endDate} and ORG_TYPE = 2
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 union all 
			select 1 tjType,
			       sum(nvl(SALE_AMOUNT, 0)) as saleAmount,
			       sum(nvl(ORG_COMM_AMOUNT,0)) saleComm,
			       sum(nvl(ORG_RETURN_AMOUNT, 0)) as returnAmount ,
			       sum(nvl(ORG_COMM_ORG_RETURN_AMOUNT, 0)) as returnComm,
			       sum(nvl(ORG_CENTER_PAY_AMOUNT, 0)) as centerPayAmount,
			       sum(nvl(ORG_CENTER_PAY_COMM_AMOUNT, 0)) as centerPayComm ,
			       sum(nvl(ORG_AGENCY_PAY_AMOUNT, 0)) as payout,
			       sum(nvl(ORG_AGENCY_PAY_COMM_AMOUNT, 0)) as payoutComm,
			       0 cancelAmount,
			       0 agencyCancelComm
			  from v_his_agent_fund_report 
			  right join inf_orgs using (org_code)
			 where CALC_DATE between #{beginDate} and #{endDate} and ORG_TYPE = 2
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
			 union all 
			 select 2 tjType,
			       SUM(nvl(LOT_AGENCY_SALE_AMOUNT, 0)） as saleAmount,
			       SUM(nvl(lot_agency_sale_comm_amount,0)) saleComm,
			       0 as returnAmount ,
			       0 as returnComm,
			       sum(nvl(lot_org_center_pay_amount,0)) as centerPayAmount,
			       sum(nvl(lot_ORG_CENTER_PAY_COMM_AMOUNT, 0)) as centerPayComm ,
			       sum(nvl(lot_org_agency_pay_amount,0)) as payout,
			       sum(nvl(lot_org_agency_pay_comm_amount,0)) as payoutComm,
			       sum(nvl(lot_org_center_cancel_amount,0)) cancelAmount,
			       sum(nvl(lot_agency_cancel_comm_amount,0)) agencyCancelComm
			  from v_his_agent_fund_report
			  right join inf_orgs using (org_code)
			 where CALC_DATE between #{beginDate} and #{endDate} and ORG_TYPE = 2
			 <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		  ) tab
		  where tjType = #{tjType}	  	
	</select>
	
	<select id="getCtgAuthDetail" parameterType="String" resultType="cls.pilottery.web.report.model.AuthDetailModel">
		SELECT game_code gameCode,
		       short_name gameName,
		       allow_sale isSale,
		       allow_pay isPayout,
		       allow_cancel isCancel,
		       sale_commission_rate saleComm,
		       pay_commission_rate payoutComm
		  FROM auth_agency JOIN inf_games USING (game_code)
		 WHERE agency_code = #{_parameter}
		 order by game_code
	</select>
	
	<select id="getPilAuthDetail" parameterType="String" resultType="cls.pilottery.web.report.model.AuthDetailModel">
		  SELECT plan_code gameCode,
		         short_name gameName,
		         sale_comm saleComm,
		         pay_comm payoutComm
		    FROM GAME_AGENCY_COMM_RATE JOIN GAME_PLANS USING (plan_code)
		   WHERE agency_code = #{_parameter}
		ORDER BY plan_code
	
	</select>
	
	<!-- 净销售额汇总日报表 -->
	<select id="getNetSalesList" parameterType="cls.pilottery.web.report.form.NetSalesForm" resultType="cls.pilottery.web.report.model.NetSalesModel">
		WITH base AS
		 (SELECT calc_date showDate,
		         org_code orgCode,
		         org_name orgName,
		         sale pilSaleKhr,
		         rtv pilCancelKhr,
		         lot_sale ctgSaleKhr,
		         lot_rtv+lot_center_rtv ctgCancelKhr,
		         ROUND(sale / F_GET_SYS_PARAM(100), 3) pilSaleUsd,
		         ROUND(rtv / F_GET_SYS_PARAM(100), 3) pilCancelUsd,
		         ROUND(lot_sale / F_GET_SYS_PARAM(100), 3) ctgSaleUsd,
		         ROUND((lot_rtv+lot_center_rtv) / F_GET_SYS_PARAM(100), 3) ctgCancelUsd
		    FROM his_org_fund_report
		    JOIN inf_orgs
		   USING (org_code)
		   WHERE 1=1
		   <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		     AND CALC_DATE between #{beginDate} and #{endDate})
		SELECT base.showDate as showDate,
		       base.orgName as institutionName,
		       base.pilSaleKhr as pilKHRSaleAmount,
		       base.pilCancelKhr as pilKHRReturnAmount,
		       base.ctgSaleKhr as ctgKHRSaleAmount,
		       base.ctgCancelKhr as ctgKHRReturnAmount,
		       base.pilSaleUsd as pilUSDSaleAmount,
		       base.pilCancelUsd as pilUSDReturnAmount,
		       base.ctgSaleUsd as ctgUSDSaleAmount,
		       base.ctgCancelUsd as ctgUSDReturnAmount,
		       pilSaleUsd - pilCancelUsd as pilUSDNetSaleAmount,
		       ctgSaleUsd - ctgCancelUsd as ctgUSDNetSaleAmount,
		       pilSaleUsd - pilCancelUsd + ctgSaleUsd - ctgCancelUsd as netSaleAmount
		  FROM base
		  order by showDate desc,(pilSaleUsd - pilCancelUsd + ctgSaleUsd - ctgCancelUsd) desc
	</select>

	<select id="getNetSalesSum" parameterType="cls.pilottery.web.report.form.NetSalesForm" resultType="cls.pilottery.web.report.model.NetSalesModel">
		WITH base AS
		 (SELECT calc_date showDate,
		         org_code orgCode,
		         org_name orgName,
		         sale pilSaleKhr,
		         rtv pilCancelKhr,
		         lot_sale ctgSaleKhr,
		         lot_rtv+lot_center_rtv ctgCancelKhr,
		         ROUND(sale / F_GET_SYS_PARAM(100), 3) pilSaleUsd,
		         ROUND(rtv / F_GET_SYS_PARAM(100), 3) pilCancelUsd,
		         ROUND(lot_sale / F_GET_SYS_PARAM(100), 3) ctgSaleUsd,
		         ROUND((lot_rtv+lot_center_rtv) / F_GET_SYS_PARAM(100), 3) ctgCancelUsd
		    FROM his_org_fund_report
		    JOIN inf_orgs
		   USING (org_code)
		  WHERE 1=1
		   <if test="institutionCode != null and institutionCode != ''">
				AND ORG_CODE = #{institutionCode}
	  		 </if>
	  		 <if test="institutionCode == null or institutionCode == ''">
		  		<if test="cuserOrg != '00'">
		  			AND ORG_CODE IN (
		  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
		  				UNION 
		  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  			)
		  		</if>
		  </if>
		     AND CALC_DATE between #{beginDate} and #{endDate})
		SELECT sum(base.pilSaleKhr) as pilKHRSaleAmount,
		       sum(base.pilCancelKhr) as pilKHRReturnAmount,
		       sum(base.ctgSaleKhr) as ctgKHRSaleAmount,
		       sum(base.ctgCancelKhr) as ctgKHRReturnAmount,
		       sum(base.pilSaleUsd) as pilUSDSaleAmount,
		       sum(base.pilCancelUsd) as pilUSDReturnAmount,
		       sum(base.ctgSaleUsd) as ctgUSDSaleAmount,
		       sum(base.ctgCancelUsd) as ctgUSDReturnAmount,
		       sum(pilSaleUsd - pilCancelUsd) as pilUSDNetSaleAmount,
		       sum(ctgSaleUsd - ctgCancelUsd) as ctgUSDNetSaleAmount,
		       sum(pilSaleUsd - pilCancelUsd + ctgSaleUsd - ctgCancelUsd) as netSaleAmount
		  FROM base
	</select> 
	
</mapper>