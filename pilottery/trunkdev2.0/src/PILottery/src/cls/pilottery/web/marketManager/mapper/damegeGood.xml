<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.marketManager.dao.DamegeGoodDao">
	
	<select id="getPlanListByUser" parameterType="int" resultType="cls.pilottery.web.marketManager.model.GamePlanModel">
		with plan as (
		    select plan_code from (
		        select plan_code from WH_TICKET_TRUNK where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		        union 
		        select plan_code from WH_TICKET_BOX  where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		        union 
		        select plan_code from WH_TICKET_PACKAGE  where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		    ) 
		)
		select plan_code planCode,full_name planName from plan
		left join game_plans using (plan_code)
	</select>
	
	<select id="getBatchListByPlan" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm" resultType="cls.pilottery.web.marketManager.model.GamePlanModel">
		with plan as (
		    select plan_code,batch_no from (
		        select plan_code,BATCH_NO from WH_TICKET_TRUNK where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		        union 
		        select plan_code,BATCH_NO from WH_TICKET_BOX  where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		        union 
		        select plan_code,BATCH_NO from WH_TICKET_PACKAGE  where status = 21  and CURRENT_WAREHOUSE = #{currentUserId}
		    ) where plan_code = #{planCode}
		)
		select plan_code planCode,
			   BATCH_NO batchNo,
			   full_name planName,
			   PACKS_EVERY_TRUNK*TICKETS_EVERY_PACK*TICKET_AMOUNT amountEveryTruck,
			   PACKS_EVERY_TRUNK*TICKETS_EVERY_PACK*TICKET_AMOUNT/BOXES_EVERY_TRUNK amountEveryBox,
			   TICKETS_EVERY_PACK*TICKET_AMOUNT amountEveryPackage
		from plan
		left join GAME_BATCH_IMPORT_DETAIL using (plan_code,batch_no)
		left join game_plans using (plan_code)
	</select>
	
	<select id="getTreeByBatch" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm" resultType="cls.pilottery.web.marketManager.model.InventoryTreeModel">
		with inventory as(
		SELECT trunk_no,box_no,package_no
		  FROM WH_TICKET_PACKAGE
		 WHERE status = 21 AND CURRENT_WAREHOUSE = #{currentUserId}
		 and plan_code = #{planCode} and batch_no = #{batchNo}
		)
		select TRUNK_NO id,'null' pId,TRUNK_NO name,is_full isFull,1 type 
		from WH_TICKET_TRUNK 
		where TRUNK_NO in (select distinct trunk_no from inventory) 
		and plan_code = #{planCode} and batch_no = #{batchNo}
		union
		select TRUNK_NO||','||BOX_NO id,TRUNK_NO pId,BOX_NO name,is_full isFull,2 type 
		from WH_TICKET_BOX 
		where box_no in (select distinct box_no from inventory)
		and plan_code = #{planCode} and batch_no = #{batchNo}
		union 
		select TRUNK_NO||','||BOX_NO||','||package_no id,TRUNK_NO||','||BOX_NO pId,package_no name,is_full isFull,3 type 
		from WH_TICKET_PACKAGE 
		where package_no in (select distinct package_no from inventory)
		and plan_code = #{planCode} and batch_no = #{batchNo}
	</select>
	
	<update id="updateTrunkStatus" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE WH_TICKET_TRUNK 
		SET STATUS = #{status},
		    CHANGE_ADMIN = #{currentUserId},
		    CHANGE_DATE = to_date(#{operateDate},'yyyymmddhh24miss')
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	        AND TRUNK_NO = #{trunkNo}
	</update>
	
	<update id="updateBoxStatus" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE WH_TICKET_BOX 
		SET STATUS = #{status},
		    CHANGE_ADMIN = #{currentUserId},
		    CHANGE_DATE = to_date(#{operateDate},'yyyymmddhh24miss')
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	        AND TRUNK_NO = #{trunkNo}
	        <if test="boxNo != null and boxNo != ''">
	        	AND BOX_NO = #{boxNo}
	        </if>
	</update>
	
	<update id="updatePackageStatus" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE WH_TICKET_PACKAGE 
		SET STATUS = #{status},
		    CHANGE_ADMIN = #{currentUserId},
		    CHANGE_DATE = to_date(#{operateDate},'yyyymmddhh24miss')
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	        AND TRUNK_NO = #{trunkNo}
	        <if test="boxNo != null and boxNo != ''">
	        	AND BOX_NO = #{boxNo}
	        </if>
	        <if test="packageNo != null and packageNo != ''">
	        	AND package_no = #{packageNo}
	        </if>
	</update>
	
	<update id="updateTrunkIsFull" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE WH_TICKET_TRUNK 
		SET IS_FULL = 0
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	        AND TRUNK_NO = #{trunkNo}
	</update>
	
	<update id="updateBoxIsFull" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE WH_TICKET_BOX 
		SET IS_FULL = 0
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	        AND TRUNK_NO = #{trunkNo}
	        AND BOX_NO = #{boxNo}
	</update>
	
	<update id="updateInventory" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		UPDATE ACC_MM_TICKETS 
		SET TICKETS = TICKETS - #{totalTickets},
		    AMOUNT = AMOUNT - #{totalAmount}
	  WHERE plan_code = #{planCode} and batch_no = #{batchNo}
	  		AND MARKET_ADMIN = #{currentUserId}
	</update>
	
	<select id="getDamageSum" resultType="cls.pilottery.web.marketManager.model.DamageSumModel"  parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		with pcount as (
			SELECT COUNT(1) pack_count
			  FROM WH_TICKET_PACKAGE
			 WHERE status IN (41, 42, 43)
   			   AND TO_CHAR(CHANGE_DATE, 'yyyymmddhh24miss') = #{operateDate}
   			   AND CURRENT_WAREHOUSE = '${currentUserId}'
   			   AND plan_code = #{planCode} and batch_no = #{batchNo}
		),
		pamount as (
			select TICKETS_EVERY_PACK,TICKET_AMOUNT
			from GAME_BATCH_IMPORT_DETAIL a,GAME_PLANS b
			where a.plan_code = b.plan_code 
			AND a.plan_code = #{planCode} and batch_no = #{batchNo}
		)
		select pcount.pack_count as damagePackage,
			pamount.TICKETS_EVERY_PACK packTickets,
			pamount.TICKET_AMOUNT ticketAmount
		from pcount,pamount
	</select>
	
	<select id="getBrokenRecordSeq" resultType="string">
		SELECT F_GET_WH_BROKEN_RECODER_SEQ FROM DUAL
	</select>
	
	<insert id="insertBrokenDetailTrunk" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		insert into WH_BROKEN_RECODER_DETAIL(BROKEN_NO, SEQUENCE_NO, VALID_NUMBER, PLAN_CODE, BATCH_NO, TRUNK_NO, PACKAGES, AMOUNT)
		values (#{brokenNo},F_GET_DETAIL_SEQUENCE_NO_SEQ,1,#{planCode},#{batchNo},#{trunkNo},#{packages},#{amount})
	</insert>
	
	<insert id="insertBrokenDetailBox" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		insert into WH_BROKEN_RECODER_DETAIL(BROKEN_NO, SEQUENCE_NO, VALID_NUMBER, PLAN_CODE, BATCH_NO, TRUNK_NO,BOX_NO, PACKAGES, AMOUNT)
		values (#{brokenNo},F_GET_DETAIL_SEQUENCE_NO_SEQ,2,#{planCode},#{batchNo},#{trunkNo},#{boxNo},#{packages},#{amount})
	</insert>
	
	<insert id="insertBrokenDetailPack" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		insert into WH_BROKEN_RECODER_DETAIL(BROKEN_NO, SEQUENCE_NO, VALID_NUMBER, PLAN_CODE, BATCH_NO,TRUNK_NO,BOX_NO, PACKAGE_NO, PACKAGES, AMOUNT)
		values (#{brokenNo},F_GET_DETAIL_SEQUENCE_NO_SEQ,3,#{planCode},#{batchNo},#{trunkNo},#{boxNo},#{packageNo},#{packages},#{amount})
	</insert>
	
	<insert id="insertBrokenInfo" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		INSERT INTO WH_BROKEN_RECODER(BROKEN_NO, APPLY_ADMIN, APPLY_DATE, SOURCE, PACKAGES, TOTAL_AMOUNT, REASON, REMARK)
		VALUES (#{brokenNo},#{currentUserId},to_date(#{operateDate},'yyyymmddhh24miss'),1,#{totalPackages},#{totalAmount},#{status},#{remark})
	</insert>
	
	<select id="getPlanInfo" resultType="cls.pilottery.web.sales.model.PlanModel" parameterType="cls.pilottery.web.marketManager.form.DamegeGoodForm">
		SELECT PLAN_CODE planCode,
		       TICKET_AMOUNT ticketAmount,
		       PACKS_EVERY_TRUNK trunkPacks,
		       PACKS_EVERY_TRUNK / BOXES_EVERY_TRUNK boxPacks,
		       TICKETS_EVERY_PACK packTickets
		  FROM GAME_BATCH_IMPORT_DETAIL LEFT JOIN GAME_PLANS USING (PLAN_CODE)
		 WHERE PLAN_CODE = #{planCode} AND BATCH_NO = #{batchNo}
	</select>
	
</mapper>
