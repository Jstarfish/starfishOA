<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.inventory.dao.CheckPointDao">
	<!-- 分页记录总数 -->
	<select id="getCheckCount" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="Integer">
		  select count(distinct ch.cp_no )
		    from wh_check_point ch, adm_info ad, wh_info wh,( select m.warehouse_code from  WH_MANAGER m where m.org_code=#{orgCode}) mh
		   where 1 = 1
		     and ch.cp_admin = ad.admin_id
		     and wh.warehouse_code = ch.warehouse_code
		     and wh.warehouse_code=mh.warehouse_code
		<if test="cpDate!=null and cpDate!=''">
			and to_char(ch.cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>
		<if test="houseCode!= null and houseCode!=''">
			and ch.warehouse_code = #{houseCode}
		</if>
		<if test="cpAdmin!= null and cpAdmin!=0">
			and ch.cp_admin =#{cpAdmin}
		</if>
		<if test="status!=null and status!=0">
			and ch.status=#{status}
		</if>
		<if test="result!=null and result!=0">
			and ch.result=#{result}
		</if>

	</select>
	<!-- 盘点分页 -->
	<select id="getCheckList" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="cls.pilottery.web.inventory.model.CheckPointVo">
		select * from (
		select a.*,rownum rn from (
			select distinct ch.cp_no          as cpno,
			       wh.warehouse_name as housecode,
			       ch.cp_name        as cpname,
			       ch.cp_date        as cpdate,
			       ch.status         as status,
			       ch.result         as result,
			       ad.admin_realname as chname
			  from wh_check_point ch, adm_info ad, wh_info wh,( select m.warehouse_code from  WH_MANAGER m where m.org_code=#{orgCode}) mh
			 where 1 = 1
			   and ch.cp_admin = ad.admin_id
			   and wh.warehouse_code = ch.warehouse_code
			    and wh.warehouse_code=mh.warehouse_code
		<if test="cpDate!= null and cpDate!= ''">
			and to_char(ch.cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>

		<if test="houseCode!= null and houseCode!= ''">
			and ch.warehouse_code = #{houseCode}
		</if>
		<if test="cpAdmin != null and cpAdmin !=0">
			and ch.cp_admin = #{cpAdmin}
		</if>
		<if test="status!=null and status!=0">
			and ch.status=#{status}
		</if>
		<if test="result!=null and result!=0">
			and ch.result=#{result}
		</if>
		order by ch.cp_date desc
	<![CDATA[ ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	<select id="getCpCheckUserList" parameterType="String" resultType="cls.pilottery.web.system.model.User">
		select ad.admin_id       as id,
		       ad.admin_realname as realname,
		       wh.warehouse_code as warehousecode
		  from adm_info ad, wh_manager wh
		 where 1 = 1
		   and ad.is_warehouse_m = 1
		   and wh.manager_id = ad.admin_id
		   and ad.admin_status = 1
		   and wh.ORG_CODE=#{orgCode}
	</select>
	<select id="getWhouseList" resultType="cls.pilottery.web.inventory.model.WhInfoVo">
		select
		wh.warehouse_code as whcode,
		wh.warehouse_name as whname
		from WH_INFO wh
		where wh.status = 1
	</select>
	<select id="getGameBatchListBCode"
		parameterType="cls.pilottery.web.goodsreceipts.model.GameBatchImport"
		resultType="cls.pilottery.web.goodsreceipts.model.GameBatchImport">
		select ba.plan_code as planCode, ba.batch_no as batchNo
			from GAME_BATCH_IMPORT_DETAIL ba
			where 1 = 1
			and ba.status = 1
		<if test="planCode!=null and planCode!=''">
			and ba.plan_code=#{planCode}
		</if>

	</select>


	<update id="addCheckPoint" statementType="CALLABLE"
		parameterType="cls.pilottery.web.inventory.model.CheckPointParmat">
		{call p_warehouse_check_step1(
				#{cpAdmin,mode=IN,jdbcType=NUMERIC},
				#{cpName,mode=IN,jdbcType=VARCHAR},
				#{houseCode,mode=IN,jdbcType=VARCHAR},
				#{planCode,mode=IN,jdbcType=VARCHAR},
				#{batchNo,mode=IN,jdbcType=VARCHAR},
				#{ccheckcode,mode=OUT,jdbcType=VARCHAR},
				#{cerrorcode,mode=OUT,jdbcType=NUMERIC},
				#{cerrormesg,mode=OUT,jdbcType=VARCHAR}
			)
		}
	</update>
	<select id="getProcessCheckInfoByCode" parameterType="String"
		resultType="cls.pilottery.web.inventory.model.CheckPointInfoVo">
		select cp.cp_no          as cpno,
		       cp.cp_name        as cpname,
		       cp.plan_code      as plancode,
		       gp.full_name      as planName,
		       cp.batch_no       as batchno,
		       cp.warehouse_code as housecode,
		       wh.warehouse_name as housename,
		       cp.cp_date        as cpDate,
		       cp.status         as status,
		       cp.result         as result,
		       cp.cp_admin       as chId,
		       ad.admin_realname as chName,
		       cp.REMARK         as remark
		  from wh_check_point cp
		  left join adm_info ad
		    on cp.cp_admin = ad.admin_id
		  left join game_plans gp
		    on cp.plan_code = gp.plan_code
		  left join wh_info wh
		    on cp.warehouse_code = wh.warehouse_code
		 where cp.cp_no=#{cpNo}
	</select>
	<select id="getAllgameplans" resultType="cls.pilottery.web.goodsreceipts.model.GamePlans">
		select gp.plan_code as planCode, gp.full_name as fullName
		from game_plans gp
	</select>
	<select id="getAllBatchinfo"
		resultType="cls.pilottery.web.goodsreceipts.model.GameBatchImport">
		  select de.batch_no as batchNo
			from GAME_BATCH_IMPORT_DETAIL de
		   where de.STATUS = 1
	</select>
	<update id="checkPointomplete" statementType="CALLABLE"
		parameterType="cls.pilottery.web.inventory.model.CheckPointResult">
		{call p_warehouse_check_step3(
				#{cpNo,mode=IN,jdbcType=VARCHAR},
				#{remark,mode=IN,jdbcType=VARCHAR},
				#{lastStep,mode=IN,jdbcType=NUMERIC},				
				#{cbeforeNum,mode=OUT,jdbcType=NUMERIC},
				#{cbeforeAmount,mode=OUT,jdbcType=NUMERIC},
				#{cafterNum,mode=OUT,jdbcType=NUMERIC},
				#{cafterAmount,mode=OUT,jdbcType=NUMERIC},
				#{cresult,mode=OUT,jdbcType=NUMERIC},
				#{cerrorcode,mode=OUT,jdbcType=NUMERIC},
				#{cerrormesg,mode=OUT,jdbcType=VARCHAR}	
			)
		}
	</update>
	<select id="getCpnormaiList" parameterType="String"
		resultType="cls.pilottery.web.inventory.model.CheckPointResult">
		select 	whcp.plan_code as planCode,
				whcp.sequence_no as seqNo,
				whcp.batch_no as batchNo,
				whcp.trunk_no as trunNo,
				whcp.box_no as boxNo,
				whcp.package_no as packageNo,
				whcp.valid_number as validNumber,
				whcp.packages as pack
		from WH_CP_NOMATCH_DETAIL whcp
		where whcp.cp_no=#{cpNo}
	</select>
	
	<select id="getCheckPointDetailList" parameterType="String"
		resultType="cls.pilottery.web.inventory.model.CheckPointResult">
		 select plan_code as planCode,
		       nvl(bf.sequence_no, af.sequence_no) as seqNo,
		       batch_no as batchNo,
		       trunk_no as trunNo,
		       box_no as boxNo,
		       package_no as packageNo,
		       valid_number as validNumber,
		       nvl(bf.packages, 0) as beforePkg,
		       nvl(af.packages, 0) as afterPkg,
		       nvl(af.packages, 0) - nvl(bf.packages, 0) as diffPkg
		  from wh_check_point_detail_be bf
		  full join wh_check_point_detail af
		 using (cp_no, plan_code, batch_no, valid_number, trunk_no, box_no, package_no)
		 where cp_no=#{cpNo}
		 order by plan_code, batch_no, trunk_no, box_no, package_no
		 
	</select>
    <select id="getCheckPointSum" parameterType="String" resultType="cls.pilottery.web.inventory.model.CheckPointResult">
      select sum(nd.packages * gd.tickets_every_pack) as cbeforeNum, sum(nd.amount)  as cbeforeAmount
	    from wh_check_point_detail_be nd
	    left join game_batch_import_detail gd
	      on (nd.plan_code = gd.plan_code and nd.batch_no = gd.batch_no)
      where 1=1 and nd.cp_no=#{cpNo}
    </select>
   <delete id="deleteChckpoinByCode" parameterType="String">
      delete from wh_check_point p where 1=1 and p.cp_no=#{cpNo}
    </delete>
    <delete id="deleteChckpoinDetailByCode" parameterType="String">
      delete from wh_check_point_detail_be p where 1=1 and p.cp_no=#{cpNo}
    </delete> 
 
    <select id="getGamsListCheck" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo">
    
		select distinct g.plan_code            as planCode,
		       g.full_name            as planName,
		       gb.batch_no            as batchNo,
		       g.ticket_amount        as amount,
		       de.TICKETS_EVERY_GROUP as ticketsEveryGroup from (select *
		  from game_plans p
		 where p.plan_code in (select distinct d.plan_code
		                         from wh_check_point_detail_be d
		                        where d.cp_no =#{cpNo})) g,GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
		                        where 1 = 1
		   and g.plan_code = gb.plan_code
		   and g.plan_code = de.plan_code		      
		   and de.status = 1
		   
    </select>
    <update id="updateWhinfoStatus" parameterType="String" >
	    update wh_info
	   	set status = 1
	 	where warehouse_code in
	       (select c1.warehouse_code
	          from wh_check_point c1
	         where c1.cp_no =#{cpNo})
    </update>
    
    <select id="getCheckInquiryCount" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="Integer">
		  select count(distinct ch.cp_no )
		    from wh_check_point ch, 
		    	 adm_info ad, 
		    	 wh_info wh
		   where 1 = 1
		     and ch.cp_admin = ad.admin_id
		     and wh.warehouse_code = ch.warehouse_code
		<if test="cpDate!=null and cpDate!=''">
			and to_char(ch.cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>
		<if test="result!=null and result!=0">
			and ch.result=#{result}
		</if>
		<if test="institutionCode != null and institutionCode != ''">
				<if test="houseCode != null and houseCode != ''">
					AND ch.warehouse_code = #{houseCode}
				</if>
				<if test="houseCode == null or houseCode == ''">
					and ch.warehouse_code in (select WAREHOUSE_CODE from WH_INFO where org_code = #{institutionCode})
				</if>
		  </if>
		  <if test="institutionCode == null or institutionCode == ''">
		  		<if test="orgCode != '00'">
		  			and ch.warehouse_code in (select WAREHOUSE_CODE from WH_INFO where org_code 
		  				IN (
			  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
			  				UNION 
			  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  					)
		  			)
		  		</if>
		  </if>
	</select>
	<select id="getCheckInquiryList" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="cls.pilottery.web.inventory.model.CheckPointVo">
		select * from (
		select a.*,rownum rn from (
			select distinct ch.cp_no          as cpno,
			       wh.warehouse_name as housecode,
			       ch.cp_name        as cpname,
			       ch.cp_date        as cpdate,
			       ch.status         as status,
			       ch.result         as result,
			       ad.admin_realname as chname
			  from  wh_check_point ch, 
			  		adm_info ad, 
			  		wh_info wh
			 where 1 = 1
			   and ch.cp_admin = ad.admin_id
			   and wh.warehouse_code = ch.warehouse_code
		<if test="cpDate!= null and cpDate!= ''">
			and to_char(ch.cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>
		<if test="result!=null and result!=0">
			and ch.result=#{result}
		</if>
		<if test="institutionCode != null and institutionCode != ''">
				<if test="houseCode != null and houseCode != ''">
					AND ch.warehouse_code = #{houseCode}
				</if>
				<if test="houseCode == null or houseCode == ''">
					and ch.warehouse_code in (select WAREHOUSE_CODE from WH_INFO where org_code = #{institutionCode})
				</if>
		  </if>
		  <if test="institutionCode == null or institutionCode == ''">
		  		<if test="orgCode != '00'">
		  			and ch.warehouse_code in (select WAREHOUSE_CODE from WH_INFO where org_code 
		  				IN (
			  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
			  				UNION 
			  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
		  					)
		  			)
		  		</if>
		  </if>
		order by ch.cp_date desc
	<![CDATA[ ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	
	<select id="getMMCheckInquiryList" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="cls.pilottery.web.inventory.model.MMCheckVO">
		select * from (
		select a.*,rownum rn from (
			SELECT CP_NO cpNo,
			       MANAGER_ID managerId,
			       ADMIN_REALNAME managerName,
			       RESULT result,
			       INV_TICKETS inventoryTickets,
			       CHECK_TICKETS checkTickets,
			       DIFF_TICKETS diffTickets,
			       cp_date cpDate,
			       admin_org orgCode,
			       org_name orgName
			  FROM wh_mm_check 
			  JOIN adm_info ON (MANAGER_ID = ADMIN_ID)
			  JOIN INF_ORGS ON (ADMIN_ORG = ORG_CODE)
			 where 1 = 1
		<if test="cpDate!= null and cpDate!= ''">
			and to_char(cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>
		<if test="result!=null">
			and result=#{result}
		</if>
		<if test="institutionCode != null and institutionCode != ''">
			AND ADMIN_ORG = #{institutionCode}
  		</if>
  		<if test="institutionCode == null or institutionCode == ''">
	  		<if test="orgCode != '00'">
	  			AND ADMIN_ORG IN (
	  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
	  				UNION 
	  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
	  			)
	  		</if>
	  	</if>
		order by cp_date desc
	<![CDATA[ ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	
	<select id="getMMCheckInquiryCount" parameterType="cls.pilottery.web.inventory.form.CheckPointForm"
		resultType="Integer">
			SELECT count(1)
			  FROM wh_mm_check JOIN adm_info ON (MANAGER_ID = ADMIN_ID)
			 where 1 = 1
		<if test="cpDate!= null and cpDate!= ''">
			and to_char(cp_date,'yyyy-mm-dd')=#{cpDate}
		</if>
		<if test="result!=null">
			and result=#{result}
		</if>
		<if test="institutionCode != null and institutionCode != ''">
			AND ADMIN_ORG = #{institutionCode}
  		</if>
  		<if test="institutionCode == null or institutionCode == ''">
	  		<if test="orgCode != '00'">
	  			AND ADMIN_ORG IN (
	  				SELECT org_code FROM ADM_ORG_RELATE WHERE admin_id = #{currentUserId}
	  				UNION 
	  				SELECT admin_org FROM adm_info  WHERE admin_id = #{currentUserId}
	  			)
	  		</if>
	  	</if>
	</select>
	
	<select id="getMMInventoryCheckDetail" parameterType="String" resultType="cls.pilottery.web.inventory.model.MMCheckDetailVO">
			SELECT CP_DETAIL_NO cpDetailNo,
			       CP_NO cpNo,
			       PLAN_CODE planCode,
			       FULL_NAME planName,
			       BATCH_NO batchNo,
			       CASE VALID_NUMBER
			          WHEN 1 THEN TRUNK_NO
			          WHEN 2 THEN BOX_NO
			          WHEN 3 THEN PACKAGE_NO
			       END tagNo,
			       TICKETS tickets,
			       STATUS status
			  FROM wh_mm_check_detail
		 LEFT JOIN game_plans using (PLAN_CODE)
			 WHERE CP_NO = #{_parameter}
	</select>
</mapper>
