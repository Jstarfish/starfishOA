<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cls.pilottery.web.items.dao.ItemReceiptDao">

   	<resultMap type="cls.pilottery.web.items.model.ItemType" id="itemTypeMap">
        <id column="ITEM_CODE" property="itemCode"/>
        <result column="ITEM_NAME" property="itemName"/>
        <result column="BASE_UNIT_NAME" property="baseUnitName"/>
        <result column="STATUS" property="status"/>
    </resultMap>

	<resultMap type="cls.pilottery.web.items.model.ItemReceipt" id="itemReceiptMap">
    	<id column="IR_NO" property="irNo"/>
    	<result column="CREATE_ADMIN" property="createAdmin"/>
    	<result column="ADMIN_REALNAME" property="createAdminName"/><!-- Foreign Table -->
    	<result column="RECEIVE_ORG" property="receiveOrg"/>
    	<result column="ORG_NAME" property="receiveOrgName"/><!-- Foreign Table -->
    	<result column="RECEIVE_WH" property="receiveWh"/>
    	<result column="WAREHOUSE_NAME" property="receiveWhName"/><!-- Foreign Table -->
    	<result column="RECEIVE_DATE" property="receiveDate"/>
    	<result column="REMARK" property="remark"/>
    </resultMap>
    
    <resultMap type="cls.pilottery.web.items.model.ItemReceiptDetail" id="itemReceiptDetailMap">
    	<id column="IR_NO" property="irNo"/>
    	<result column="ITEM_CODE" property="itemCode"/>
    	<result column="ITEM_NAME" property="itemName"/><!-- Foreign Table -->
    	<result column="BASE_UNIT_NAME" property="baseUnit"/><!-- Foreign Table -->
    	<result column="QUANTITY" property="quantity"/>
    </resultMap>
    
    <!-- 获得物品入库记录总数 -->
    <select id="getItemReceiptCount" parameterType="cls.pilottery.web.items.form.ItemReceiptQueryForm" resultType="Integer">
    	SELECT COUNT(1)
		FROM ITEM_RECEIPT
		WHERE 1 = 1
		<if test="receiptCode != null and receiptCode != ''">
            AND IR_NO = #{receiptCode}
        </if>
        
        <if test="receiptDate != null and receiptDate != ''">
            AND TO_CHAR(RECEIVE_DATE, 'yyyy-mm-dd') = #{receiptDate}
        </if>
        
        <if test="warehouseCode != null and warehouseCode != ''">
            AND UPPER(RECEIVE_WH) = #{warehouseCode}
        </if>
        
        <if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        	AND RECEIVE_ORG = #{sessionOrgCode}
        </if>
    </select>
    
    <!-- 获得物品入库记录列表 -->
    <select id="getItemReceiptList" parameterType="cls.pilottery.web.items.form.ItemReceiptQueryForm" resultMap="itemReceiptMap">
		SELECT * FROM (
  			SELECT R.*,ROWNUM AS RN FROM (
    			SELECT I.IR_NO,
    			       I.CREATE_ADMIN,
    			       A.ADMIN_REALNAME,
    			       I.RECEIVE_ORG,
    			       O.ORG_NAME,
    			       I.RECEIVE_WH,
    			       W.WAREHOUSE_NAME,
    			       TO_CHAR(I.RECEIVE_DATE,'yyyy-mm-dd hh24:mm:ss') AS RECEIVE_DATE,
    			       I.REMARK
    			FROM ITEM_RECEIPT I
    			  LEFT JOIN ADM_INFO A ON I.CREATE_ADMIN = A.ADMIN_ID
    			  LEFT JOIN INF_ORGS O ON I.RECEIVE_ORG = O.ORG_CODE 
    			  LEFT JOIN WH_INFO W ON I.RECEIVE_WH = W.WAREHOUSE_CODE
    			WHERE 1 = 1
    			
    			<if test="receiptCode != null and receiptCode != ''">
            		AND IR_NO = #{receiptCode}
        		</if>
        
        		<if test="receiptDate != null and receiptDate != ''">
            		AND TO_CHAR(RECEIVE_DATE, 'yyyy-mm-dd') = #{receiptDate}
        		</if>
        
        		<if test="warehouseCode != null and warehouseCode != ''">
            		AND I.RECEIVE_WH = #{warehouseCode}
        		</if>
        		
        		<if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        			AND I.RECEIVE_ORG = #{sessionOrgCode}
        		</if>
    			ORDER BY I.IR_NO DESC,I.RECEIVE_DATE DESC
   <![CDATA[) R
		) WHERE RN > ${beginNum} AND RN <= ${endNum} ]]>
    </select>
    
    <!-- 获得给定入库单下的所有物品记录 -->
	<select id="getItemReceiptDetails" parameterType="String" resultMap="itemReceiptDetailMap">
    	SELECT D.IR_NO,
    	       D.ITEM_CODE,
    	       I.ITEM_NAME,
    	       I.BASE_UNIT_NAME,
    	       D.QUANTITY
    	FROM ITEM_RECEIPT_DETAIL D
    	  LEFT JOIN ITEM_ITEMS I
    	   ON D.ITEM_CODE = I.ITEM_CODE
    	WHERE IR_NO = #{irNo}
    	ORDER BY D.IR_NO
    </select>
    
</mapper>