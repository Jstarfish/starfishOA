<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.business.dao.AgencyDao">
	<!-- 游戏授权相关 -->
	<resultMap type="cls.pilottery.web.area.model.GameAuth" id="gameResult">
		<id column="GAME_CODE" property="gameCode" />
		<result column="SHORT_NAME" property="name" />
		<result column="AGENCY_CODE" property="agencyCode" />
		<result column="BASIC_TYPE" property="type" />
		<result column="FEE" property="fee" />
		<result column="PAY_COMMISSION_RATE" property="payCommissionRate" />
		<result column="SALE_COMMISSION_RATE" property="saleCommissionRate" />
		<result column="cancel" property="cancelStatus" />
		<result column="ALLOW_PAY" property="payStatus" />
		<result column="ALLOW_SALE" property="sellStatus" />
		<result column="CLAIMING_SCOPE" property="claimingScope" />			
	</resultMap>
	<resultMap type="cls.pilottery.oms.business.model.AgencyBank" id="bankResult">
		<constructor>
	  		<idArg javaType="Long" column="BANK_ID"/>
	  		<arg javaType="String" column="BANK_NAME"/>
	  </constructor>	  
	</resultMap>
	<resultMap type="cls.pilottery.oms.business.model.Agency" id="agencyResult">
		<id column="AGENCY_CODE" property="agencyCode" />		
		<result column="AGENCY_CODE" property="agencyCode"/>
		<result column="AGENCY_NAME" property="agencyName"/>
		<result column="ORG_CODE" property="orgCode"/>
		<result column="ORG_NAME" property="orgName"/>
		<result column="BANK_ID" property="bankId"/>
		<result column="STATUS" property="agencyStatus" javaType="cls.pilottery.oms.business.model.AgencyStatus" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.AgencyStatusTypeHandler" />
		<result column="AGENCY_TYPE" property="agencyType" javaType="cls.pilottery.oms.business.model.AgencyType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.AgencyTypeTypeHandler"/>
		<result column="CREDIT_LIMIT" property="creditLimit" />
		<result column="ACCOUNT_BALANCE" property="accountBalance" />
		<result column="FROZEN_BALANCE" property="frozenBalance"/>
		<result column="CONTACT_PERSON" property="agencyManager"/>
		<result column="BANK_ACCOUNT" property="bankAccount" />
		<result column="TELEPHONE" property="agencyPhone" />
		<result column="ADDRESS" property="agencyAddress" />
		<result column="BUSINESS_BEGIN_TIME" property="startTime" />
		<result column="BUSINESS_END_TIME" property="endTime" />	
		<result column="CONTRACT_NO" property="contractNo" />	
		<association column="BANK_ID" property="agencyBank"  
			jdbcType="NUMERIC" javaType="cls.pilottery.oms.business.model.AgencyBank" resultMap="bankResult" />												
	</resultMap>
	
	<resultMap type="cls.pilottery.oms.business.model.AgencyBank" id="bankResult2">
		<id column="BANK_ID" property="bankId" />		
		<result column="BANK_NAME" property="bankName"/>
	</resultMap>
	
	<select id="getBanks" resultMap="bankResult2">
		SELECT BANK_ID,BANK_NAME FROM INF_BANKS
	</select>
	<select id="getAgencyName" parameterType="java.lang.String" resultType="java.lang.String">
		select distinct t.agency_name from inf_agencys t where t.agency_code = #{agencyCode}
	</select>
	<select id="countAgencyList" parameterType="cls.pilottery.oms.business.form.AgencyForm" resultType="Integer" >
		  SELECT count(inf_agencys.agency_code)
		    FROM inf_agencys left join inf_banks on inf_agencys.bank_id = inf_banks.bank_id
       left join inf_orgs on inf_agencys.org_code = inf_orgs.org_code
		   WHERE 1=1
		    <if test="agencyCode != null and agencyCode != 0">
		        AND inf_agencys.agency_code = ${agencyCode}
		    </if>
		    <if test="agencyName != null and agencyName != ''">
		        AND upper(inf_agencys.agency_name) like upper('%${agencyName}%')
				</if>
		    <if test="agencyStatus != null and agencyStatus.value != 0">
		        AND inf_agencys.status =  ${agencyStatus.value}
			</if>
			<if test="areaCode != null and areaCode != ''">
		        AND inf_orgs.org_code = #{areaCode}
			</if>
			<if test="cuserOrg != '00'">
				AND inf_orgs.org_code = #{cuserOrg}
			</if>
			<if test="agencytype!=null and agencytype!=0">
				and inf_agencys.AGENCY_TYPE=#{agencytype}
			</if>
	</select>
	<select id="queryAgencyList" parameterType="cls.pilottery.oms.business.form.AgencyForm" resultMap="agencyResult">
		SELECT * FROM (
		SELECT a.*,rownum rn FROM (
		  SELECT inf_agencys.*, inf_banks.bank_name,inf_orgs.org_name,
		  		 acc.credit_limit,acc.account_balance,acc.frozen_balance
		    FROM inf_agencys left join inf_banks on inf_agencys.bank_id = inf_banks.bank_id
	   left join acc_agency_account acc on inf_agencys.agency_code = acc.agency_code 
       left join inf_orgs on inf_agencys.ORG_code = inf_orgs.org_code
		   WHERE 1=1
		    <if test="agencyCode != null and agencyCode != 0">
		        AND inf_agencys.agency_code = ${agencyCode}
		    </if>
		    <if test="agencyName != null and agencyName != ''">
		        AND upper(inf_agencys.agency_name) like upper('%${agencyName}%')
			</if>
		    <if test="agencyStatus != null and agencyStatus.value != 0">
		        AND inf_agencys.status =  ${agencyStatus.value}
			</if>
		    <if test="areaCode != null and areaCode != ''">
		        AND inf_orgs.org_code = #{areaCode}
			</if>
			<if test="cuserOrg != '00'">
				AND inf_orgs.org_code = #{cuserOrg}
			</if>
			<if test="agencytype!=null and agencytype != 0">
				and inf_agencys.AGENCY_TYPE=#{agencytype}
			</if>
          <![CDATA[ order by inf_agencys.agency_code ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
		
	<!-- 启用、禁用、清退用这个函数 -->
	<update id="updateStatus" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.Agency" >
		 {call   p_om_agency_status_ctrl(
    	        #{agencyCode,mode=IN,jdbcType=NUMERIC},
    	        #{agencyStatus.value,mode=IN,jdbcType=NUMERIC}, 
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}       
		 	)
		 }
	</update>
	<select id="getSalerTellerByAgencode" parameterType="String" resultType="Integer">
		select count(1)
	  	from INF_TELLERS t
	 	where t.agency_code= #{agencyCode}
	  	 and (t.status = 1 or t.status = 2)
	</select>
	<select id="getSalerTermByAgenCode"  parameterType="String" resultType="Integer">
		select count(1)
	 	 from SALER_TERMINAL t
	 	where t.agency_code = #{agencyCode}
	  	 and (t.status = 1
	    	or t.status = 2)
	</select>
	
	<select id="selectGameFromAgencymap" parameterType="map" resultType="cls.pilottery.web.area.model.GameAuth">
		select game_code as gameCode,
			 org_code as areaCode,
			 SHORT_NAME as name,
			 BASIC_TYPE as type,
			 nvl(c.pay_commission_rate,0) as payCommissionRate,
			 nvl(c.sale_commission_rate,0) as saleCommissionRate,
			 nvl(c.allow_pay,0) as payStatus,
			 nvl(c.allow_sale,0) as sellStatus,
			 nvl(c.allow_cancel,0) as cancelStatus,
			 nvl(c.claiming_scope,0) as claimingScope
		from auth_org a
		join inf_games b using (game_code)
		left join auth_agency c using (game_code)
	   where org_code = #{areaCode}
		 and agency_code =  #{agencyCode}
	</select>
		
	<select id="selectAgencyByCode"  parameterType="String" resultMap="agencyResult">
		SELECT AGENCY_CODE,
		       AGENCY_NAME,
               STORETYPE_ID,
               ORG_CODE,
               a.STATUS,
               AGENCY_TYPE,
               BANK_ID,
               BANK_ACCOUNT,               
               TELEPHONE,
               CONTACT_PERSON,
               a.ADDRESS,
               AGENCY_ADD_TIME,
               BANK_NAME,
               ORG_NAME,
               BANK_ID,
               CONTRACT_NO
		  FROM inf_agencys a
		  LEFT JOIN INF_BANKS USING (BANK_ID)
		  LEFT JOIN INF_ORGS USING (ORG_CODE)
		  LEFT JOIN inf_agency_ext USING (AGENCY_CODE)
		 WHERE AGENCY_CODE = #{code}
	</select>
		<select id="selectGameFromAgency" parameterType="String" resultMap="gameResult">
	  	select
    		A.GAME_CODE as gameCode,
			A.SHORT_NAME as name,
			A.BASIC_TYPE  as type,
			B.PAY_COMMISSION_RATE as payCommissionRate,
			B.SALE_COMMISSION_RATE as   saleCommissionRate,
			B.ALLOW_PAY  as payStatus,
			B.ALLOW_SALE as sellStatus,
			B.ALLOW_CANCEL  as cancelStatus,
			B.CLAIMING_SCOPE as claimingScope
    	from
    		INF_GAMES A, AUTH_AGENCY B
    	where
    		B.AGENCY_CODE = #{agencyCode} AND B.GAME_CODE = A.GAME_CODE
	</select>
	<select id="getRefunInfoByagencycode"  parameterType="String" resultType="cls.pilottery.oms.business.model.AgencyRefunVo">
		SELECT DELETE_NO id,
		       AGENCY_CODE agencyCode,
		       inf_agencys.AGENCY_NAME agencyName,
		       AVAILABLE_CREDIT fundamount,
		       CREDIT_LIMIT credit,
		       OPER_TIME refunddate,
		       OPER_ADMIN operAdmin,
		       CONTACT_PERSON person, 
		       ADDRESS address
		  FROM INF_AGENCY_DELETE 
		  join inf_agencys using (agency_code) 
		 where agency_code = #{_parameter}
	</select>
	<select id="ifAgencyCodeExist" parameterType="java.lang.String" resultType="Integer">
		select count(1) from inf_agencys t where t.agency_code = #{agencyCode} and t.status = 1
	</select>
	
	<select id="getAreaCodeByInstionCode" parameterType="String" resultType="cls.pilottery.web.area.model.Areas">
		select org_CODE as areaCode 
		from inf_agencys sa 
		where sa.AGENCY_CODE=#{agencyCode}
	</select>
	
	 <select id="getGameFromArea" parameterType="String" resultMap="gameResult">
    	select
    		A.GAME_CODE as gameCode,
			A.SHORT_NAME as name,
			A.BASIC_TYPE  as type,
			B.SALE_COMMISSION_RATE as saleCommissionRate,
			B.PAY_COMMISSION_RATE as payCommissionRate,
			B.ALLOW_PAY  as payStatus,
			B.ALLOW_SALE as sellStatus,
			B.ALLOW_CANCEL  as cancel
    	from
    		INF_GAMES A, AUTH_ORG B
    	where
    		B.ORG_CODE = #{areaCodes} AND B.GAME_CODE = A.GAME_CODE
    </select>
	<select id="getOrgListByOrgCode" parameterType="String" resultType="cls.pilottery.oms.business.model.OrgInfo">
		  select org.ORG_CODE as orgCode,org.ORG_NAME as orgName
		    from INF_ORGS org
		   where 1 = 1 
		     and org_status =1 
		   <if test="_parameter !='00'">
		    	and org.ORG_CODE=#{_parameter}
		   </if>
	</select>
	
	
	<select id="getTerminalByAgencyCode" parameterType="String" resultType="cls.pilottery.oms.business.model.Terminal">
		select t.terminal_code as terminalCode, 
			   t.mac_address as macAddress,
			   t.status as status
  			FROM SALER_TERMINAL t
  			left join inf_agencys a
  		  on a.agency_code = t.agency_code
   			where a.agency_code = #{agencyCode}
	</select>
	
	<select id="getTellerByAgencyCode" parameterType="String" resultType="cls.pilottery.web.teller.model.Teller">
		select t.teller_code as tellerCode,
      		   t.teller_name as tellerName,
       		   t.teller_type as newTellerType,
       		   t.status as newTellerStatus
        FROM INF_TELLERS t
        left join inf_agencys a
        on a.agency_code = t.agency_code
         where a.agency_code = #{agencyCode}
	</select>

	<update id="clearOutlet" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.form.OutletClearInfo" >
		 {call p_agency_quit(
   	        #{agencyCode,mode=IN,jdbcType=NUMERIC},
   	        #{userId,mode=IN,jdbcType=NUMERIC}, 
   	        #{balance,mode=OUT,jdbcType=NUMERIC},
   	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
   	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}       
		 )}
	</update>
</mapper>
