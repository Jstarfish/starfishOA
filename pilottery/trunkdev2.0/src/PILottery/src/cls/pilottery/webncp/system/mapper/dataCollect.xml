<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.webncp.system.dao.DataCollectDao">

	<select id="getLogByTermCode" parameterType="cls.pilottery.webncp.system.model.Request9001Model"
		resultType="cls.pilottery.webncp.system.model.Response9001Model">
		select * from (
			select SYS_CLOG_SEQ as reqSeq,
				   SYS_CLOG_APPLY_TYPE as reqLogType,
				   SYS_CLOG_APPLY_ARG1 as reqPara1
			from SYS_CLOG_INFO where TERMINAL_CODE = to_number(#{terminal_code})
			and SYS_CLOG_APPLY_STATUS = 1 order by SYS_CLOG_APPLY_TIME
		<![CDATA[	) where rownum < 2 ]]>
		 
	</select>

	<update id="updateLogStatus" parameterType="cls.pilottery.webncp.system.model.Request9002Model">
		UPDATE SYS_CLOG_INFO SET
			   SYS_CLOG_APPLY_STATUS=#{apply_status},
		       SYS_CLOG_SUCC_TIME=sysdate,
			   SYS_CLOG_UPLOAD_FILE=#{fileName}
		where SYS_CLOG_SEQ = #{reqSeq}
	</update>
	
	<update id="outletTopUp" statementType="CALLABLE" parameterType="cls.pilottery.webncp.system.model.Request8001Model">
		{call p_outlet_topup(
			#{agencyCode,mode=IN,jdbcType=VARCHAR},
			#{applyAmount,mode=IN,jdbcType=NUMERIC},
			#{managerId,mode=IN,jdbcType=NUMERIC},
			#{transPwd,mode=IN,jdbcType=VARCHAR},
			#{flowCode,mode=OUT,jdbcType=VARCHAR},
			#{beforeAmount,mode=OUT,jdbcType=NUMERIC},
			#{afterAmount,mode=OUT,jdbcType=NUMERIC},
			#{errorCode,mode=OUT,jdbcType=NUMERIC},
			#{errorMesg,mode=OUT,jdbcType=VARCHAR}
			)
		}
	</update>
	<select id="validateCollector" resultType="int" parameterType="cls.pilottery.webncp.system.model.Request8004Model">
		select count(1) from inf_market_admin where market_admin = #{managerId} and trans_pass = #{transPwd}
	</select>
	
	<select id="getAllowAmount" resultType="long" parameterType="cls.pilottery.webncp.system.model.Request8004Model">
		select CREDIT_LIMIT+ACCOUNT_BALANCE allowAmount from ACC_MM_ACCOUNT where MARKET_ADMIN = #{managerId}
	</select>
	
	<select id="getTopupRecordCount" resultType="int" parameterType="cls.pilottery.webncp.system.model.Request8004Model">
		SELECT count(1)
      FROM fund_charge_center
     WHERE OPER_ADMIN = #{managerId} AND account_type = 2
	</select>
	
	<select id="getTopupRecord" resultType="cls.pilottery.webncp.system.model.Response8004Record" parameterType="cls.pilottery.webncp.system.model.Request8004Model">
		select agencyCode,applyAmount,applyTime from (
		    select tab.*,rownum rn from (
		        SELECT ao_code agencyCode, 
		               oper_amount applyAmount, 
		               to_char(oper_time,'yyyy-mm-dd hh24:mi:ss') applyTime
		          FROM fund_charge_center
		         WHERE OPER_ADMIN = #{managerId} AND account_type = 2
		         order by applyTime desc
		    ) tab
		) where rn between #{pageSize}*(#{pageIndex}-1) and #{pageSize}*#{pageIndex}
	</select>
	
	<select id="validateMMLoginPwd" resultType="int" parameterType="map">
		select count(1) from adm_info where admin_password = #{loginPwd} and admin_id = #{userId}
	</select>
	
	<select id="getParamValueById" resultType="String" parameterType="int">
		select SYS_DEFAULT_VALUE from sys_parameter where SYS_DEFAULT_SEQ = #{_parameter}
	</select>
	
	<update id="outletWithdrawApp" statementType="CALLABLE" parameterType="cls.pilottery.webncp.system.model.Request8006Model">
		{call p_outlet_withdraw_app(
			#{agencyCode,mode=IN,jdbcType=VARCHAR},
			#{transPwd,mode=IN,jdbcType=VARCHAR},
			#{applyAmount,mode=IN,jdbcType=NUMERIC},
			#{managerId,mode=IN,jdbcType=NUMERIC},
			#{flowCode,mode=OUT,jdbcType=VARCHAR},
			#{errorCode,mode=OUT,jdbcType=NUMERIC},
			#{errorMesg,mode=OUT,jdbcType=VARCHAR}
			)
		}
	</update>
	
	<update id="outletWithdrawApprove" statementType="CALLABLE" parameterType="cls.pilottery.webncp.system.model.Request8006Model">
		{call p_withdraw_approve_mm(
			#{flowCode,mode=IN,jdbcType=VARCHAR},
			#{errorCode,mode=OUT,jdbcType=NUMERIC},
			#{errorMesg,mode=OUT,jdbcType=VARCHAR}
			)
		}
	</update>
	
	<select id="validateOutletOldPwd" resultType="int" parameterType="cls.pilottery.webncp.system.model.Request8007Model">
		select count(1) from inf_agencys where agency_code = #{agencyCode} and trade_pass = #{oldPwd}
	</select>
	
	<update id="updateOutletTransPwd"  parameterType="cls.pilottery.webncp.system.model.Request8007Model">
		update inf_agencys set trade_pass = #{newPwd},LOGIN_PASS=#{newPwd} where agency_code = #{agencyCode}
	</update>
	
</mapper>
