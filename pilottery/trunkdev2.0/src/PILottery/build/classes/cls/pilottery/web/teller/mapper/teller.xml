<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.teller.dao.TellerDao">
	
	<resultMap type="cls.pilottery.web.teller.model.Teller" id="tellerResult">
		<id column="TELLER_CODE" property="tellerCode" />		
		<result column="TELLER_NAME" property="tellerName" />
		<!--复杂类型  -->
		<result column="TELLER_TYPE" property="tellerType" javaType="cls.pilottery.web.teller.model.TellerType" jdbcType="NUMERIC" typeHandler="cls.pilottery.web.teller.model.TellerTypeTypeHandler"/>
		<result column="STATUS" property="tellerStatus" javaType="cls.pilottery.web.teller.model.TellerStatus" jdbcType="NUMERIC" typeHandler="cls.pilottery.web.teller.model.TellerStatusTypeHandler" />
		<result column="PASSWORD" property="tellerPassword" />
		<result column="LATEST_TERMINAL_ID" property="latestTerminalId" />
		<result column="LATEST_SIGN_ON" property="latestLogOnTime" />
		<result column="LATEST_SIGN_OFF" property="latestLogOffTime" />
		<result column="teller_code_tochar" property="tellerCodeToChar" />
		<result column="agency_code" property="agencyCode" />
		<result column="agency_name" property="agencyName" />
	</resultMap>
	
	<resultMap type="cls.pilottery.oms.business.model.AreaParent" id="parentResult">
		<constructor>
	  		<idArg javaType="Long" column="AGENCY_CODE"/>
	  		<arg javaType="String" column="AGENCY_NAME"/>
	  </constructor>	  
	</resultMap>
	
	<update id="insertTeller" statementType="CALLABLE" parameterType="cls.pilottery.web.teller.model.Teller">
		 {call p_teller_create(
		 	#{tellerCode,mode=IN,jdbcType=VARCHAR},
		 	#{agencyCode,mode=IN,jdbcType=VARCHAR},
		 	#{tellerName,mode=IN,jdbcType=VARCHAR},
		 	#{tellerType,mode=IN,jdbcType=NUMERIC,javaType=cls.pilottery.web.teller.model.TellerType,typeHandler=cls.pilottery.web.teller.model.TellerTypeTypeHandler},
		 	#{tellerStatus,mode=IN,jdbcType=NUMERIC,javaType=cls.pilottery.web.teller.model.TellerStatus,typeHandler=cls.pilottery.web.teller.model.TellerStatusTypeHandler},		 	
		 	#{tellerPassword,mode=IN,jdbcType=VARCHAR},	
		 	#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	    #{c_errmsg,mode=OUT,jdbcType=VARCHAR},	 	
		 	#{tellerCode,mode=OUT,jdbcType=NUMERIC} 
		  )	
		 }	
	</update>
	
	<select id="countTellerList" parameterType="cls.pilottery.web.teller.form.TellerForm" resultType="Integer" >
	  SELECT  count(1)
      FROM inf_tellers 
      join INF_AGENCYS using (Agency_Code)
      where 1=1
      	  <if test="cuserOrg != '00'">
      	  	   AND org_code = #{cuserOrg}
      	  </if>
		  <if test="areaCode != null and areaCode != ''">
			   AND org_code = #{areaCode}
		  </if>
          <if test="queryType == 1 and tellerQueryString != null and tellerQueryString != '' ">
 			   and agency_code = ${tellerQueryString}
		  </if>
		  <if test="queryType == 2 and tellerQueryString != null and tellerQueryString != ''">
		   	   and agency_name like '%${tellerQueryString}%'
		  </if>
          <if test="queryType == 3 and tellerQueryString != null and tellerQueryString != ''">
		 	   and teller_code = ${tellerQueryString}
		  </if>
		  <if test="queryType == 4 and tellerQueryString != null and tellerQueryString != ''">
		       and teller_name like '%${tellerQueryString}%'
		  </if>
		  <if test="tellerType != null and tellerType.value != 0">
		 	   and teller_type = ${tellerType.value}
		  </if>
		  <if test="tellerStatus != null and tellerStatus.value != 0">
		 	   and inf_tellers.STATUS = ${tellerStatus.value}
		  </if>
	  </select>
	
		<select id="queryTellerList" parameterType="cls.pilottery.web.teller.form.TellerForm" resultMap="tellerResult">
	    select * from (
			select a.*,rownum rn from (
      			SELECT 
		            inf_tellers.teller_code,
		            agency_code,
		            inf_tellers.teller_name, 
		            inf_tellers.teller_type, 
		            inf_tellers.status, 
		            inf_tellers.password, 
		            inf_tellers.latest_terminal_code, 
		            inf_tellers.latest_sign_on_time, 
		            inf_tellers.latest_sign_off_time, 
		            inf_tellers.is_online,
		        	INF_AGENCYS.AGENCY_NAME,
	        		to_char(LATEST_SIGN_ON_TIME,'YYYY-MM-DD HH24:MI:SS') as LATEST_SIGN_ON,
		      		to_char(LATEST_SIGN_OFF_TIME,'YYYY-MM-DD HH24:MI:SS') as LATEST_SIGN_OFF
		    	FROM inf_tellers 
      			join INF_AGENCYS using (agency_Code)
		    WHERE 1=1 
		  <if test="cuserOrg != '00'">
      	  	   AND org_code = #{cuserOrg}
      	  </if>
		  <if test="areaCode != null and areaCode != ''">
			   AND org_code = #{areaCode}
		  </if>
          <if test="queryType == 1 and tellerQueryString != null and tellerQueryString != ''">
 			   and agency_code = ${tellerQueryString}
		  </if>
		  <if test="queryType == 2 and tellerQueryString != null and tellerQueryString != ''">
		   	   and agency_name like '%${tellerQueryString}%'
		  </if>
          <if test="queryType == 3 and tellerQueryString != null and tellerQueryString != ''">
		 	   and teller_code = ${tellerQueryString}
		  </if>
		  <if test="queryType == 4 and tellerQueryString != null and tellerQueryString != ''">
		       and teller_name like '%${tellerQueryString}%'
		  </if>
		  <if test="tellerType != null and tellerType.value != 0">
		 	   and teller_type = ${tellerType.value}
		  </if>
		  <if test="tellerStatus != null and tellerStatus.value != 0">
		 	   and inf_tellers.STATUS = ${tellerStatus.value}
		  </if>
		  <![CDATA[ order by TELLER_CODE) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	
	<!-- 启用、禁用、清退用这个函数 -->
	<update id="updateStatus" statementType="CALLABLE" parameterType="cls.pilottery.web.teller.model.Teller" >
		{call p_teller_status_change(
			#{tellerCode,mode=IN,jdbcType=NUMERIC},
			#{tellerStatus.value,mode=IN,jdbcType=NUMERIC},
			#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	    #{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		)}
	</update>
	
	<update id="deleteTeller" parameterType="cls.pilottery.web.teller.model.Teller">
		UPDATE inf_tellers SET STATUS = 3 WHERE TELLER_CODE = #{tellerCode} 
	</update>
	
	<select id="selectTellerByCode" parameterType="long" resultMap="tellerResult">
		SELECT 
	      inf_tellers.*, to_char(inf_tellers.teller_code,'000000') teller_code_tochar,
	      INF_AGENCYS.AGENCY_NAME,
	      to_char(LATEST_SIGN_ON_TIME,'YYYY-MM-DD HH24:MI:SS') as LATEST_SIGN_ON,
	      to_char(LATEST_SIGN_OFF_TIME,'YYYY-MM-DD HH24:MI:SS') as LATEST_SIGN_OFF
	    FROM
	      inf_tellers, INF_AGENCYS
	    WHERE inf_tellers.TELLER_CODE =#{code}  AND inf_tellers.AGENCY_CODE = INF_AGENCYS.AGENCY_CODE
	</select>
	
	<update id="updateTeller" parameterType="cls.pilottery.web.teller.model.Teller">
		UPDATE inf_tellers 
		   SET TELLER_NAME 	= #{tellerName},
			   TELLER_TYPE 	= #{tellerType.value}	
			<if test="isLogin == -1">
				,IS_ONLINE = 0
			</if>
		 WHERE TELLER_CODE = #{tellerCode}
	</update>
	
	<update id="resetPassword" parameterType="cls.pilottery.web.teller.model.Teller" >
		UPDATE inf_tellers 
		   SET PASSWORD = #{tellerPassword}				
		 WHERE TELLER_CODE = #{tellerCode}
	</update>
	
    <select id="getRecomandNum" resultType="String">
		<![CDATA[   select min(cnt) from (
				select rownum cnt,teller_code
				from inf_tellers order by teller_code) 
				where cnt<>teller_code
		]]>
    </select>
</mapper>
