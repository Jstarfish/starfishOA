<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.taishan.system.dao.UserDao">
	<resultMap type="cls.taishan.system.model.User" id="user">
		<id column="admin_id" property="id" />
		<result column="admin_realname" property="realName" />
		<result column="admin_login" property="loginId" />
		<result column="admin_password" property="password" />
		<result column="admin_gender" property="gender" />
		<result column="admin_email" property="email" />
		<result column="admin_birthday" property="birthday" />
		<result column="ADMIN_MOBILE" property="phone" />
		<result column="admin_address" property="address" />
		<result column="admin_status" property="status" />
		<result column="admin_create_time" property="createTime" />
		<result column="create_admin_id" property="createAdminId" />
		<result column="admin_remark" property="remark" />
		<result column="admin_org" property="orgCode" />
		<result column="org_name" property="orgName" />
	</resultMap>

	<!-- 关联查询 -->
	<resultMap type="cls.taishan.system.model.User" id="userRoleMap" extends="user">
		<!-- <collection property="roleList" ofType="cls.taishan.system.model.Role" 
			column="ADMIN_ID" select="selectUserRole"/> -->
	</resultMap>

	<!-- 用户登陆 -->
	<!-- <select id="getUserByCondition" parameterType="cls.taishan.system.form.UserForm" resultMap="user">
		select a.admin_id,
		       a.admin_realname,
		       a.admin_login,
		       a.admin_password,
		       a.admin_gender,
		       a.admin_email,
		       a.admin_birthday,
		       a.ADMIN_MOBILE,
		       a.admin_address,
		       a.admin_status,
		       a.admin_create_time,
		       a.create_admin_id,
		       a.admin_remark,
		       a.admin_org,
		       b.org_name,
		       c.role_id
		  from adm_info a
		  left join inf_orgs b
		    on (a.admin_org = b.org_code)
		  left join adm_role_admin c
		    on (a.admin_id = c.admin_id)
		 <if test="loginId != null and loginId != ''">
			and a.admin_login = #{loginId}
		 </if>
		 <if test="status != null and status != ''">
			and a.admin_status = #{status}
		 </if>
		 <if test="userId != null">
			and a.admin_id = #{userId}
		 </if>
	</select> -->
	
 	<select id="getUserByCondition" parameterType="cls.taishan.system.form.UserForm" resultMap="user">
		select admin_id,
		       admin_realname,
		       admin_login,
		       admin_password,
		       admin_gender,
		       admin_email,
		       to_char(admin_birthday,'yyyy-MM-dd hh:mm:ss') admin_birthday,
		       ADMIN_MOBILE,
		       admin_address,
		       admin_status,
		       to_char(admin_create_time,'yyyy-MM-dd hh:mm:ss') admin_create_time,
		       create_admin_id,
		       admin_remark,
		       admin_org,
		       org_name
		  from adm_info
		  join inf_orgs on (admin_org = org_code)
		 where 1=1 
		 <if test="loginId != null and loginId != ''">
			and admin_login = #{loginId}
		 </if>
		 <if test="status != null and status != 0">
			and admin_status = #{status}
		 </if>
		 <if test="userId != null">
			and admin_id = #{userId}
		 </if>
	</select> 

	<select id="getAllUsers" parameterType="cls.taishan.system.form.UserForm" resultMap="user">
		select admin_id,
		       admin_realname,
		       admin_login,
		       admin_password,
		       admin_gender,
		       admin_email,
		       to_char(admin_birthday,'yyyy-MM-dd hh:mm:ss') admin_birthday,
		       ADMIN_MOBILE,
		       admin_address,
		       admin_status,
		       to_char(admin_create_time,'yyyy-MM-dd hh:mm:ss') admin_create_time,
		       create_admin_id,
		       admin_remark,
		       admin_org,
		       org_name
		  from adm_info
		  join inf_orgs on (admin_org = org_code)
		where 1=1 
		<if test="loginId != null and loginId != ''">
			and admin_login like '%${loginId}%' 
		</if>
		<if test="status != null and status != ''">
			and admin_status = #{status}
		</if>
		<if test="orgCode != null and orgCode != ''">
			and admin_org = #{orgCode}
		</if>
		order by admin_id 
	</select>
	
	<select id="getAllOrgs" resultType="cls.taishan.system.model.OrgInfo">
		select org_code orgCode,org_name orgName from inf_orgs
	</select>
	
	<update id="updatePwd" parameterType="cls.taishan.system.model.User">
		update adm_info set admin_password = #{password} where admin_id = #{id}
	</update>
	
	<update id="updateUserStatus" parameterType="cls.taishan.system.model.User">
		update adm_info set admin_status = #{status} where admin_id = #{id}
	</update>
	
	<insert id="saveUser" parameterType="cls.taishan.system.model.User">
		insert into adm_info
		    (admin_id,
		     admin_realname,
		     admin_login,
		     admin_password,
		     admin_gender,
		     ADMIN_MOBILE,
		     admin_org,
		     admin_address,
		     admin_remark,
		     admin_status,
		     admin_create_time,
		     create_admin_id)
		  values
		    (SEQ_ADM_ID.nextval,
		     #{realName},
		     #{loginId},
		     #{password},
		     #{gender},
		     #{phone},
		     #{orgCode},
		     #{address},
		     #{remark},
		     1,
		     sysdate,
		     #{createAdminId})
	</insert>
	<update id="updateUser" parameterType="cls.taishan.system.model.User">
		update adm_info 
		   set admin_realname = #{realName},
		   	   admin_gender = #{gender},
		   	   ADMIN_MOBILE = #{phone},
		   	   admin_org = #{orgCode},
		   	   admin_address = #{address},
		   	   admin_remark = #{remark}
		 where admin_id = #{id} 
	</update>

	<select id="getRoleByUser" parameterType="Long" resultType="int">
		select count(*) from adm_role_admin where admin_id = #{id}
	</select>
	
	<select id="getUserIdByName" parameterType="String" resultType="Long">
		select t.admin_id id from adm_info t where t.admin_login = #{loginId}
	</select>
	
	<select id="getNewUserId" resultType="Long">
		select max(admin_id) from adm_info
	</select>
	
	<delete id="deleteRoleByUser" parameterType="Long">
		delete from adm_role_admin where admin_id = #{id}
	</delete>
	
	<insert id="addUserRole" parameterType="cls.taishan.system.model.User">
		insert into adm_role_admin (ADMIN_ID,ROLE_ID)values (#{id},#{roleId})
	</insert>
	
	<select id="getUserRoles" parameterType="Long" resultType="cls.taishan.system.model.Role">
		select t.role_id roleId from ADM_ROLE_ADMIN t where t.admin_id = #{id} 
	</select>
	
</mapper>
