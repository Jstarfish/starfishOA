<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cls.pilottery.webncp.system.dao.MessageServiceDao">
	<resultMap id="tPayoutMap" type="cls.pilottery.webncp.system.model.Response4103Model">
		<result column="winAmount" property="winAmount" />
		<result column="winTickets" property="winTickets" />
		<collection property="winningList" ofType="cls.pilottery.webncp.system.model.Response4103Record">
			<result column="ticketCode" property="ticketCode" />
			<result column="payStatus" property="payStatus" />
			<result column="amount" property="amount" />
		</collection>
	</resultMap>
	
	<select id="getIssueCount4001" parameterType="map" resultType="Integer">
		SELECT count(t.issue_number) AS issuNum
		FROM iss_game_issue t
		WHERE 1 = 1
		<if test="perdIssue != null and perdIssue != ''">
			AND t.issue_number = #{perdIssue}
		</if>
		AND t.game_code = #{gameCode}
	</select>

	<select id="getDefaultIssue4001" parameterType="String"
		resultType="String">
		SELECT max(t.issue_number) AS current_issue_num
		FROM iss_prize t
		WHERE t.game_code = #{gameCode}
	</select>

	<select id="getDrawInfo4001" parameterType="Map"
		resultType="cls.pilottery.webncp.system.vo.Response4001Vo">
		SELECT t.game_code AS gameCode
		, t.issue_number AS perdIssue
		, t.final_draw_number AS drawCode
		, to_char(t.real_reward_time, 'YYYY-MM-DD HH24:MI:SS') AS drawTime
		FROM iss_game_issue t
		WHERE t.issue_status >= 13
		<if test="gameCode != null and gameCode != ''">
			AND t.game_code = #{gameCode}
		</if>
		<if test="perdIssue != null and perdIssue != ''">
			AND t.issue_number = #{perdIssue}
		</if>
		ORDER BY t.issue_number DESC
	</select>

	<select id="getPrizeLevelInfo4001" parameterType="Map"
		resultType="cls.pilottery.webncp.system.model.Response4001Record">
		SELECT t.prize_level AS winLevel
		, t.prize_name AS winName
		, t.prize_count AS saleCount
		, t.single_bet_reward AS singleBet
		, (t.prize_count * t.single_bet_reward) AS winSum
		FROM iss_prize t
		LEFT JOIN gp_prize_rule r ON t.game_code = r.game_code AND t.prize_level =
		r.prule_level
		WHERE t.issue_number = #{perdIssue}
		AND t.game_code = #{gameCode}
		ORDER BY r.disp_order
	</select>

	<select id="getIssueCount4002" parameterType="Map" resultType="Integer">
		SELECT count(t.issue_number) AS issuNum
		FROM iss_game_issue t
		WHERE 1 = 1
		<if test="perdIssue != null and perdIssue != ''">
			AND t.issue_number = #{perdIssue}
		</if>
		AND t.game_code = #{gameCode}
	</select>

	<select id="getDefaultIssue4002" parameterType="Map" resultType="String">
		SELECT max(t.issue_number)
		FROM mis_agency_win_stat t
		WHERE t.game_code = #{gameCode}
		AND t.agency_code = #{agencyCode}
	</select>

	<select id="getDrawInfo4002" parameterType="Map"
		resultType="cls.pilottery.webncp.system.vo.Response4002Vo">
		SELECT DISTINCT t.game_code AS gameCode
		, t.issue_number AS perdIssue
		, a.final_draw_number AS drawCode
		FROM mis_agency_win_stat t
		JOIN iss_game_issue a ON t.issue_number = a.issue_number AND t.game_code =
		a.game_code
		WHERE t.game_code = #{gameCode}
		AND t.agency_code = #{agencyCode}
		AND t.issue_number = #{perdIssue}
	</select>

	<select id="getPrizeLevelInfo4002" parameterType="Map"
		resultType="cls.pilottery.webncp.system.model.Response4002Record">
		SELECT t.prize_level AS winLevel
		, t.winning_count AS saleCount
		, t.single_bet_reward AS singleBet
		, t.prize_name AS winName
		, (t.winning_count * t.single_bet_reward) AS winSum
		FROM mis_agency_win_stat t
		LEFT JOIN gp_prize_rule r ON t.game_code = r.game_code AND t.prize_level =
		r.prule_level
		WHERE t.game_code = #{gameCode}
		AND t.agency_code = #{agencyCode}
		AND t.issue_number = #{perdIssue}
		ORDER BY r.disp_order
	</select>

	<select id="getAreaCode4003" parameterType="String" resultType="String">
		SELECT t.org_code AS areaCode
		FROM inf_agencys t
		WHERE t.agency_code = #{agencyCode}
	</select>

	<select id="getNoticeList4003" parameterType="Map"
		resultType="cls.pilottery.webncp.system.model.Response4003Record">
		SELECT * FROM (
		SELECT rownum rn, R.* FROM (
		SELECT t.notice_id AS notCode
		, to_char(t.create_time, 'YYYY-MM-DD HH24:MI:SS') AS sendTime
		, t.title AS title
		FROM msg_agency_brocast t
		WHERE t.notice_id IN (
		SELECT a.notice_id
		FROM msg_agency_brocast_detail a
		WHERE a.cast_code = #{areaCode}
		OR a.cast_code = #{agencyCode}
		OR a.cast_code = 0
		)
		ORDER BY t.create_time DESC
		<![CDATA[ 
		    ) R
		) WHERE rn > #{beginNum} AND rn <= #{endNum}
		]]>
	</select>
	
	<select id="getNoticeList4003Count" parameterType="Map" resultType="int">
		SELECT count(1)
		FROM msg_agency_brocast t
		WHERE t.notice_id IN (
			SELECT a.notice_id
			FROM msg_agency_brocast_detail a
			WHERE a.cast_code = #{areaCode}
			OR a.cast_code = #{agencyCode}
			OR a.cast_code = 0
		)
	</select>

	<select id="getNotice4004" parameterType="String"
		resultType="cls.pilottery.webncp.system.model.Response4004Model">
		SELECT t.notice_id AS notCode
		, t.send_time AS sendTime
		, t.title AS title
		, t.content AS content
		FROM MSG_AGENCY_BROCAST t
		WHERE t.notice_id = #{notCode}
	</select>

	<select id="getIssueCount4005" parameterType="Map" resultType="Integer">
		SELECT count(t.issue_number) AS issuNum
		FROM iss_game_issue t
		WHERE t.draw_state = 16
		<if test="perdIssue != null and perdIssue != ''">
			AND t.issue_number = #{perdIssue}
		</if>
		AND t.game_code = #{gameCode}
	</select>

	<select id="getDrawNumber4005" parameterType="Map"
		resultType="cls.pilottery.webncp.system.model.Response4005Record">
		SELECT * FROM (
		SELECT rownum rn, A.* FROM (
		SELECT t.game_code AS gameCode
		, t.issue_number AS perdIssue
		, t.final_draw_number AS drawNumber
		, to_char(t.real_reward_time, 'YYYY-MM-DD HH24:MI:SS') AS drawTime
		FROM iss_game_issue t
		WHERE 1 = 1
		AND t.draw_state = 16
		AND t.game_code = #{gameCode}
		<if test="perdIssue != null and perdIssue != ''">
			<![CDATA[ AND t.issue_number <= #{perdIssue}
			]]>
        </if> 
        ORDER BY t.issue_number DESC  
		<![CDATA[ 
		    ) A
		) WHERE rn > #{beginNum} AND rn <= #{endNum}
		]]>
	</select>
	
	<select id="getNewNoticeId4009" parameterType="String" resultType="String">
		SELECT MAX (a.NOTICE_ID) noticeId
		  FROM MSG_AGENCY_BROCAST_DETAIL a
		 WHERE    a.CAST_CODE = (select org_code from inf_agencys where agency_code = #{agencyCode} )
		       OR a.CAST_CODE = #{agencyCode}
		       OR a.CAST_CODE = 0
	</select>
	
	<select id="getOrgCodeByAgency" resultType="String" parameterType="String">
		select  ORG_CODE 
		  from  INF_AGENCYS 
		 where  AGENCY_CODE = #{agencyCode}
	</select>
	
	<select id="getLastDrawInfo4090" parameterType="Map" resultType="cls.pilottery.webncp.system.model.Response4090Model">
		SELECT t.game_code AS gameCode
		, t.issue_number AS perdIssue
		, t.final_draw_number AS drawCode
		, to_char(t.real_reward_time, 'YYYY-MM-DD HH24:MI:SS') AS drawTime
		FROM iss_game_issue t
		WHERE t.issue_status = 13
		  AND t.game_code = #{gameCode}
		<if test="perdIssue != null and perdIssue != ''">
			AND t.issue_number = #{perdIssue}
		</if>
		<if test="perdIssue == null or perdIssue == ''">
			AND t.issue_number = (select max(issue_number) from iss_game_issue where game_code = #{gameCode} and issue_status = 13)
		</if>
	</select>
	
	<select id="getLastDrawInfo4091" parameterType="Map" resultType="cls.pilottery.webncp.system.vo.Response4001Vo">
		select * from (
			SELECT t.game_code AS gameCode
			, t.issue_number AS perdIssue
			, t.final_draw_number AS drawCode
			, to_char(t.real_reward_time, 'YYYY-MM-DD HH24:MI:SS') AS drawTime
			FROM iss_game_issue t
			WHERE t.issue_status = 13
			AND t.game_code = #{gameCode}
			<if test="perdIssue != null and perdIssue != ''">
				AND t.issue_number = #{perdIssue}
			</if>
			ORDER BY t.issue_number DESC
		<![CDATA[ ) where rownum <=50 ]]>
	</select>
	
	<select id="getOutletDealFlow" parameterType="Map" resultType="cls.pilottery.webncp.system.model.Response4101Record">
		select 	to_char(deal_time,'yyyy-mm-dd hh24:mi:ss') time,
				deal_type dealtype,
				agency_code outletCode,
				AMOUNT amount,
				COMM comm,
				TICKETS tickets,
				flow_no dealNo 
		from (
		    select SALE_TIME deal_time,
                   agency_code,
                   1 as deal_type,
                   sum(SALE_AMOUNT) AMOUNT,
                   sum(COMM_AMOUNT) COMM,
                   sum(TICKETS) tickets,
                   SGR_NO flow_no
              from flow_sale
             WHERE agency_code = #{outletCode}
            <![CDATA[ and SALE_TIME >= to_date(#{queryDate},'yyyymmdd') and sale_time < to_date(#{queryDate},'yyyymmdd')+1]]>
             group by SALE_TIME,agency_code,SGR_NO
            union all
            select CANCEL_TIME deal_time,
                   agency_code,
                   3 as deal_type,
                   sum(SALE_AMOUNT) AMOUNT,
                   sum(COMM_AMOUNT) COMM,
                   sum(TICKETS) tickets,
                   SGI_NO flow_no
              from FLOW_CANCEL
             WHERE agency_code = #{outletCode}
             <![CDATA[ and CANCEL_TIME >= to_date(#{queryDate},'yyyymmdd') and CANCEL_TIME < to_date(#{queryDate},'yyyymmdd')+1]]>
             group by CANCEL_TIME,agency_code,SGI_NO
            union all
            select a.pay_time deal_time, 
	             PAY_AGENCY agency_code, 
	             2 as deal_type, 
	             SUM(PAY_AMOUNT) AMOUNT,
	             SUM(COMM_AMOUNT) COMM, 
	             COUNT(1) tickets,
	             DJXQ_NO flow_no
              from FLOW_PAY a
              join SALE_PAID_DETAIL b using (PAY_FLOW)
             WHERE PAY_AGENCY = #{outletCode}
             <![CDATA[ and a.pay_time >= to_date(#{queryDate},'yyyymmdd') and a.pay_time < to_date(#{queryDate},'yyyymmdd')+1]]>
             group by a.pay_time,PAY_AGENCY,DJXQ_NO
         ) ORDER BY time desc
	</select>
	<select id="getSaleFlowDetail" parameterType="string" resultType="cls.pilottery.webncp.system.model.Response4102Record">
		select plan_code planCode,SHORT_NAME planName,sum(tickets) tickets,sum(amount) amount
		 from WH_GOODS_RECEIPT_DETAIL 
		 join GAME_PLANS using (plan_code)
		 where sgr_no = #{_parameter}
		group by SHORT_NAME,plan_code
		order by SHORT_NAME,plan_code
	</select>
	<select id="getPayoutFlowDetail" parameterType="string" resultType="cls.pilottery.webncp.system.model.Response4102Record">
		select plan_code planCode,
            SHORT_NAME planName,
            count(1) tickets,
            sum(reward_amount) amount
        from SALE_PAID_DETAIL 
        join game_plans using (plan_code)
        WHERE paid_status = 1 and DJXQ_NO = #{_parameter} 
        group by plan_code,short_name
	</select>
	<select id="getCancelFlowDetail" parameterType="string"	resultType="cls.pilottery.webncp.system.model.Response4102Record">
		select plan_code planCode,SHORT_NAME planName,sum(tickets) tickets,sum(amount) amount
         from WH_GOODS_ISSUE_DETAIL 
         join GAME_PLANS using (plan_code)
         where sgi_no = #{_parameter} 
        group by SHORT_NAME,PLAN_CODE
        order by SHORT_NAME,PLAN_CODE
	</select>

	<select id="getPayoutResult" parameterType="string"	resultMap="tPayoutMap">
		select 
			NVL(SUCC_AMOUNT,0) winAmount,
			NVL (SUCC_TICKETS, 0) winTickets,
			plan_code||'-'||batch_no||'-'||PACKAGE_NO||'-'||TICKET_NO ticketCode,
			PAID_STATUS payStatus, 
			NVL(REWARD_AMOUNT,0) amount
		from SALE_PAID
		join SALE_PAID_DETAIL using (DJXQ_NO)
		where DJXQ_NO = #{_parameter}
		order by DJXQ_SEQ_NO
	</select>
	
	<select id="getCurrentIssueInfo" parameterType="string"	resultType="cls.pilottery.webncp.system.model.Response4104Model">
		SELECT ISSUE_NUMBER issueNumber,
		       TO_CHAR (PLAN_CLOSE_TIME, 'yyyymmddhh24miss') endPlanTime,
		       TO_CHAR (REAL_START_TIME, 'yyyymmddhh24miss') startTime
		  FROM iss_game_issue
		 WHERE game_code = #{_parameter} AND issue_status = 2
	</select>
</mapper>
