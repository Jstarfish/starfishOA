<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="cls.taishan.cncp.cmi.dao.DataQueryDao">
  	<select id="getAwardPeriodInfo" parameterType="map" resultType="cls.taishan.cncp.cmi.model.Res5001Msg">
	  	with sales as (
			    select SALE_AMOUNT,WINNING_AMOUNT,game_code, issue_number from CNCP_RPT_ISSUE 
			    where 1=1
			    <if test="dealerCode != null and dealerCode != ''">
			 	 	AND DEALER_CODE = #{dealerCode}
			 	</if>
			)
			SELECT ISSUE_NUMBER AS issue,
			       ISSUE_STATUS AS status,
			       to_char(START_SALE_TIME,'yyyyMMddHH24miss') AS startTime,
			       to_char(END_SALE_TIME,'yyyyMMddHH24miss') AS stopTime,
			       DRAW_CODE AS drawCode,
			       NVL (sales.SALE_AMOUNT, 0) AS salesAmount,
			       NVL (sales.WINNING_AMOUNT, 0) AS bonusAmount
			  FROM V_CNCP_ISSUE LEFT JOIN sales USING (game_code, issue_number)
			 WHERE game_code = #{gameCode}  
	  			<if test="issue == 0 or issue == '0'">
			 		and issue_number = (select max(issue_number) from v_cncp_issue where issue_status = 1 and game_code = #{gameCode} )
			 	</if>
			 	<if test="issue != 0 and issue != '0'">
			 		and issue_number = #{issue} 
			 	</if>
  	</select>
  	
  	<select id="getPresentIssue" parameterType="int" resultType="String">
  		select t.issue_number as issue from cncp_game_issues t where t.game_code = #{gameCode} and t.issue_status = 1
  	</select>
  	
  	<select id="getAccountBalance" parameterType="String" resultType="String">
  		select nvl(account_balance,0) as balance from cncp_acc_dealer  where dealer_code = #{dealerCode}
  	</select>
  	
  	<select id="get1101IssueNotify" parameterType="Map" resultType="cls.taishan.cncp.cmi.model.Req1101Notify">
  		SELECT GAME_CODE game,
		       ISSUE_NUMBER issue,
		       ISSUE_STATUS status,
		       to_char(START_SALE_TIME,'yyyyMMddHH24miss') startTime,
		       to_char(END_SALE_TIME,'yyyyMMddHH24miss') stopTime,
		       DRAW_CODE drawCode,
		       SALE_AMOUNT salesAmount,
		       WINNING_AMOUNT bonusAmount
		  FROM v_cncp_issue LEFT JOIN cncp_rpt_issue USING (game_code, issue_number)
		 WHERE game_code = #{gameCode} AND issue_number = #{issueNumber} 
		 	<if test="dealerCode != null and dealerCode != ''">
		 	 	AND DEALER_CODE = #{dealerCode}
		 	</if>
  	</select>
  	
  	<select id="getFundDaliyReport" parameterType="Map" resultType="cls.taishan.cncp.cmi.model.Res5007Msg">
  		SELECT CALC_DATE "date",
		       BEGIN_AMOUNT initAmount,
		       CHARGE_AMOUNT chargeAmount, 
		       WITHDRAW_AMOUNT withdrawAmount,
		       SALE_AMOUNT salesAmount,
		       SALE_COMM_AMOUNT commissionAmount,
		       REFUND_AMOUNT refundAmount,
		       PAID_AMOUNT returnAwardAmount,
		       OTHER_TICKETS otherAmount,
		       END_AMOUNT endAmount
		  FROM CNCP_DEALER_DAILY_REPORT
		 WHERE to_char(to_date(CALC_DATE,'yyyy-mm-dd'),'yyyymmdd') = #{date}
		 	<if test="dealerCode != null and dealerCode != ''">
		 	 	AND DEALER_CODE = #{dealerCode}
		 	</if>
  	</select>
  </mapper>