<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cls.pilottery.web.capital.dao.OutletBankDao">
	
	<update id="insertBankAcc" statementType="CALLABLE" parameterType="cls.pilottery.web.capital.model.OutletBankAccount">
		{call p_outlet_bankacc_create(
			#{agencyCode,mode=IN,jdbcType=VARCHAR},
			#{bankAccType,mode=IN,jdbcType=NUMERIC},
			#{currency,mode=IN,jdbcType=NUMERIC},
			#{bankAccNo,mode=IN,jdbcType=VARCHAR},
			#{bankAccName,mode=IN,jdbcType=VARCHAR},
			#{c_errcode,mode=OUT,jdbcType=NUMERIC},
			#{c_errmsg,mode=OUT,jdbcType=VARCHAR}
			)
		}
	</update>
	
	<update id="updateBankAccStatus" parameterType="cls.pilottery.web.capital.model.OutletBankAccount">
		update acc_agency_account_digital
		   set acc_status = #{status}
		 where digital_acc_seq = #{bankAccSeq}
	</update>

	<update id="updateBankAcc" parameterType="cls.pilottery.web.capital.model.OutletBankAccount">
		update acc_agency_account_digital
		   set currency = #{currency},
		       digital_acc_no = #{bankAccNo},
		       digital_acc_username = #{bankAccName}
		 where digital_acc_seq = #{bankAccSeq}
	</update>
	

	<select id="getAccInfoById" parameterType="String"
		resultType="cls.pilottery.web.capital.model.OutletBankAccount">
		Select a.agency_code agencyCode,
	       b.agency_name agencyName,
	       a.digital_acc_type bankAccType,
	       a.acc_status status,
	       a.acc_no accountNo,
	       a.currency currency,
	       a.digital_acc_seq bankAccSeq,
	       a.digital_acc_no bankAccNo,
	       a.digital_acc_username bankAccName,
	       c.admin_realname       adminName,
	       d.org_name             orgName
	  From ACC_AGENCY_ACCOUNT_DIGITAL a, INF_AGENCYS b, adm_info c, inf_orgs d
	 Where a.agency_code = b.agency_code
	   and b.market_manager_id = c.admin_id
	   and b.org_code = d.org_code				
       and a.digital_acc_seq = #{accSeq} 
	</select>
	
	<select id="getOutletInfo" parameterType="String"
		resultType="cls.pilottery.web.capital.model.OutletBankAccount">
		Select b.agency_code    agencyCode,
		       b.agency_name    agencyName,
		       c.admin_realname adminName,
		       d.org_name       orgName
		  From INF_AGENCYS b, adm_info c, inf_orgs d
		 Where b.market_manager_id = c.admin_id
		   and b.org_code = d.org_code
		   and b.agency_code = #{outletCode}
	</select>
		
	<!-- 站点账户信息列表 -->
	<select id="getOutletList" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="cls.pilottery.web.capital.model.OutletBankAccount">
		  select * from (
			select TAB.*,rownum rn  from (
				Select a.agency_code agencyCode,
			       b.agency_name agencyName,
			       a.digital_acc_type bankAccType,
			       a.acc_status status,
			       a.acc_no accountNo,
			       a.currency currency,
			       a.digital_acc_seq bankAccSeq,
			       a.digital_acc_no bankAccNo,
			       a.digital_acc_username bankAccName       
			  From ACC_AGENCY_ACCOUNT_DIGITAL a, INF_AGENCYS b
			  Where a.agency_code = b.agency_code				
                <if test="outletCode != null and outletCode != ''">
                 	and a.agency_code = #{outletCode} 
				</if>
				<if test="outletBankAccNo != null and outletBankAccNo != ''">
					and a.digital_acc_no= #{outletBankAccNo}  
				</if>
				<if test="status != null and status != 0 ">
					and a.acc_status = #{status} 
				</if>							
			      order by a.digital_acc_seq ) TAB )
		<![CDATA[ where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<!-- 分页记录总数 -->
	<select id="getOutletListCount" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="Integer">

		Select count(*)
		  From ACC_AGENCY_ACCOUNT_DIGITAL a, INF_AGENCYS b
		 Where a.agency_code = b.agency_code 
		<if test="outletCode != null and outletCode != ''">
			and a.agency_code = #{outletCode}
		</if>
		<if test="outletBankAccNo != null and outletBankAccNo != ''">
			and a.digital_acc_no= #{outletBankAccNo}
		</if>
		<if test="status != null and status != 0 ">
			and a.acc_status = #{status}
		</if>										    
	</select>
	

	<select id="getTopupFlow" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="cls.pilottery.web.capital.model.OutletBankTranFlow">
		select * from (
			select tab.*, rownum rn
			  from (select a.digital_trans_no tranFlow,
			               a.agency_code agencyCode,
			               b.agency_name agencyName,
			               a.digital_acc_type bankAccType,
			               a.digital_acc_no bankAccNo,
			               c.digital_acc_username bankAccName,
			               a.apply_amount amount,
			               a.trans_fee fee,
			               a.digital_trans_status status,
			               a.trans_currency currency,
			               to_char(a.req_time, 'yyyy-MM-DD HH24:MI:ss') applyTime,
			               to_char(a.res_time, 'yyyy-MM-DD HH24:MI:ss') responseTime,
			               a.fail_reason failureReason
			          from fund_digital_translog      a,
			               inf_agencys                b,
			               acc_agency_account_digital c
			         where a.agency_code = b.agency_code
			           and a.digital_acc_seq = c.digital_acc_seq
			           and a.digital_trans_type = 1
		            <if test="outletCode != null and outletCode != ''">
						and a.agency_code = #{outletCode}
					</if>
					<if test="outletBankAccNo != null and outletBankAccNo != ''">
						and a.digital_acc_no= #{outletBankAccNo}
					</if>
					 <if test="beginTime != null and beginTime != ''">
						<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') >= #{beginTime} ]]>
					</if>
					<if test="endTime != null and endTime != ''">
						<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') <= #{endTime} ]]>
					</if>								           			           
			         order by a.req_time desc) tab ) ccc 
		<![CDATA[ where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<!-- 分页记录总数 -->
	<select id="getTopupFlowCount" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="Integer">
		 select count(*)
          from fund_digital_translog      a,
               inf_agencys                b,
               acc_agency_account_digital c
         where a.agency_code = b.agency_code
           and a.digital_acc_seq = c.digital_acc_seq
           and a.digital_trans_type = 1
           <if test="outletCode != null and outletCode != ''">
			and a.agency_code = #{outletCode}
		</if>
		<if test="outletBankAccNo != null and outletBankAccNo != ''">
			and a.digital_acc_no= #{outletBankAccNo}
		</if>
		 <if test="beginTime != null and beginTime != ''">
			<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') >= #{beginTime} ]]>
		</if>
		<if test="endTime != null and endTime != ''">
			<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') <= #{endTime} ]]>
		</if>										    
	</select>
	
	<select id="getWithdrawFlow" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="cls.pilottery.web.capital.model.OutletBankTranFlow">
		  select * from(
			select tab.*, rownum rn
			  from (select a.digital_trans_no tranFlow,
			               a.agency_code agencyCode,
			               b.agency_name agencyName,
			               a.digital_acc_type bankAccType,
			               a.digital_acc_no bankAccNo,
			               c.digital_acc_username bankAccName,
			               a.apply_amount amount,
			               a.trans_fee fee,
			               a.digital_trans_status status,
			               a.trans_currency currency,
			               to_char(a.req_time, 'yyyy-MM-DD HH24:MI:ss') applyTime,
			               to_char(a.res_time, 'yyyy-MM-DD HH24:MI:ss') responseTime,
			               a.fail_reason failureReason
			          from fund_digital_translog      a,
			               inf_agencys                b,
			               acc_agency_account_digital c
			         where a.agency_code = b.agency_code
			           and a.digital_acc_seq = c.digital_acc_seq
			           and a.digital_trans_type = 2
		            <if test="outletCode != null and outletCode != ''">
						and a.agency_code = #{outletCode}
					</if>
					<if test="outletBankAccNo != null and outletBankAccNo != ''">
						and a.digital_acc_no= #{outletBankAccNo}
					</if>
					 <if test="beginTime != null and beginTime != ''">
						<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') >= #{beginTime} ]]>
					</if>
					<if test="endTime != null and endTime != ''">
						<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') <= #{endTime} ]]>
					</if>								           			           
			         order by a.req_time desc) tab ) ccc
		<![CDATA[ where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<!-- 分页记录总数 -->
	<select id="getWithdrawFlowCount" parameterType="cls.pilottery.web.capital.form.OutletBankQueryForm"
		resultType="Integer">
		 select count(*)
          from fund_digital_translog      a,
               inf_agencys                b,
               acc_agency_account_digital c
         where a.agency_code = b.agency_code
           and a.digital_acc_seq = c.digital_acc_seq
           and a.digital_trans_type = 2
           <if test="outletCode != null and outletCode != ''">
			and a.agency_code = #{outletCode}
		</if>
		<if test="outletBankAccNo != null and outletBankAccNo != ''">
			and a.digital_acc_no= #{outletBankAccNo}
		</if>
		 <if test="beginTime != null and beginTime != ''">
			<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') >= #{beginTime} ]]>
		</if>
		<if test="endTime != null and endTime != ''">
			<![CDATA[ and to_char(a.req_time, 'yyyy-MM-DD') <= #{endTime} ]]>
		</if>										    
	</select>

</mapper>