<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cls.pilottery.web.items.dao.ItemQuantityDao">

	<resultMap type="cls.pilottery.web.items.model.ItemType" id="itemTypeMap">
        <id column="ITEM_CODE" property="itemCode"/>
        <result column="ITEM_NAME" property="itemName"/>
        <result column="BASE_UNIT_NAME" property="baseUnitName"/>
        <result column="STATUS" property="status"/>
    </resultMap>

    <resultMap type="cls.pilottery.web.items.model.ItemQuantity" id="itemQuantityMap">
    	<id column="ITEM_CODE" property="itemCode"/>
    	<result column="WAREHOUSE_CODE" property="warehouseCode"/>
    	<result column="ITEM_NAME" property="itemName"/>
    	<result column="WAREHOUSE_NAME" property="warehouseName"/>
    	<result column="QUANTITY" property="quantity"/>
    </resultMap>

	<!-- 获得库存信息记录总数 -->
	<select id="getItemQuantityCount" parameterType="cls.pilottery.web.items.form.ItemQuantityQueryForm" resultType="Integer">
    	SELECT COUNT(1)
    	  FROM ITEM_QUANTITY Q
    	    LEFT JOIN WH_INFO W ON Q.WAREHOUSE_CODE = W.WAREHOUSE_CODE
    	 WHERE 1 = 1
    	 <if test="warehouseCode != null and warehouseCode != ''">
    	 	AND Q.WAREHOUSE_CODE = #{warehouseCode}
    	 </if>
    	 
    	 <if test="itemCode != null and itemCode != ''">
    	 	AND Q.ITEM_CODE = #{itemCode}
    	 </if>
    	 
    	 <if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        	AND W.ORG_CODE = #{sessionOrgCode}
         </if>
    	 
    	 <![CDATA[ AND QUANTITY >= 0 ]]>
    </select>
    
    <!-- 获得库存信息记录列表 -->
	<select id="getItemQuantityList" parameterType="cls.pilottery.web.items.form.ItemQuantityQueryForm" resultMap="itemQuantityMap">
		SELECT * FROM (
  			SELECT T.*,ROWNUM RN FROM (
    			SELECT ITEM_CODE,ITEM_NAME,Q.WAREHOUSE_CODE,W.WAREHOUSE_NAME,QUANTITY
    			  FROM ITEM_QUANTITY Q
    		        LEFT JOIN WH_INFO W ON Q.WAREHOUSE_CODE = W.WAREHOUSE_CODE
    			 WHERE 1 = 1
    			<if test="warehouseCode != null and warehouseCode != ''">
    	 			AND Q.WAREHOUSE_CODE = #{warehouseCode}
    	 		</if>
    	 
    	 		<if test="itemCode != null and itemCode != ''">
    	 			AND Q.ITEM_CODE = #{itemCode}
    	 		</if>
    	 		
    	 		<if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        			AND W.ORG_CODE = #{sessionOrgCode}
         		</if>
    	 		
    			<![CDATA[ AND QUANTITY >= 0 ]]>
    			ORDER BY WAREHOUSE_CODE,ITEM_CODE,ITEM_NAME,QUANTITY DESC
   <![CDATA[ ) T
        ) WHERE RN > ${beginNum} AND RN <= ${endNum} ]]>
    </select>
    
    <!-- 获得全部有库存的仓库 -->
	<select id="getStorageWarehouseForSelect" parameterType="cls.pilottery.web.warehouses.form.WarehouseQueryForm" resultType="cls.pilottery.web.warehouses.model.WarehouseInfo">
    	SELECT W.WAREHOUSE_CODE AS warehouseCode, W.WAREHOUSE_NAME AS warehouseName 
		  FROM WH_INFO W 
		 WHERE W.WAREHOUSE_CODE IN (SELECT WAREHOUSE_CODE FROM ITEM_QUANTITY)
		<if test="sessionOrgCode != null and sessionOrgCode != '00'"><!-- 非总公司下的仓库管理员只能看到直属机构的仓库信息 -->
        	AND W.ORG_CODE = #{sessionOrgCode}
        </if>
    </select>
    
    <!-- 获得全部有库存的物品 -->
    <select id="getStorageItemForSelect" resultMap="itemTypeMap">
    	SELECT I.ITEM_CODE,I.ITEM_NAME 
    	  FROM ITEM_ITEMS I 
    	 WHERE I.ITEM_CODE IN (SELECT ITEM_CODE FROM ITEM_QUANTITY)
    	   AND I.STATUS = 1
    </select>
    
    <!-- 获得物品在制定仓库下的库存量 -->
    <select id="getItemQuantityByWarehouse" parameterType="cls.pilottery.web.items.model.ItemQuantity" resultType="Integer">
    	SELECT QUANTITY
    	  FROM ITEM_QUANTITY
    	 WHERE ITEM_CODE = #{itemCode}
    	   AND WAREHOUSE_CODE = #{warehouseCode}
    </select>

</mapper>