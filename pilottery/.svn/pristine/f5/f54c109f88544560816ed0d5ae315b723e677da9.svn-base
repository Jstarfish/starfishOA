<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.pos.system.dao.OutletsManageDao">
	
	<select id="getCashWithdrawnList" parameterType="map" resultType="cls.pilottery.pos.system.model.WithDrawRecordResponse">
		SELECT FUND_NO withdrawnCode,
		       APPLY_AMOUNT amount,
		       TO_CHAR(APPLY_DATE,'MM-DD HH24:MI') time,
		       APPLY_STATUS status
		  FROM FUND_WITHDRAW
		 WHERE AO_CODE = #{outletCode}
	  ORDER BY time desc
	</select>
	
	<select id="getOutletsBalance" parameterType="String" resultType="cls.pilottery.pos.system.model.BalanceInfo">
		select ACCOUNT_BALANCE balance,CREDIT_LIMIT credit from ACC_AGENCY_ACCOUNT where agency_code = #{outletCode}
	</select>
	
	<select id="getOutletDailyList" parameterType="cls.pilottery.pos.system.model.OutletDaliyReportRequest" 
		resultType="cls.pilottery.pos.system.model.OutletSalesReocrd">
		<![CDATA[
		with days as 
		    (select D_DAY CALC_DATE from HIS_DIM_DWM
		        where HIS_DIM_DWM.d_day >= to_char((trunc(to_date(#{follow},'yyyy-mm-dd'))-#{count}),'yyyy-mm-dd')
		        and HIS_DIM_DWM.d_day < #{follow}),
		sale as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 7 and agency_code = #{outletCode}),
		sale_cm as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 5 and agency_code = #{outletCode}),  
		payout as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 8 and agency_code = #{outletCode}), 
		payout_cm as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 6 and agency_code = #{outletCode}),      
		topup as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 1 and agency_code = #{outletCode}),
		withdrawn as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 2 and agency_code = #{outletCode}),    
		returned as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 11 and agency_code = #{outletCode}), 
		return_cm as
		    (select CALC_DATE,AMOUNT from HIS_AGENCY_FUND where FLOW_TYPE = 13 and agency_code = #{outletCode}) 
		select CALC_DATE calDate,
		    nvl(sale.amount,0) sale,
		    nvl(sale_cm.amount,0) saleCommission,
		    nvl(payout.amount,0) payout,
		    nvl(payout_cm.amount,0) payoutCommission,
		    nvl(topup.amount,0) topup,
		    nvl(withdrawn.amount,0) withdrawn,
		    nvl(returned.amount,0) returned, 
		    nvl(return_cm.amount,0) returnCommission
		    from days
		left join sale using(CALC_DATE)
		left join sale_cm using(CALC_DATE)
		left join payout using(CALC_DATE)
		left join payout_cm using(CALC_DATE)
		left join topup using(CALC_DATE)
		left join withdrawn using(CALC_DATE)
		left join returned using(CALC_DATE)
		left join return_cm using(CALC_DATE)
		order by calDate desc
		]]>
	</select>

</mapper>
