-- 当日，销售前20的销售站，购票票数统计
with base as
 (select * from his_sellticket where saletime > trunc(sysdate)),
mid as
 (select AGENCY_CODE, sum(TICKET_AMOUNT)/4000 amount
    from base
   group by AGENCY_CODE),
high_sale as
 (select rownum, AGENCY_CODE, amount
    from (select * from mid order by amount desc)),
top_10_sale as
 (select * from high_sale where rownum < 20),
top_10_tickets as
 (select agency_code, count(*) cnt
    from base
   where agency_code in (select agency_code from top_10_sale)
   group by agency_code)
select agency_code, agency_name, area_name, org_name, amount, cnt, round(amount/cnt, 2) each_ticket_prize
  from top_10_sale
  join top_10_tickets
 using (agency_code)
  join inf_agencys
 using (agency_code)
 join inf_areas using(area_code)
 join inf_orgs using(org_code)
 order by amount desc;


-- 销售站增长
with base as
 (select trunc(AGENCY_ADD_TIME) add_date, count(*) cnt
    from inf_agencys
   where agency_code in
         (select agency_code from ttt.AUTH_agency where allow_sale > 0)
   group by trunc(AGENCY_ADD_TIME))
select add_date, sum(cnt) over(order by add_date) from base

-- 中奖与销售之间的关联关系

-- 