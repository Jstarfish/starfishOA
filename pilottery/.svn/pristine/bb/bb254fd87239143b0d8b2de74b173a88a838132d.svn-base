create or replace procedure p_time_lot_promotion (
   p_curr_date       date        default sysdate
)
/****************************************************************/
-------- 电脑票按月进行佣金奖励（每月1日0点执行） ----
---- 站点销售电脑票佣金设置：初始新建站点后电脑票销售佣金比例为7%；
---- 电脑票月销售额在1200万瑞尔（含1200万）以下，销售佣金为全部销售额的7%；
---- 电脑票月销售额在1200万—2400万瑞尔的，销售佣金为全部销售额的8%；
---- 电脑票月销售额在2400万以上的，销售佣金为全部销售额的9%；
---- 每日电脑票佣金均按7%计算统计，当截止到每月的最后一天，结算这一月的销售佣金；
---- 例，电脑票月销售额：2500万瑞尔，月末这一天所获佣金=7%*当天的销售额+2500*（8%-7%）

---- add by 陈震: 2016-05-21
--- modify by kwx: 2016-08-02 佣金比例为零时不结算
/****************************************************************/
is
  -- 加减钱的操作
  v_out_balance           number(28);                   -- 传出的销售站余额
  v_temp_balance          number(28);                   -- 临时金额
  v_sale_commission_rate  AUTH_AGENCY.SALE_COMMISSION_RATE%type;   --临时销售佣金比例
begin

  for tab in (select sale_agency, game_code, sum(pure_amount) amount from sub_sell where sale_month = to_char(p_curr_date - 1, 'yyyy-mm') group by sale_agency, game_code having sum(pure_amount) >= 1200*10000) loop
    
	select SALE_COMMISSION_RATE into  v_sale_commission_rate from AUTH_AGENCY where agency_code=tab.sale_agency and game_code=tab.game_code;

    if v_sale_commission_rate > 0 then
      if tab.amount >= 2400 * 10000 then
        p_agency_fund_change(tab.sale_agency, eflow_type.lottery_sale_comm, (tab.amount * 0.02), 0, 0, v_out_balance, v_temp_balance);
        continue;
      end if;

      p_agency_fund_change(tab.sale_agency, eflow_type.lottery_sale_comm, (tab.amount * 0.01), 0, 0, v_out_balance, v_temp_balance);
    end if;
  end loop;

  commit;
end;