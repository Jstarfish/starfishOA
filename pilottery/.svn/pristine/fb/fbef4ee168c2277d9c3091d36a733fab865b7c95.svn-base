package cls.taishan.web.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import cls.taishan.web.dao.wingChargeDao;
import cls.taishan.web.dao.wingChargeInputDao;
import cls.taishan.web.dao.wingChargeOutputDao;
import lombok.extern.log4j.Log4j;

@Log4j
@Controller
@RequestMapping("/API")
public class WingService {
	@Autowired
	private JdbcTemplate jdbcTemplate;

	@RequestMapping(value = "/wing_charge", method = RequestMethod.POST)
	@ResponseBody
	public wingChargeOutputDao wingCharge(@RequestBody wingChargeInputDao in) {

		// 初始化返回值
		wingChargeOutputDao out = new wingChargeOutputDao(jdbcTemplate);
		int rtv = 0;

		log.info("get Input data ... " + in);
		if (in.checkNull()) {
			log.error("there is some data with null value in Input data ... " + in);
			out.setErrorCode(100);
			out.setErrorMessage("there is some data with null value in Input data");
			return out;
		}

		wingChargeDao wdo = new wingChargeDao(jdbcTemplate, in);

		// 获取企业用户的登录信息
		rtv = wdo.getEUserLogin();
		if (rtv != 0) {
			log.error("some error occurs in getting EUser login data. errcode: " + rtv);
			out.setErrorCode(rtv);
			out.setErrorMessage("some error occurs in getting EUser login data");
			return out;
		}

		// 保存报文
		rtv = wdo.receiveData();
		if (rtv != 0) {
			log.error("some error occurs in receiving data. errcode: " + rtv);
			out.setErrorCode(rtv);
			out.setErrorMessage("some error occurs in receiving data");
			return out;
		}

		// 登录
		rtv = wdo.login();
		if (rtv != 0) {
			log.error("some error occurs in login action. errcode: " + rtv);
			out.setErrorCode(rtv);
			out.setErrorMessage("some error occurs in login");
			return out;
		}

		// 校验报文
		rtv = wdo.validate();
		if (rtv != 0) {
			log.error("some error occurs in validate action. errcode: " + rtv);
			out.setErrorCode(rtv);
			out.setErrorMessage("some error occurs in validate");
			return out;
		}

		// 提交
		rtv = wdo.commit();
		if (rtv != 0) {
			log.error("some error occurs in commit action. errcode: " + rtv);
			out.setErrorCode(rtv);
			out.setErrorMessage("some error occurs in commit");
			return out;
		}

		out.setErrorCode(0);
		out.getDataFromDB(wdo.eTradeFlow);

		return out;
	}

}
