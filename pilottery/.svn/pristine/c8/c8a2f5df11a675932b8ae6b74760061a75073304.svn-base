create or replace procedure p_cncp_paid
/****************************************************************/
   -- 渠道商派奖
   -- add by chen zhen @ 2016-09-09
   -- 轮训本期无纸化销售站的中奖票，按照兑奖限额的系统参数2001判断，是否已经进行过兑奖
   -- 轮询的过程中，得出统计值。轮询完毕，发起派奖和佣金的资金操作
   --
   -- modify by chen zhen @ 2016-09-20
   -- 增加向cncp发送消息的部分。这里需要先判断系统参数2004，如果有设置，就发送，否则跳过。

   -- modify by chen zhen @ 2016/12/8
   -- BUG。增加派奖
/*************************************************************/
(
  --------------输入----------------
  p_game                              in number,        -- 游戏编码
  p_issue                             in number,        -- 游戏期号

  --------------输入----------------
  c_error_code                        out number,        -- 错误码
  c_error_msg                         out varchar2       -- 错误内容

 ) is

  v_be_balance                        number(28);        -- 修改前账户余额
  v_af_balance                        number(28);        -- 修改后账户余额
  v_be_frozen_balance                 number(28);        -- 修改前账户冻结余额
  v_af_frozen_balance                 number(28);        -- 修改后账户冻结余额

  v_tab_paid_data                     type_cncp_paid_list;  -- 无纸化兑奖

  type type_issue_report              is table of cncp_rpt_issue%rowtype;
  v_tab_issue_report                  type_issue_report; -- 期次报表

  v_dealer_comm                       number(8);         -- 销售佣金

  v_dealer_code                       cncp_inf_dealers.dealer_code%type;
  v_sale_amount                       number(28);
  v_sale_tickets                      number(28);
  v_sale_comm                         number(28);
  v_winning_amount                    number(28);
  v_winning_tickets                   number(28);
  v_paid_amount                       number(28);
  v_paid_tickets                      number(28);
  v_fail_amount                       number(28);
  v_fail_tickets                      number(28);

  v_total_sale_amount                 number(28);
  v_total_sale_comm                   number(28);
  v_total_winning_amount              number(28);
  v_total_paid_amount                 number(28);

begin

  dbtool.set_success(errcode => c_error_code, errmesg => c_error_msg);

  -- 初始化数组
  v_tab_issue_report := type_issue_report();

  v_total_sale_amount := 0;
  v_total_sale_comm := 0;
  v_total_winning_amount := 0;
  v_total_paid_amount := 0;

  with win as
   (select /*+ materialized */
     applyflow_sell, game_code, issue_number, sum(winningamounttax) amount
      from his_win_ticket_detail
     where game_code = p_game
       and issue_number = p_issue
     group by applyflow_sell, game_code, issue_number),
  sell as
   (select applyflow_sell, sale_tsn, ticket_amount
      from his_sellticket
     where applyflow_sell in (select applyflow_sell from win)),
  paid as
   (select applyflow_sell, applyflow_pay
      from his_payticket
     where applyflow_sell in (select applyflow_sell from win)),
  dealer as
   (select sale_flow applyflow_sell, dealer_code
      from cncp_trade_sale
     where sale_flow in (select applyflow_sell from win))
  select type_cncp_paid_info(
           applyflow_sell,
           sale_tsn,
           applyflow_pay,
           game_code,
           issue_number,
           dealer_code,
           (case when applyflow_pay is null then 0 else 1 end), -- is_paid
           (case when applyflow_pay is null then 1 else 0 end), -- is_big_reward
           ticket_amount,
           amount,
           (case when applyflow_pay is null then null else sysdate end) -- paid_time
         )
    bulk collect into v_tab_paid_data
    from win
    left join sell
   using (applyflow_sell)
    left join paid
   using (applyflow_sell)
         join dealer
   using (applyflow_sell);

  -- 统计数据 & 派佣金
  for tab_dealers in (select distinct dealer_code from table(v_tab_paid_data)) loop
    v_dealer_code := tab_dealers.dealer_code;

    -- 计算销售额、销售票数
    select sum(case when order_status = ecncp_dealer_order_status.ticket_succ then order_amount else 0 end),
           sum(case when order_status = ecncp_dealer_order_status.ticket_succ then 1 else 0 end),
           sum(case when order_status = ecncp_dealer_order_status.ticket_fail then order_amount else 0 end),
           sum(case when order_status = ecncp_dealer_order_status.ticket_fail then 1 else 0 end)
      into v_sale_amount,
           v_sale_tickets,
           v_fail_amount,
           v_fail_tickets
      from cncp_trade_sale
     where game_code = p_game
       and issue_number = p_issue
       and dealer_code = v_dealer_code
       and order_status = ecncp_dealer_order_status.ticket_succ;

    v_sale_amount := nvl(v_sale_amount, 0);
    v_sale_tickets := nvl(v_sale_tickets, 0);
    v_fail_amount := nvl(v_fail_amount, 0);
    v_fail_tickets := nvl(v_fail_tickets, 0);
    
    -- 计算佣金
    begin
      select sale_commission_rate
        into v_dealer_comm
        from cncp_auth_dealer
       where dealer_code = v_dealer_code
         and game_code = p_game;
    exception
      when no_data_found then
        v_dealer_comm := 0;
    end;

    v_sale_comm := v_sale_amount * v_dealer_comm / 1000;

    -- 计算中奖金额、中奖票数
    select sum(reward_amount), count(*), sum(case when is_paid = 1 then reward_amount else 0 end), sum(case when is_paid = 1 then 1 else 0 end)
      into v_winning_amount, v_winning_tickets, v_paid_amount, v_paid_tickets
      from table(v_tab_paid_data)
     where dealer_code = v_dealer_code;

    -- 派销售佣金
    p_cncp_dealer_fund_change(v_dealer_code, ecncp_flow_type.sale_comm, v_sale_comm, 0, v_dealer_code || lpad(p_game,2,0) || lpad(p_issue,16,0) , v_be_balance, v_af_balance, v_be_frozen_balance, v_af_frozen_balance);

    -- 插入渠道统计表
    v_tab_issue_report.extend;
    v_tab_issue_report(v_tab_issue_report.count).game_code := p_game;
    v_tab_issue_report(v_tab_issue_report.count).issue_number := p_issue;
    v_tab_issue_report(v_tab_issue_report.count).dealer_code := v_dealer_code;
    v_tab_issue_report(v_tab_issue_report.count).sale_amount := v_sale_amount;
    v_tab_issue_report(v_tab_issue_report.count).sale_tickets := v_sale_tickets;
    v_tab_issue_report(v_tab_issue_report.count).sale_comm := v_sale_comm;
    v_tab_issue_report(v_tab_issue_report.count).winning_amount := v_winning_amount;
    v_tab_issue_report(v_tab_issue_report.count).winning_tickets := v_winning_tickets;
    v_tab_issue_report(v_tab_issue_report.count).paid_amount := v_paid_amount;
    v_tab_issue_report(v_tab_issue_report.count).paid_tickets := v_paid_tickets;
    v_tab_issue_report(v_tab_issue_report.count).fail_amount := v_fail_amount;
    v_tab_issue_report(v_tab_issue_report.count).fail_tickets := v_fail_tickets;

    -- 生成统计值
    v_total_sale_amount := v_total_sale_amount + v_sale_amount;
    v_total_sale_comm := v_total_sale_comm + v_sale_comm;
    v_total_winning_amount := v_total_winning_amount + v_winning_amount;
    v_total_paid_amount := v_total_paid_amount + v_paid_amount;
  end loop;

  -- 插入数据
  forall v_loop_i in 1 .. v_tab_paid_data.count
    insert into cncp_trade_paid
    values
    (v_tab_paid_data(v_loop_i).sale_flow     ,
     v_tab_paid_data(v_loop_i).sale_tsn      ,
     v_tab_paid_data(v_loop_i).pay_flow      ,
     v_tab_paid_data(v_loop_i).game_code     ,
     v_tab_paid_data(v_loop_i).issue_number  ,
     v_tab_paid_data(v_loop_i).dealer_code   ,
     v_tab_paid_data(v_loop_i).is_paid       ,
     v_tab_paid_data(v_loop_i).is_big_reward ,
     v_tab_paid_data(v_loop_i).order_amount  ,
     v_tab_paid_data(v_loop_i).reward_amount ,
     v_tab_paid_data(v_loop_i).paid_time
    );

  -- 为渠道商派奖
  for tab in (select dealer_code, sum(reward_amount) amount from table(v_tab_paid_data) where is_paid = 1 group by dealer_code) loop
    p_cncp_dealer_fund_change(tab.dealer_code, ecncp_flow_type.paid, tab.amount, 0, tab.dealer_code || lpad(p_game,2,0) || lpad(p_issue,16,0) , v_be_balance, v_af_balance, v_be_frozen_balance, v_af_frozen_balance);
  end loop;

  forall v_loop_i in 1 .. v_tab_issue_report.count insert into cncp_rpt_issue values v_tab_issue_report(v_loop_i);

  insert into cncp_game_issues (
         game_code,            issue_number,       issue_status,
         start_sale_time,      end_sale_time,      draw_code,                 reward_time,
         sale_amount,          sale_comm,          winning_amount,            paid_amount)
  select game_code,            issue_number,       5,
         real_start_time,      real_close_time,    final_draw_number,         real_reward_time,
         v_total_sale_amount,  v_total_sale_comm,  v_total_winning_amount,    v_total_paid_amount
    from iss_game_issue
   where game_code = p_game
     and issue_number = p_issue;

  -- 发送期次切换消息 modify by chen zhen @ 2016-09-20
  p_cncp_issue_state_change_job(p_game, p_issue);

  commit;

exception
  when others then
    rollback;
    c_error_code := -1;
    c_error_msg := error_msg.err_common_1 || sqlerrm;

end;
