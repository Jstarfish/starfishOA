<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cls.pilottery.webncp.system.dao.VersionDao">
	<select id="queryDeviceCode" parameterType="cls.pilottery.webncp.system.model.Request5001Model"
		resultType="cls.pilottery.webncp.system.model.Response5001Model">

		select TERMINAL_CODE as terminal_code from SALER_TERMINAL
		where status != 3
		and upper(mac_address) = upper(#{mac_addr})
	</select>
	<update id="updateVersion" parameterType="cls.pilottery.webncp.system.model.Request5002Model">
		update
		UPG_TERM_SOFTWARE t
		set t.last_report_date = sysdate
		,t.running_pkg_ver
		= #{terminal_version}
		where t.terminal_code = #{terminal_code}
	</update>
	<select id="getLastVersion" parameterType="cls.pilottery.webncp.system.model.Request5002Model"
		resultType="cls.pilottery.webncp.system.vo.Response5002Vo">
		select t1.schedule_id as schedule_id,
		t1.schedule_name as
		schedule_name,
		t1.pkg_ver as pkgvers,
		t1.schedule_sw_date as updateTime,
		t1.schedule_exec_date as schedule_exec_date
		from UPG_UPGRADEPLAN t1
		where t1.schedule_id =(select max(a.schedule_id)
		from UPG_UPGRADEPLAN a
		left join upg_upgradeproc b
		on a.schedule_id = b.schedule_id
		where
		a.term_type = #{terminal_model} and b.terminal_code = #{terminal_code}
		and
		a.schedule_status = 2)
	</select>
	<select id="getVersionInfo" parameterType="cls.pilottery.webncp.system.vo.Response5002Vo"
		resultType="cls.pilottery.webncp.system.vo.Response5002Vo">
		select p.terminal_code as terminal_code ,p.is_comp_dl as
		is_comp_dl from upg_upgradeproc p
		where p.schedule_id = #{schedule_id}
		and p.terminal_code = #{terminal_code}
	</select>
	<select id="getProcessInfo" parameterType="cls.pilottery.webncp.system.vo.RequestParamt"
		resultType="cls.pilottery.webncp.system.vo.Response5002Vo">
		select to_char(t.dl_start_date,'yyyy-MM-dd') as startDate,
		to_char(t.dl_end_date,'yyyy-MM-dd') as endDate,
		t.is_comp_dl as
		is_comp_dl,
		t.terminal_code as terminal_code,
		t.dl_filename as downName
		from upg_upgradeproc t
		where t.terminal_code = #{terminal_code}
		and
		t.schedule_id = #{schedule_id}
		and trim(t.pkg_ver) =
		#{terminal_version}
	</select>
	<update id="updateProcess" parameterType="cls.pilottery.webncp.system.vo.Response5002Vo">
		update upg_upgradeproc t
		set t.dl_proc='100', t.is_comp_dl = 1
		<if test="downName==null and downName==''">
			,t.dl_filename='Version NO. is same'
		</if>
		<if test="startDate==null and startDate=''">
			, t.dl_start_date = sysdate 
		</if>
		<if test="endDate==null and endDate==''">
			, t.dl_end_date = sysdate
		</if>
		where t.terminal_code =#{terminal_code}
		and t.schedule_id =
		#{schedule_id}
		and trim(t.pkg_ver) = #{pkgvers}
	</update>
	<update id="updateProcessTime" parameterType="cls.pilottery.webncp.system.vo.Response5002Vo">

		update
		upg_upgradeproc t
		set t.dl_start_date = sysdate
		where t.is_comp_dl= 0
		and t.terminal_code =#{terminal_code}
		and t.schedule_id =
		#{schedule_id}
	</update>
	<select id="getProcessTime" parameterType="cls.pilottery.webncp.system.model.Request5003Model"
		resultType="cls.pilottery.webncp.system.vo.Response5003Vo">
		select t.dl_start_date as startDate from upg_UPGRADEPROC t
		where t.terminal_code = #{terminal_code}
		and t.schedule_id =
		#{schedule_id}
		and trim(t.pkg_ver) = #{version_no}
	</select>
	<update id="updateDownProcessByNO" parameterType="cls.pilottery.webncp.system.vo.Request5003Parmt">
		update upg_UPGRADEPROC t
		set t.dl_proc = #{module_progress}
		,t.dl_filename = #{module_name}
		<if test="startDate==null and startDate==''">
			,t.dl_start_date = sysdate
		</if>

		where t.terminal_code = #{terminal_code}
		and t.schedule_id =
		#{schedule_id}
		and trim(t.pkg_ver) = #{version_no}
	</update>
	<update id="updateSoftware" parameterType="cls.pilottery.webncp.system.model.Request5003Model">
		update
		UPG_TERM_SOFTWARE t
		set t.DOWNING_PKG_VER = #{version_no}
		where
		t.terminal_code = #{terminal_code}

	</update>
	<select id="getUpgradeproc" parameterType="cls.pilottery.webncp.system.model.Request5004Model"
		resultType="cls.pilottery.webncp.system.vo.Response5004Vo">
		select t.dl_filename as downName
		from upg_upgradeproc t
		where t.terminal_code = #{terminal_code}
		and t.schedule_id = #{schedule_id}
		and trim(t.pkg_ver) = #{version_no}
	</select>

	<update id="updateOverupgradeproc" parameterType="cls.pilottery.webncp.system.vo.Request5004Parmt">
		update upg_upgradeproc t
		set t.is_comp_dl = 1,t.dl_end_date = sysdate
		,t.dl_proc='100'
		<if test="downName==null and downName==''">
			,t.dl_filename='download is too fast' 
   		</if>
		where t.terminal_code = #{terminal_code}
		and t.schedule_id = #{schedule_id}
		and trim(t.pkg_ver) = #{version_no}
	</update>
	<update id="updateOverSoftware" parameterType="cls.pilottery.webncp.system.vo.Request5004Parmt">
		update UPG_TERM_SOFTWARE t
		set t.DOWNING_PKG_VER = '', t.LAST_UPGRADE_DATE = sysdate
		where t.terminal_code = #{terminal_code}
	</update>
	
	<select id="getUserPwdById" resultType="String" parameterType="String">
		select admin_password from adm_info where admin_id = #{_parameter}
	</select>
	<select id="getCurrentBalance" resultType="long" parameterType="String">
		select credit_limit+account_balance from ACC_AGENCY_ACCOUNT where agency_code = substr(#{_parameter},1,8)
	</select>
	<insert id="saveCheckInfo" parameterType="map">
		INSERT INTO SALER_TERMINAL_CHECK (TERM_CHECK_ID,
                                  terminal_code,
                                  collecter_id,
                                  check_time,
                                  check_balance,
                                  check_terminal,
                                  agency_balance)
     VALUES (F_GET_GAME_HIS_CODE_SEQ,
             #{outletCode},
             #{userId},
             SYSDATE,
             #{checkBalance},
             #{checkTerminal},
             #{agencyBalance})
	</insert>	
</mapper>
