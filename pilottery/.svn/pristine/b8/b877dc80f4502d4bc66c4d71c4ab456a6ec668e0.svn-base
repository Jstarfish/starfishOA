<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.business.dao.AgencyDao">
	<!-- 游戏授权相关 -->
	<resultMap type="cls.pilottery.web.area.model.GameAuth" id="gameResult">
		<id column="GAME_CODE" property="gameCode" />
		<result column="SHORT_NAME" property="name" />
		<result column="AGENCY_CODE" property="agencyCode" />
		<result column="BASIC_TYPE" property="type" />
		<result column="enabled" property="status" />
		<result column="fee" property="fee" />
		<result column="PAY_COMMISSION_RATE" property="payCommissionRate" />
		<result column="SALE_COMMISSION_RATE" property="saleCommissionRate" />
		<result column="cancel" property="cancelStatus" />
		<result column="ALLOW_PAY" property="payStatus" />
		<result column="ALLOW_SALE" property="sellStatus" />
		<result column="CLAIMING_SCOPE" property="claimingScope" />			
	</resultMap>
	<resultMap type="cls.pilottery.oms.business.model.AreaParent" id="parentResult">
		<constructor>
	  		<idArg javaType="Long" column="AREA_CODE"/>
	  		<arg javaType="String" column="AREA_NAME"/>
	  </constructor>	  
	</resultMap>
	<resultMap type="cls.pilottery.oms.business.model.AgencyBank" id="bankResult">
		<constructor>
	  		<idArg javaType="Long" column="BANK_ID"/>
	  		<arg javaType="String" column="BANK_NAME"/>
	  </constructor>	  
	</resultMap>
	<resultMap type="cls.pilottery.oms.business.model.Agency" id="agencyResult">
		<id column="AGENCY_CODE" property="agencyCode" />		
		<result column="AGENCY_CODE" property="agencyCode"/>
		<result column="AGENCY_NAME" property="agencyName"/>
		<result column="AREA_CODE" property="orgCode"/>
		<result column="AREA_NAME" property="orgName"/>
		<result column="BANK_ID" property="bankId"/>
		<result column="STATUS" property="agencyStatus" javaType="cls.pilottery.oms.business.model.AgencyStatus" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.AgencyStatusTypeHandler" />
		<result column="AGENCY_TYPE" property="agencyType" javaType="cls.pilottery.oms.business.model.AgencyType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.AgencyTypeTypeHandler"/>
		<result column="MARGINAL_CREDIT" property="permanentCredit" />
		<result column="TEMP_CREDIT" property="tempCredit" />
		<result column="AVAILABLE_CREDIT" property="availableAmount"/>
		<result column="CONTACT_PERSON" property="agencyManager"/>
		<result column="BANK_ACCOUNT" property="bankAccount" />
		<result column="TELEPHONE" property="agencyPhone" />
		<result column="ADDRESS" property="agencyAddress" />
		<result column="BUSINESS_BEGIN_TIME" property="startTime" />
		<result column="BUSINESS_END_TIME" property="endTime" />	
		<association column="BANK_ID" property="agencyBank"  
					jdbcType="NUMERIC" javaType="cls.pilottery.oms.business.model.AgencyBank" resultMap="bankResult" />												
	</resultMap>
	
	<resultMap type="cls.pilottery.oms.business.model.AgencyBank" id="bankResult2">
		<id column="BANK_ID" property="bankId" />		
		<result column="BANK_NAME" property="bankName"/>
	</resultMap>
	<select id="getBanks" resultMap="bankResult2">
		SELECT BANK_ID,BANK_NAME FROM INF_BANKS
	</select>
	<select id="getAgencyName" parameterType="java.lang.String" resultType="java.lang.String">
		select distinct t.agency_name from saler_agency t where t.agency_code = #{agencyCode}
	</select>
	<select id="countAgencyList" parameterType="cls.pilottery.oms.business.form.AgencyForm" resultType="Integer" >
		SELECT count(saler_agency.agency_code)
		    FROM saler_agency left join inf_banks on saler_agency.bank_id = inf_banks.bank_id
                 left join inf_areas on saler_agency.area_code = inf_areas.area_code
		   WHERE 1=1
		    <if test="agencyCode != null and agencyCode != 0">
		        AND saler_agency.agency_code = ${agencyCode}
		    </if>
		    <if test="agencyName != null and agencyName != ''">
		        AND upper(saler_agency.agency_name) like upper('%${agencyName}%')
				</if>
		    <if test="agencyStatus != null and agencyStatus.value != 0">
		        AND saler_agency.status =  ${agencyStatus.value}
			</if>
			<if test="areaCode != null and areaCode != ''">
		        AND inf_areas.area_code = #{areaCode}
			</if>
			<if test="cuserOrg != '00'">
				AND inf_areas.area_code = #{cuserOrg}
			</if>
			<if test="agencytype!=null and agencytype!=0">
				and saler_agency.AGENCY_TYPE=#{agencytype}
			</if>
	</select>
	<select id="queryAgencyList" parameterType="cls.pilottery.oms.business.form.AgencyForm" resultMap="agencyResult">
		SELECT * FROM (
		SELECT a.*,rownum rn FROM (
		  SELECT saler_agency.*, inf_banks.bank_name,inf_areas.area_name
		    FROM saler_agency left join inf_banks on saler_agency.bank_id = inf_banks.bank_id
                 left join inf_areas on saler_agency.area_code = inf_areas.area_code
		   WHERE 1=1
		    <if test="agencyCode != null and agencyCode != 0">
		        AND saler_agency.agency_code = ${agencyCode}
		    </if>
		    <if test="agencyName != null and agencyName != ''">
		        AND upper(saler_agency.agency_name) like upper('%${agencyName}%')
			</if>
		    <if test="agencyStatus != null and agencyStatus.value != 0">
		        AND saler_agency.status =  ${agencyStatus.value}
			</if>
		    <if test="areaCode != null and areaCode != ''">
		        AND inf_areas.area_code = #{areaCode}
			</if>
			<if test="cuserOrg != '00'">
				AND inf_areas.area_code = #{cuserOrg}
			</if>
			<if test="agencytype!=null and agencytype != 0">
				and saler_agency.AGENCY_TYPE=#{agencytype}
			</if>
          <![CDATA[ order by saler_agency.agency_code ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
		
	<!-- 启用、禁用、清退用这个函数 -->
	<update id="updateStatus" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.Agency" >
		 {call   p_om_agency_status_ctrl(
    	        #{agencyCode,mode=IN,jdbcType=NUMERIC},
    	        #{agencyStatus.value,mode=IN,jdbcType=NUMERIC}, 
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}       
		 	)
		 }
	</update>
	<select id="getSalerTellerByAgencode" parameterType="String" resultType="Integer">
		select count(1)
	  	from SALER_TELLER t
	 	where t.agency_code= #{agencyCode}
	  	 and (t.status = 1 or t.status = 2)
	</select>
	<select id="getSalerTermByAgenCode"  parameterType="String" resultType="Integer">
		select count(1)
	 	 from SALER_TERMINAL t
	 	where t.agency_code = #{agencyCode}
	  	 and (t.status = 1
	    	or t.status = 2)
	</select>
	
		<select id="selectGameFromAgencymap" parameterType="map" resultMap="gameResult">
    		  select x11.game_code as gameCode,
           g11.SHORT_NAME as name,
           g11.BASIC_TYPE as type,
           nvl2(a11.enabled, a11.enabled, 0) as status,
           nvl2(a11.pay_commission_rate,
                a11.pay_commission_rate,
                0) as payCommissionRate,
          nvl2(a11.sale_commission_rate,
                a11.sale_commission_rate,
                0) as saleCommissionRate,
           nvl2(a11.allow_pay, a11.allow_pay, 0) as payStatus,
           nvl2(a11.allow_sale, a11.allow_sale, 0) as sellStatus,
           nvl2(a11.allow_cancel, a11.allow_cancel, 0) as cancelStatus,
           nvl2(a11.claiming_scope, a11.claiming_scope, 0) as claimingScope,
           a11.enabled,
           a11.pay_commission_rate,
           a11.sale_commission_rate,
           a11.allow_pay,
           a11.allow_sale,
           a11.allow_cancel,
           a11.claiming_scope
      from (select a1.game_code
              from auth_area a1
             where a1.area_code = 0
               and a1.enabled = 1
            INTERSECT
            select a2.game_code
              from auth_area a2
              left join inf_areas x2
                on a2.area_code = x2.father_area
             where x2.area_code = #{areaCode}
               and a2.enabled = 1
             INTERSECT
             select a3.game_code
              from auth_area a3
              where a3.area_code = #{areaCode}
              and a3.enabled =1      
             ) x11
      left join inf_games g11
        on x11.game_code = g11.game_code
      left join auth_agency a11
        on x11.game_code = a11.game_code
       and a11.agency_code = #{agencyCode}
        order by g11.game_code 
	</select>
		
	<select id="selectAgencyByCode"  parameterType="String" resultMap="agencyResult">
		SELECT AGENCY_CODE,
		       AGENCY_NAME,
		       STORETYPE_ID,
		       AREA_CODE,
		       a.STATUS,
		       AGENCY_TYPE,
		       BANK_ID,
		       BANK_ACCOUNT,
		       TEMP_CREDIT,
		       MARGINAL_CREDIT,
		       AVAILABLE_CREDIT,
		       CREDIT_CHECK_CODE,
		       TELEPHONE,
		       CONTACT_PERSON,
		       ADDRESS,
		       AUDIT_RESULT,
		       BUSINESS_BEGIN_TIME,
		       BUSINESS_END_TIME,
		       AGENCY_ADD_TIME,
		       BANK_NAME,
		       AREA_NAME,
		       BANK_ID
		  FROM SALER_AGENCY a
		  LEFT JOIN INF_BANKS USING (BANK_ID)
		  LEFT JOIN INF_AREAS USING (AREA_CODE)
		 WHERE AGENCY_CODE = #{code}
	</select>
		<select id="selectGameFromAgency" parameterType="String" resultMap="gameResult">
	  	select
    		A.GAME_CODE as gameCode,
			A.SHORT_NAME as name,
			A.BASIC_TYPE  as type,
			B.ENABLED     as status,
			B.PAY_COMMISSION_RATE as payCommissionRate,
			B.SALE_COMMISSION_RATE as   saleCommissionRate,
			B.ALLOW_PAY  as payStatus,
			B.ALLOW_SALE as sellStatus,
			B.ALLOW_CANCEL  as cancelStatus,
			B.CLAIMING_SCOPE as claimingScope
    	from
    		INF_GAMES A, AUTH_AGENCY B
    	where
    		B.AGENCY_CODE = #{agencyCode} AND B.GAME_CODE = A.GAME_CODE
	</select>
	<select id="getRefunInfoByagencycode"  parameterType="String" resultType="cls.pilottery.oms.business.model.AgencyRefunVo">
			 select ag.ADDRESS as address,
		       ag.CONTACT_PERSON as person,
		       t.his_code as id,
		       t.agency_code as agencyCode,
		       t.oper_time as refunddate,
		       ag.agency_name as agencyName,
		       t.available_credit as fundamount
		  from FUND_AGENCY_QUIT t, SALER_AGENCY ag
		  where t.agency_code = ag.agency_code and  t.agency_code=#{code}
	</select>
	<select id="ifAgencyCodeExist" parameterType="java.lang.String" resultType="Integer">
		select count(1) from saler_agency t where t.agency_code = #{agencyCode} and t.status = 1
	</select>
	<select id="getAreaCodeByInstionCode" parameterType="String" resultType="cls.pilottery.web.area.model.Areas">
	select sa.AREA_CODE as areaCode from saler_agency sa where sa.AGENCY_CODE=#{agencyCode}
	
	</select>
	 <select id="getGameFromArea" parameterType="String" resultMap="gameResult">
    	select
    		A.GAME_CODE as gameCode,
			A.SHORT_NAME as name,
			A.BASIC_TYPE  as type,
			B.ENABLED     as status,
			B.SALE_COMMISSION_RATE as saleCommissionRate,
			B.PAY_COMMISSION_RATE as payCommissionRate,
			B.ALLOW_PAY  as payStatus,
			B.ALLOW_SALE as sellStatus,
			B.ALLOW_CANCEL  as cancel
    	from
    		INF_GAMES A, AUTH_AREA B
    	where
    		B.AREA_CODE = #{areaCodes} AND B.GAME_CODE = A.GAME_CODE
    </select>
	<select id="getOrgListByOrgCode" parameterType="String" resultType="cls.pilottery.oms.business.model.OrgInfo">
		  select org.AREA_CODE as orgCode,org.AREA_NAME as orgName
		    from INF_AREAS org
		   where 1 = 1 
		     and org.STATUS =1 
		   <if test="_parameter !='00'">
		    	and org.AREA_CODE=#{_parameter}
		   </if>
	</select>

</mapper>
