<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.system.dao.PrivilegeDao">
	<resultMap type="cls.pilottery.web.system.model.Privilege" id="privilege">
		<id column="PRIVILEGE_ID" property="id" />
		<result column="PRIVILEGE_NAME" property="name" />
		<result column="PRIVILEGE_CODE" property="code"/>
		<result column="privilege_is_center" property="isCenterPri" />
		<result column="PRIVILEGE_PARENT" property="parentId" />
		<result column="PRIVILEGE_URL" property="url" />
		<result column="PRIVILEGE_LEVEL" property="level" />
		<result column="PRIVILEGE_REMARK" property="remark"/>
		<result column="PRIVILEGE_COMMENT" property="comment" />
		<result column="PRIVILEGE_ORDER" property="order" />
	</resultMap>
	
	<resultMap type="cls.pilottery.web.system.model.Privilege" id="subPrivMap" extends="privilege">
		<collection property="subPrivilege" ofType="cls.pilottery.web.system.model.Privilege" column="PRIVILEGE_ID"  select="getSubFunc"/>
	</resultMap>	 
    
    <select id="getPrivilegeByUserId" parameterType="Long" resultType="cls.pilottery.web.system.model.Privilege">  
        SELECT E.PRIVILEGE_ID id,
		       E.PRIVILEGE_NAME name,
		       E.PRIVILEGE_URL url,
		       E.PRIVILEGE_PARENT parentId
		  FROM ADM_INFO a,
		       ADM_ROLE_ADMIN b,
		       adm_role c,
		       ADM_ROLE_PRIVILEGE d,
		       ADM_PRIVILEGE e
		 WHERE A.ADMIN_ID = b.admin_id
		       AND b.role_id = c.role_id
		       AND c.role_id = d.role_id
		       AND d.privilege_id = e.privilege_id
		       AND a.admin_id = #{id}
		 GROUP BY E.PRIVILEGE_ID,E.PRIVILEGE_NAME,E.PRIVILEGE_URL,E.PRIVILEGE_PARENT,e.privilege_level, e.privilege_order
		 order by e.privilege_level,e.privilege_order
    </select>  
    
    <select id="getSubFunc" parameterType="long" resultMap="privilege">  
        select p.* from ADM_PRIVILEGE p where p.PRIVILEGE_PARENT=#{id} order by p.PRIVILEGE_ORDER asc
    </select>  
	
	<!--查询全部功能-->
	<select id="getFirstPrivilegeList" resultMap="subPrivMap">  
        select * from ADM_PRIVILEGE where PRIVILEGE_LEVEL='1' 
        
        <if test="areacode == null and areacode > 0">
	 	 	privilege_is_center != 1
		</if>
        
        order by PRIVILEGE_ORDER,PRIVILEGE_ID asc
    </select>  
	
	<!--通过用户id取得 用户权限列表-->
	<select id="getPrivilegeListByUserId" parameterType="long" resultMap="privilege">  
    </select> 

	<!-- 根据id得到功能对象-->
	<select id="getPrivilegeById" parameterType="long" resultMap="privilege">  
        select * from ADM_PRIVILEGE where PRIVILEGE_ID=#{id}  
    </select>  
	
	<!--根据权限标识得到权限-->
	<select id="getPrivilegeByCode" parameterType="String" resultMap="privilege">  
        select * from ADM_PRIVILEGE where PRIVILEGE_CODE=#{code}  
    </select>
    
    <!-- 根据角色表中的id查询角色信息和对应权限信息 -->  
    <select id="getRolePrivelege" resultMap="privilege">  
        select distinct 
        	   p.PRIVILEGE_ID,
		       p.PRIVILEGE_NAME,
		       p.PRIVILEGE_CODE,
		       p.privilege_is_center,
		       p.PRIVILEGE_PARENT,
		       p.PRIVILEGE_REMARK,
		       p.PRIVILEGE_URL,
		       p.PRIVILEGE_LEVEL,
		       p.PRIVILEGE_COMMENT
		  from ADM_PRIVILEGE p
		  left join ADM_ROLE_PRIVILEGE rp on p.PRIVILEGE_ID = rp.PRIVILEGE_ID
		  left join ADM_ROLE r on rp.ROLE_ID = r.ROLE_ID 
          where 1=0  
            <if test="roleIds != null">
              or r.ROLE_ID in
	        <foreach collection="roleIds" item="id" index="index" open="(" close=")" separator=",">
	            #{id}
	        </foreach>
	        </if>    	
	    	<if test="areacode == null or areacode > 0">
			 	and p.privilege_is_center != 1
  			</if>
	      and (p.PRIVILEGE_CODE like '010%'
       	    or p.PRIVILEGE_CODE like '020%')
	      order by p.PRIVILEGE_ID asc
    </select>  
</mapper>
