--游戏初始化
create or replace view v_cncp_inf_games as select game_code,basic_type,full_name,short_name,'CLS' issuing_organization from inf_games;

-- 期次查询
create or replace view v_cncp_issue as 
select game_code,
       issue_number,
       (case
         when issue_status in (2) then
          1
         when issue_status in (3, 4, 5) then
          3
         when issue_status in (6, 7, 8, 9, 10, 11, 12, 13) then
          4
         else
          0
       end) issue_status,
       plan_start_time   as start_sale_time,
       plan_close_time   as end_sale_time,
       final_draw_number as draw_code,
       real_reward_time  as reward_time,
       0 as sale_amount,
       0 as winning_amount,
       0 as paid_amount
  from iss_game_issue
 where (game_code, issue_number) not in
       (select game_code, issue_number from cncp_game_issues)
      -- 预排和预售，不返回
   and issue_status not in (0, 1)
union all
select game_code,
       issue_number,
       issue_status,
       start_sale_time,
       end_sale_time,
       draw_code,
       reward_time,
       sale_amount,
       winning_amount,
       paid_amount
  from cncp_game_issues;


-- 月结报表
create or replace view v_cncp_monthy_report as
select CALC_MONTH,
       DEALER_CODE,
       DEALER_NAME,
       sum(case
             when substr(calc_date, 9, 2) = '01' then
              BEGIN_AMOUNT
             else
              0
           end) BEGIN_AMOUNT,
       sum(case
             when (to_char(dbtool.s2d(calc_date) + 1, 'dd') = '01' or
                  dbtool.s2d(calc_date) + 1 = trunc(sysdate)) then
              END_AMOUNT
             else
              0
           end) END_AMOUNT,
       sum(CHARGE_AMOUNT) CHARGE_AMOUNT,
       sum(WITHDRAW_AMOUNT) WITHDRAW_AMOUNT,
       sum(SALE_AMOUNT) SALE_AMOUNT,
       sum(SALE_COMM_AMOUNT) SALE_COMM_AMOUNT,
       sum(REFUND_AMOUNT) REFUND_AMOUNT,
       sum(PAID_AMOUNT) PAID_AMOUNT,
       sum(OTHER_TICKETS) OTHER_TICKETS
  from CNCP_DEALER_DAILY_REPORT t
 group by CALC_MONTH, DEALER_CODE, DEALER_NAME;
