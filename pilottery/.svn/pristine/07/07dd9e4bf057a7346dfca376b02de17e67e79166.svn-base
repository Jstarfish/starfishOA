{% extends "base.html" %}

{% block content %}
{% autoescape None %}
        <!-- Page Head -->
        <div>
            <span id="page-topic">&nbsp;&nbsp;Issue XML Information</span>
        </div>
        
        <br /><br />
        
        <div class="clear"></div> <!-- End .clear -->
        
        <div class="content-box"><!-- Search Content Box -->
            
            <div class="content-box-header">
                
                <h3>Search box</h3>
                
            </div> <!-- End .content-box-header -->

            <div class="content-box-content">

                <form action="/issue_xml/" method="post">

                    <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                        <tbody>
                            <tr class="empty_white">
                                <td width="100">Select Game</td>
                                <td width="100">
                                    <select name="game_code" class="game-input">
                                        {% for game in game_list %}
                                        <option value="{{game}}" {% if game_code==game %}Selected{% end %}>{{game}}</option>
                                        {% end %}
                                    </select>
                                </td>
                                <td width="100">Issue Number</td>
                                <td width="100"><input class="text-input issue-input" type="text" name="issue_number" value="{{issue_number}}" /></td>
                                <td width="80">Xml Type</td>
                                <td width="200">
                                    <select name="xml_type" class="small-input">
                                        <option value="draw_announce" {% if xml_type=="draw_announce" %}Selected{% end %}>Draw Announce</option>
                                        <option value="winner_local" {% if xml_type=="winner_local" %}Selected{% end %}>Winner Local</option>
                                        <option value="winner_confirm" {% if xml_type=="winner_confirm" %}Selected{% end %}>Winner Confirm</option>
                                    </select>
                                </td>
                                <td class="search_td"><input class="button" type="submit" value="Submit" /></td>
                                <td class="search_td"></td>
                            </tr>
                        </tbody>
                    </table>

                </form>
                
            </div> <!-- End .content-box-content -->
            
        </div> <!-- End .content-box -->

        <div class="content-box"><!-- Start Content Box -->
            
            <div class="content-box-header">
                <h3>XML Content</h3>
                <div class="clear"></div>
            </div> <!-- End .content-box-header -->
            
            <div class="content-box-content">
                <div class="tab-content default-tab"> <!-- This is the target div. id must match the href of this div's tab -->
                    <textarea id="output" style="width:100%;height:1200px;border-style:none;font-size:24px; color:#09F"></textarea>
                </div> <!-- End #tab1 -->
            </div>
        </div> <!-- End .content-box -->

        <script type="text/javascript">
            String.prototype.removeLineEnd = function()
            {
                return this.replace(/(<.+?\s+?)(?:\n\s*?(.+?=".*?"))/g,'$1 $2')
            }
            function getPrefix(prefixIndex)
            {  
                var span = '    ';  
                var output = [];  
                for(var i = 0 ; i < prefixIndex; ++i)  
                {  
                    output.push(span);  
                }  
                  
                return output.join('');  
            }
            function formatXml(text)  
            {  
                //去掉多余的空格  
                text = '\n' + text.replace(/(<\w+)(\s.*?>)/g,function($0, name, props)  
                {  
                    return name + ' ' + props.replace(/\s+(\w+=)/g," $1");  
                }).replace(/>\s*?</g,">\n<");  

                //把注释编码  
                text = text.replace(/\n/g,'\r').replace(/<!--(.+?)-->/g,function($0, text)  
                {  
                    var ret = '<!--' + escape(text) + '-->';  
                    //alert(ret);  
                    return ret;  
                }).replace(/\r/g,'\n');
                  
                //调整格式  
                var rgx = /\n(<(([^\?]).+?)(?:\s|\s*?>|\s*?(\/)>)(?:.*?(?:(?:(\/)>)|(?:<(\/)\2>)))?)/mg;  
                var nodeStack = [];  
                var output = text.replace(rgx,function($0,all,name,isBegin,isCloseFull1,isCloseFull2 ,isFull1,isFull2){  
                    var isClosed = (isCloseFull1 == '/') || (isCloseFull2 == '/' ) || (isFull1 == '/') || (isFull2 == '/');  
                    //alert([all,isClosed].join('='));  
                    var prefix = '';  
                    if(isBegin == '!')  
                    {  
                        prefix = getPrefix(nodeStack.length);  
                    }  
                    else   
                    {  
                        if(isBegin != '/')  
                        {  
                            prefix = getPrefix(nodeStack.length);  
                            if(!isClosed)  
                            {  
                                nodeStack.push(name);  
                            }  
                        }  
                        else  
                        {  
                            nodeStack.pop();  
                            prefix = getPrefix(nodeStack.length);  
                        }  
                    }  
                    var ret =  '\n' + prefix + all;  
                    return ret;  
                });
                  
                var prefixSpace = -1;  
                var outputText = output.substring(1);  

                //把注释还原并解码，调格式  
                outputText = outputText.replace(/\n/g,'\r').replace(/(\s*)<!--(.+?)-->/g,function($0, prefix,  text)  
                {  
                    //alert(['[',prefix,']=',prefix.length].join(''));  
                    if(prefix.charAt(0) == '\r')  
                        prefix = prefix.substring(1);  
                    text = unescape(text).replace(/\r/g,'\n');  
                    var ret = '\n' + prefix + '<!--' + text.replace(/^\s*/mg, prefix ) + '-->';  
                    //alert(ret);  
                    return ret;  
                });  

                return outputText.replace(/\s+$/g,'').replace(/\r/g,'\r\n');  
          
            }
            window.onload = function (){
                var d_out = document.getElementById('output');
                //alert("{{xml_content}}");
                d_out.value = formatXml("{{xml_content}}");
            } 
        </script>

{% end %}
