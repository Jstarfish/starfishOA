<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.goodsreceipts.dao.GoodsTransferDao">
<select id="getSaltranserList" parameterType="cls.pilottery.web.goodsIssues.form.GoodsIssuesForm" resultType="cls.pilottery.web.sales.entity.StockTransfer" >
select sa.stb_no as stbNo from SALE_TRANSFER_BILL sa
where 1=1 and sa.STATUS=7
<if test="houseCode!=null and houseCode!=''">
<!-- and sa.RECEIVE_WH=#{houseCode} -->
</if>

</select>
<select id="getSaltranserDitalList" parameterType="String"  resultType="cls.pilottery.web.sales.entity.StockTransferDetail" >
select bi.stb_no    as stbNo,
       bi.plan_code as planCode,
       ga.full_name as planName, 
       bi.tickets as tickets,
       bi.amount    as amount,
       b.send_org   as sendOrg,
       b.receive_org as receiveOrg,
       org1.org_name  as deliveringUnit,
       org2.org_name  as receivingUnit
  from SALE_TB_APPLY_DETAIL bi, game_plans ga,sale_transfer_bill b,inf_orgs org1,inf_orgs org2
 where 1 = 1
   and ga.plan_code = bi.plan_code
   and b.stb_no=bi.stb_no
   and org1.org_code=b.send_org
   and org2.org_code=b.receive_org
   and trim(bi.stb_no)=trim(#{stbNo})
</select>
<select id="getGameBathInfoList" resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo" >
select g.plan_code            as planCode,
       g.full_name            as planName,
       gb.batch_no            as batchNo,
       g.ticket_amount        as amount,
       de.TICKETS_EVERY_GROUP as ticketsEveryGroup
  from game_plans g, GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
 where 1 = 1
   and g.plan_code = gb.plan_code
   and g.plan_code = de.plan_code
      
   and de.status = 1
</select>
<select id="getGameRfeNo" parameterType="String" resultType="String">
select de.ref_no from WH_GOODS_RECEIPT de
where 1=1 and de.sgr_no=#{sgrNo}

</select>
<select id="getSaltranserGame" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo">
select g.plan_code            as planCode,
       g.full_name            as planName,
       gb.batch_no            as batchNo,
       g.ticket_amount        as amount,
       de.TICKETS_EVERY_GROUP as ticketsEveryGroup from (select *
  from game_plans p
 where p.plan_code in (select d.plan_code
                         from sale_tb_apply_detail d,SALE_TRANSFER_BILL b
                        where d.stb_no =#{stbNo} and d.stb_no=b.stb_no )) g,GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
                        where 1 = 1
   and g.plan_code = gb.plan_code
   and g.plan_code = de.plan_code
      
   and de.status = 1

</select>
<select id="getSaltranserInfoListbyCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">

select d.stb_no,
       d.plan_code as planCode,
       p.full_name as planName,
       d.tickets as actTickts,
       nvl(r.trunk, 0) as trunk,
       nvl(r.box, 0) as  box,
       nvl(r.pkg, 0)as  pkg,
       nvl(r.tickets, 0) as  tickets
  from sale_tb_apply_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(case valid_number when 1 then 1 else 0 end) as trunk,
                    sum(case valid_number when 2 then 1 else 0 end) as box,
                    sum(case valid_number when 3 then 1 else 0 end) as pkg,
                    sum(tickets) as tickets
               from wh_goods_receipt_detail where  ref_no=#{stbNo}
              group by ref_no, plan_code) r
    on (d.stb_no = r.ref_no and d.plan_code = r.plan_code)
    
    
     where d.stb_no =#{stbNo}

</select>
<select id="getSaltranserInfoListDiffbyCode" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">
select d.stb_no,
       d.plan_code as planCode,
       p.full_name as planName,
       d.tickets as receivableTickets,
       nvl(r.tickets, 0)  as receivabedTickets,
       d.tickets-nvl(r.tickets, 0) as diff
  from sale_tb_apply_detail d
  left join game_plans p
    on d.plan_code = p.plan_code
  left join (select ref_no,
                    plan_code,
                    sum(tickets) as tickets
               from wh_goods_receipt_detail
            
              group by ref_no, plan_code) r
    on (d.stb_no = r.ref_no and d.plan_code = r.plan_code)

 where d.stb_no = #{stbNo}


</select>
</mapper>
