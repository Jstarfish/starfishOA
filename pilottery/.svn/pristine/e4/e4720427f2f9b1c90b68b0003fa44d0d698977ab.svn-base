<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.pos.system.dao.OrderManageDao">
	<resultMap id="pcOrderMap" type="cls.pilottery.pos.system.model.PurchaseOrderResponse">
		<result column="orderNo" property="orderNo" />
		<result column="time" property="time" />
		<result column="status" property="status" />
		<collection property="detailList" ofType="cls.pilottery.pos.system.model.PurchaseOrderDetail">
			<result column="planCode" property="planCode" />
			<result column="planName" property="planName" />
			<result column="tickets" property="tickets" />
			<result column="amount" property="amount" />
		</collection>
	</resultMap>
	<resultMap id="posDeliveryMap" type="cls.pilottery.web.sales.entity.DeliveryOrder">
		<id column="DO_NO" property="doNo" />
		<result column="APPLY_ADMIN" property="applyAdmin" />
		<result column="APPLY_DATE" property="applyDate" />
		<result column="WH_CODE" property="whCode" />
		<result column="WH_ORG" property="org" />
		<result column="WH_ADMIN" property="managerAdmin" />
		<result column="WH_ADMIN_NAME" property="managerAdminName" />
		<result column="OUT_DATE" property="outDate" />
		<result column="STATUS" property="status" />
		<result column="TOTAL_TICKETS" property="totalTickets" />
		<result column="TOTAL_AMOUNT" property="totalAmount" />
		<result column="ADMIN_REALNAME" property="applyAdminName" />
		<result column="ORG_NAME" property="orgName" />
		<result column="REMARK" property="remark" />
		<collection property="deliveryDetail" ofType="cls.pilottery.web.sales.entity.DeliveryOrderDetail">
			<id column="DO_NO" property="doNo" />
			<id column="SEQUENCE_NO" property="sequenceNo" />
			<result column="PLAN_CODE" property="planCode" />
			<result column="PLAN_NAME" property="planName" />
			<result column="PACKAGES" property="packages" />
			<result column="TICKETS" property="tickets" />
			<result column="AMOUNT" property="amount" />
		</collection>
		<collection property="doRelation" ofType="cls.pilottery.web.sales.entity.DeliveryOrderRelation">
			<id column="DO_NO" property="doNo" />
			<id column="ORDER_NO" property="orderNo" />
		</collection>
	</resultMap>
	
	<select id="getPosDeliveryList" parameterType="map"	resultType="cls.pilottery.pos.system.model.PosDeliveryOrder">
		select deliveryOrder,time,status,tickets,amount from (      
			select t.*,rownum rnum from (         
				select  DO_NO deliveryOrder, 
				        TO_CHAR(APPLY_DATE,'MM-DD HH24:MI') time, 
				        STATUS status, 
				        TICKETS tickets, 
				        AMOUNT amount
				from SALE_DELIVERY_ORDER
				WHERE 1 = 1   
				<if test="userId != null and userId != ''">
					AND APPLY_ADMIN = #{userId}
				</if>
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and DO_NO < #{lastId} ]]>
				</if>
				order by time desc
				) t 
			<![CDATA[ ) where rnum <= #{pageCount} ]]>
	</select>
	
	<select id="getPosDeliveryDetail" parameterType="string"	resultMap="posDeliveryMap">
		with orders as (
		    SELECT DO_NO,
		           APPLY_ADMIN,
		           APPLY_DATE,
		           WH_CODE,
		           WH_ORG,
		           OUT_DATE,
		           STATUS,
		           TICKETS TOTAL_TICKETS,
		           AMOUNT TOTAL_AMOUNT,
		           B.ADMIN_REALNAME,
		           ORG_NAME,
		           WH_ADMIN,
				   D.ADMIN_REALNAME WH_ADMIN_NAME,
		           REMARK
		      FROM SALE_DELIVERY_ORDER a
		           LEFT JOIN ADM_INFO b ON (a.APPLY_ADMIN = b.ADMIN_ID)
		           LEFT JOIN INF_ORGS c ON (a.WH_ORG = c.ORG_CODE)
		           LEFT JOIN ADM_INFO d ON (a.WH_ADMIN = d.ADMIN_ID)
		     WHERE DO_NO = #{deliveryOrderNo}
		),
		details as (
		    select DO_NO, SEQUENCE_NO, x.PLAN_CODE,y.SHORT_NAME as plan_name, TICKETS, PACKAGES, AMOUNT
		    from SALE_DELIVERY_ORDER_DETAIL x,game_plans y
		    where x.plan_code = y.plan_code
		    and DO_NO = #{deliveryOrderNo}
		),
		porder as (
            select DO_NO,ORDER_NO from SALE_DELIVERY_ORDER_ALL where DO_NO = #{deliveryOrderNo}
        )
		select orders.DO_NO,APPLY_ADMIN,APPLY_DATE, WH_CODE, WH_ORG, OUT_DATE,STATUS,TOTAL_TICKETS,TOTAL_AMOUNT,ADMIN_REALNAME,ORG_NAME,REMARK,WH_ADMIN,WH_ADMIN_NAME,
		details.*,porder.order_no
		from orders,details,porder
		where orders.do_no = details.do_no
		and orders.do_no = porder.do_no(+)
	</select>
	
	<select id="getMktFundFlow" parameterType="map"	resultType="cls.pilottery.pos.system.model.MktFundFlowDetail">
		select TRADE_TIME time, FLOW_TYPE type,CHANGE_AMOUNT amount,ACC_NO accNo from 
		(
			select ROWNUM rnum,t.* from (
				select to_char(TRADE_TIME,'MM-DD HH24:MI') TRADE_TIME, FLOW_TYPE,CHANGE_AMOUNT,A.ACC_NO
				from ACC_MM_ACCOUNT a ,FLOW_MARKET_MANAGER b 
				where a.acc_NO = B.ACC_NO
					and a.market_admin = #{userId}
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and REF_NO < #{lastId} ]]>
				</if> 
				order by trade_time desc
			) t
		<![CDATA[ ) where rnum <= #{pageCount} ]]>
	</select>
	
	<select id="getMktFundBalance" parameterType="int"	resultType="cls.pilottery.pos.system.model.MktFundFlowResponse">
		select CREDIT_LIMIT credit,ACCOUNT_BALANCE balance from ACC_MM_ACCOUNT where MARKET_ADMIN = #{userId}
	</select>
	
	<select id="getInventoryList" parameterType="long"	resultType="cls.pilottery.pos.system.model.MktInventoryDetail">
		SELECT plan_code planCode,
		       SHORT_NAME planName,
		       TICKETS tickets,
		       AMOUNT amount
		  FROM ACC_MM_TICKETS LEFT JOIN GAME_PLANS USING (plan_code)
		 WHERE MARKET_ADMIN = #{userId}
	</select>
	
	<select id="getPosPurchaseOrderList" parameterType="map" resultMap="pcOrderMap">
		with detail as (
			SELECT order_no,
				   a.PLAN_CODE planCode,
			       SHORT_NAME planName,
			       TICKETS tickets,
			       AMOUNT amount
			  FROM SALE_ORDER_APPLY_DETAIL a, GAME_PLANS b
			 WHERE a.plan_code = b.plan_code 
		),
		pcorder as (
		select * from (      
			select t.*,rownum rnum from (         
				select  ORDER_NO orderNo, 
				        APPLY_DATE, 
				        STATUS status
				from SALE_ORDER 
				where 1 = 1  
				<if test="userId != null and userId != ''">
					AND (APPLY_ADMIN = #{userId} or APPLY_AGENCY in (select AGENCY_CODE from INF_AGENCYS where MARKET_MANAGER_ID = #{userId}))
				</if>
				<if test="status != null and status != ''">
					AND status = #{status}
				</if>
				<if test="outletCode != null and outletCode != ''">
					and APPLY_AGENCY = #{outletCode}
				</if>
				<if test="lastId != null and lastId != ''">
					<![CDATA[ and ORDER_NO < #{lastId} ]]>
				</if>
				) t 
			<![CDATA[ ) where rnum <= #{pageCount} ]]>
		)
		select pcorder.orderNo,TO_CHAR(pcorder.APPLY_DATE,'MM-DD HH24:MI') time,pcorder.status,detail.planCode,detail.planName,detail.tickets,detail.amount
		from pcorder,detail 
		where pcorder.orderNO = detail.order_no
		order by pcorder.APPLY_DATE desc
	</select>

</mapper>
