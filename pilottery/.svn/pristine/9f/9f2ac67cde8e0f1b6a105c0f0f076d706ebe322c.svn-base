<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.web.goodsreceipts.dao.GoodsReceiptsDao">

	<resultMap type="cls.pilottery.web.goodsreceipts.model.WhGoodsReceipt" id="whGoodsReceipt">
		<id column="SGR_NO" property="sgrNo" />
		<result column="CREATE_ADMIN" property="createAdmin" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="RECEIPT_AMOUNT" property="receiptAmount" />
		<result column="RECEIPT_TICKETS" property="receiptTickets" />
		<result column="ACT_RECEIPT_AMOUNT" property="actReceiptAmount" />
		<result column="ACT_RECEIPT_TICKETS" property="actReceiptTickets" />
		<result column="RECEIPT_TYPE" property="receiptType" />
		<result column="REF_NO" property="refNo" />
		<result column="STATUS" property="status" />
		<result column="CARRIER" property="carrier" />
		<result column="CARRY_DATE" property="carryDate" />
		<result column="CARRIER_CONTACT" property="carrierContact" />
		<result column="SEND_ORG" property="sendOrg" />
		<result column="SEND_WH" property="sendWh" />
		<result column="SEND_MANAGER" property="sendManager" />
		<result column="SEND_DATE" property="sendDate" />
	</resultMap>
		<resultMap type="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail" id="whGoodsReceiptDetail">
		<id column="SGR_NO" property="sgrNo" />
		<result column="SEQUENCE_NO" property="sequenceNo" />
		<result column="RECEIPT_TYPE" property="receiptType" />
		<result column="REF_NO" property="refNo" />
		<result column="VALID_NUMBER" property="validNumber" />
		<result column="PLAN_CODE" property="planCode" />
		<result column="BATCH_NO" property="batchNo" />
		<result column="TRUNK_NO" property="trunkNo" />
		<result column="BOX_NO" property="boxNo" />
		<result column="PACKAGE_NO" property="packageNo" />
		<result column="TICKETS" property="tickets" />
		<result column="AMOUNT" property="amount" />
		
	</resultMap>
	<!-- 分页记录总数 -->
	<select id="getGoodsReceiptCount" parameterType="cls.pilottery.web.goodsreceipts.form.GoodsReceiptsForm" resultType="Integer">
		select count(1) from WH_GOODS_RECEIPT org, (select distinct wh.warehouse_code from WH_MANAGER wh where wh.org_code=#{houseCode}) w 
		where 1 = 1
     and org.RECEIVE_WH=w.warehouse_code
		<if test="sgrNo != null and sgrNo != ''">
			and org.SGR_NO = #{sgrNo}
		</if>
		
	
		<if test="sendDate != null and sendDate != ''">
			and to_char(org.RECEIPT_END_TIME,'yyyy-mm-dd')  =  #{sendDate}
		</if>
		
		   order by org.RECEIPT_END_TIME desc
		
		
	</select>
 	<!-- 部门列表 -->
	<select id="getGoodsReceiptList" parameterType="cls.pilottery.web.goodsreceipts.form.GoodsReceiptsForm"
		resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceipt">
		select * from (
		select a.*,rownum rn from (
		
   select org.sgr_no       as sgrNo,
       org.RECEIPT_END_TIME           as sendDate,
       u.admin_realname        as sendOperater,
       org.status              as status,
       org.ACT_RECEIPT_TICKETS as actReceiptTickets,
       org.act_receipt_amount  as actReceiptAmount,
       org.receipt_type        as receiptType,
       org.receipt_tickets     as receiptTickets,
       org.REF_NO              as refNo
       
         
      from WH_GOODS_RECEIPT org , ADM_INFO u
         , 
          (select distinct wh.warehouse_code from WH_MANAGER wh where wh.org_code=#{houseCode}) w
     
         
         
         
         where 1=1 and org.CREATE_ADMIN = u.admin_id
         and org.RECEIVE_WH=w.warehouse_code
  
       
		
		<if test="sgrNo != null and sgrNo != ''">
			and org.SGR_NO = #{sgrNo}
		</if>

		<if test="sendDate != null and sendDate != ''">
			and to_char(org.RECEIPT_END_TIME,'yyyy-mm-dd') =  #{sendDate}
		</if>
		
		   order by org.RECEIPT_END_TIME desc
	<![CDATA[ ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	<!-- 入库单详情 -->
	<select id="getGoodsReceiptDetailBysgrNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">
		select detail.sgr_no       as sgrNo,
       detail.sequence_no  as sequenceNo,
       detail.receipt_type as receiptType,
       detail.ref_no       as refNo,
       detail.valid_number as validNumber,
       detail.plan_code    as planCode,
       detail.batch_no     as batchNo,
       detail.trunk_no     as trunkNo,
       detail.box_no       as boxNo,
       detail.package_no   as packageNo,
       detail.tickets      as tickets,
       detail.amount       as amount,
       gp.FULL_NAME      as planName
  from WH_GOODS_RECEIPT_DETAIL detail
  left join GAME_PLANS gp
    on detail.plan_code = gp.plan_code
    
  where 1=1 and detail.sgr_no=#{sgrNo}
   order by detail.plan_code,
          detail.batch_no,
          detail.valid_number,
          detail.trunk_no,
          detail.box_no,
          detail.package_no
	</select>
	<!-- 方案list -->
	<select id="getAllGamePlan" resultType="cls.pilottery.web.goodsreceipts.model.GamePlans">
	select distinct gp.plan_code as planCode, 
           gp.full_name as fullName
      from GAME_PLANS gp, GAME_BATCH_IMPORT_DETAIL de where gp.plan_code=de.plan_code
      and de.status=1
	
	</select>
	<!-- 根据方案code查询此方案下的批次信息 -->
	<select id="getGameBatchInfoBypanCode" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GameBatchImport">
  select a.planCode as planCode,a.batchNo as batchNo
   from (select planCode, batchNo
  from (select ba.plan_code as planCode,
               ba.batch_no as batchNo,
               b.plan_code || b.batch_no as signcode
          from GAME_BATCH_IMPORT_DETAIL ba
          left join wh_batch_inbound b
            on (ba.plan_code = b.plan_code and ba.batch_no = b.batch_no)
         where 1 = 1
           and ba.status = 1) x
 where x.signcode is null) a
 where a.planCode=#{planCode}
	</select>
	
    <select id="getGamePlanOrBatchInfo" parameterType="cls.pilottery.web.goodsreceipts.model.GoodReceiptParamt" 
    resultType="cls.pilottery.web.goodsreceipts.model.GameBatchImportDetail">
	       select ta.plan_code           as planCode,
         ta.batch_no            as batchNo,
         gp.ticket_amount       as ticketAmount,
         ta.FIRST_TRUNK_BATCH   as firstTrunkBath,
         ta.TICKETS_EVERY_BATCH as ticketsEveryBatch,
         ta.BOXES_EVERY_TRUNK   as boxesEveryTrunk,
         ta.TICKETS_EVERY_GROUP as ticketsEveryGroup
    from GAME_BATCH_IMPORT_DETAIL ta, GAME_PLANS gp
   where ta.plan_code = gp.plan_code
   and  ta.status=1
   <if test="planCode!=null and planCode!=''">
   and  ta.plan_code=#{planCode} 
   </if>
	 <if test="batchNo!=null and batchNo!=''">
	  and  ta.batch_no =#{batchNo}
	 </if>
	
    </select>
    <update id="addGameBath" statementType="CALLABLE" parameterType="cls.pilottery.web.goodsreceipts.model.GameBatchParamt">
		 {call   p_batch_inbound(
    	        #{sgrNo,mode=IN,jdbcType=VARCHAR},
    	        #{planCode,mode=IN,jdbcType=VARCHAR}, 
    	        #{batchCode,mode=IN,jdbcType=VARCHAR}, 
    	        #{warehouseId,mode=IN,jdbcType=NUMERIC},
    	        #{opertType,mode=IN,jdbcType=NUMERIC},
    	        #{userId,mode=IN,jdbcType=NUMERIC},
    	        #{packUnitValue,mode=IN,jdbcType=NUMERIC},
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}
    	      
    	        	        
		 	)
		 }
	</update>
	<!-- 入库和实际总量 -->
	<select id="getGameReceiptActAmount" parameterType="cls.pilottery.web.goodsreceipts.model.GoodReceiptParamt" resultType="Long">
		  select  nvl(ac.ACT_RECEIPT_TICKETS,0)
		  from WH_GOODS_RECEIPT ac
		  where 1=1
		  <if test="sgrNo!=null and sgrNo!=''">
		     and ac.REF_NO=#{sgrNo}
		  </if>
		  <if test="stbNo!=null and stbNo!=''">
		     and ac.REF_NO=#{stbNo}
		  </if>
		 <if test="returnNo!=null and returnNo!=''">
		   and ac.REF_NO=#{returnNo}
		  </if>
	
	</select>
	<select id="getGameReceiptAmount" parameterType="cls.pilottery.web.goodsreceipts.model.GoodReceiptParamt" resultType="Long">
	 select  nvl(ac.RECEIPT_TICKETS,0)
		  from WH_GOODS_RECEIPT ac
		  where 1=1
		  <if test="sgrNo!=null and sgrNo!=''">
		    and ac.REF_NO=#{sgrNo}
		  </if>
		  <if test="stbNo!=null and stbNo!=''">
		   and ac.REF_NO=#{stbNo}
		  </if>
		  <if test="returnNo!=null and returnNo!=''">
		   and ac.REF_NO=#{returnNo}
		  </if>
	</select>
	<!-- 根据方案Code查询方案 -->
		<select id="getGamePlanInfoByCode" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GamePlans" >
		select gp.plan_code as planCode, 
		       gp.full_name as fullName
		  from GAME_PLANS gp where 1=1 and gp.plan_code=#{planCode}
	
	</select>
	<!-- 完成批次入库 -->
	<update id="updateGoodReceiptComplete" parameterType="cls.pilottery.web.goodsreceipts.model.GoodReceiptParamt">
		update WH_GOODS_RECEIPT
		set STATUS=2
		where SGR_NO=#{sgrNo}
	</update>
	<select id="getGoodsDamagedByNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceipt">
	select u.plan_code            as planCode,
       gp.full_name           as planName,
       u.batch_no             as batchNo,
       org.receipt_tickets    as receiptTickets,
       org.act_receipt_amount actReceiptAmount

  from WH_GOODS_RECEIPT org, WH_GOODS_RECEIPT_DETAIL u, game_plans gp

 where 1 = 1
   and org.sgr_no = u.sgr_no
   and u.plan_code = gp.plan_code
   and org.sgr_no=#{sgrNo}
	</select>
	<select id="getGoodsReceiptDetailsumBysgrNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">
	select 
       sum(detail.tickets)      as tickets,
       sum(detail.amount)       as amount
      
  from WH_GOODS_RECEIPT_DETAIL detail

   
 where 1 = 1 and detail.sgr_no=#{sgrNo}
	</select>
	<select id="getGoodetailPlancodeByreNO" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">
	select de.plan_code as planCode, de.batch_no as batchNo
  from WH_GOODS_RECEIPT_DETAIL de
 where de.ref_no = #{sgrNo}
	<![CDATA[and rownum <=1 ]]>
	
	</select>
	<select id="getReciveStrockByorgCode" parameterType="String" resultType="cls.pilottery.web.sales.entity.StockTransfer">
		SELECT STB_NO stbNo,
		b.ORG_NAME sendOrgName
         FROM SALE_TRANSFER_BILL a
              JOIN INF_ORGS b ON (a.SEND_ORG = b.ORG_CODE)
        where 1=1 and a.STATUS=4 and a.receive_org=#{orgCode}
</select>
<select id="getGamePlanOrBatchInfoSum" parameterType="cls.pilottery.web.goodsreceipts.model.GoodReceiptParamt" 
    resultType="cls.pilottery.web.goodsreceipts.model.GameBatchImportDetail">
select sum(ta.TICKETS_EVERY_BATCH) as ticketsEveryBatch

  from GAME_BATCH_IMPORT_DETAIL ta,
       GAME_PLANS gp,
       (select distinct de.plan_code as planCode,
                        de.batch_no  as batchNo,
                        de.ref_no    as refNo
          from WH_GOODS_RECEIPT ac, WH_GOODS_RECEIPT_DETAIL de
         where de.sgr_no = ac.sgr_no
           and ac.ref_no = de.ref_no
           <if test="stbNo!=null and stbNo!=''">
             and de.ref_no =#{stbNo}
           </if>
          <if test="returnNo!=null and returnNo!='">
            and de.ref_no =#{returnNo}
          </if>
           
           ) b
 where ta.plan_code = gp.plan_code
   and b.planCode = ta.plan_code
   and b.batchno = ta.batch_no
   and ta.status = 1
</select>
<select id="getGoodsReceiptsPrintList" parameterType="String" 
    resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">
  select de.plan_code as planCode,
       de.batch_no  as batchNo,
       gp.full_name as planName,
       gp.ticket_amount as tickAmount,
       nvl(sum(de.tickets),0)      as tickets,
       nvl(sum(de.amount),0)       as amount
      
  from WH_GOODS_RECEIPT_DETAIL de, game_plans gp
 where de.plan_code = gp.plan_code
   and de.ref_no =#{refNo}
    group by de.plan_code,de.batch_no,gp.full_name,gp.ticket_amount
</select>
<select id="getGoodsReceiptsPrintByrefNo"  parameterType="String" 
    resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceipt">
select distinct de.RECEIPT_END_TIME as sendDate,
                g.org_name          as sendOrg,
                a.admin_realname    as sendOperater,
                de.REMARK           as remark,
                de.receipt_tickets as receiptTickets,
                de.act_receipt_tickets as actReceiptTickets
  from WH_GOODS_RECEIPT de, INF_ORGS g, WH_MANAGER w, adm_info a
 where de.receive_wh = w.warehouse_code
   and w.org_code = g.org_code
   and a.admin_id = de.create_admin
   and de.ref_no =#{refNo}

</select>

<select id="getGoodsReceiptsPrintSumByrefNo" parameterType="String" 
    resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">
select 
       nvl(sum(de.tickets),0)      as tickets,
       nvl(sum(de.amount),0)       as amount
    
  from WH_GOODS_RECEIPT_DETAIL de
  where 1=1 and
  
   de.ref_no =#{refNo}

</select>
<select id="getGoodsReceiptsTranPrintByStbno" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.GoodsReceiptTrans">
select bi.stb_no   as stbNo,
       rg.org_name as receiveUnit,
       sg.org_name as sendUnit
  from SALE_TRANSFER_BILL bi, INF_ORGS rg, INF_ORGS sg
 where rg.org_code = bi.RECEIVE_ORG
   and sg.org_code = bi.send_org
   and bi.stb_no=#{refNo}

</select>
<select id="getGoodsReceiptsReturnPrintByStbno" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.ReturnRecoder" >
 select a.admin_realname as realName, g.org_name as orgName
  from SALE_RETURN_RECODER re, adm_info a, inf_orgs g
 where re.market_manager_admin = a.admin_id
   and re.receive_org = g.org_code
   and re.return_no=#{refNo}
</select>
<select id="getGoodsReceiptsDetailInfoByRefNo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceiptDetail">     
 <!--     select uk.sgrno as sgrNo,
        uk.ref_no,
        uk.plancode as planCode,
        uk.batchno as batchNo,
        uk.planname  as planName,
        sum(uk.trunkcount) as trunkCount,
        sum(uk.boxcount) as boxCount,
        sum(uk.packcount) as packCount,
        sum(uk.tickets) as tickets,
        sum(uk.amount) as amount
   from (
     select de.sgr_no as sgrno,
            de.ref_no,
            de.valid_number as validnumber,
            de.plan_code as plancode,
            de.batch_no as batchno,
            (case de.valid_number WHEN 1 THEN 1 ELSE 0 END) as trunkcount,   
            (case de.valid_number WHEN 1 THEN bi.boxes_every_trunk WHEN 2 THEN  1 ELSE  0 END) as boxcount,    
            (case de.valid_number WHEN 1 THEN bi.boxes_every_trunk WHEN 2 THEN  1 ELSE  0 END) as packcount,        
            de.tickets   as tickets,
            de.amount    as amount,
            gp.full_name as planname
       from wh_goods_receipt_detail de
       left join game_plans gp
         on de.plan_code = gp.plan_code
       left join game_batch_import_detail bi
         on (de.plan_code = bi.plan_code and de.batch_no = bi.batch_no)
      where de.ref_no = #{refNo}
  )uk group by uk.sgrno,uk.ref_no,uk.plancode,uk.batchno,uk.planname -->
select de.plan_code as planCode,
       de.valid_number as validNumber,
       sum(de.tickets) as tickets,
       sum(de.amount) as amount
  from wh_goods_receipt_detail de
  where 1=1 and de.ref_no=#{refNo}
 group by de.plan_code, de.valid_number
</select>
 <update id="addDamage" statementType="CALLABLE" parameterType="cls.pilottery.web.goodsreceipts.model.DamageVo">
		 {call   p_warehouse_damage_register(
    	        #{opradmin,mode=IN,jdbcType=NUMERIC},
    	        #{checktype,mode=IN,jdbcType=NUMERIC}, 
    	        #{refcode,mode=IN,jdbcType=VARCHAR},
    	         #{remark,mode=IN,jdbcType=VARCHAR},
    	        #{extendarg,mode=IN,jdbcType=VARCHAR},
    	        #{registercode,mode=OUT,jdbcType=VARCHAR},
    	        #{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	        #{c_errmsg,mode=OUT,jdbcType=VARCHAR}
    	      
    	        	        
		 	)
		 }
	</update>
	<select id="getGoodsReceiptsSumTickts" parameterType="String" resultType="Integer">
		select 
	       sum(de.tickets) as tickets
	  from wh_goods_receipt_detail de
	  where 1=1 and de.ref_no=#{refNo}
	</select>
<select id="getGameBatchInfoTemp"  resultType="cls.pilottery.web.goodsreceipts.model.GamePlanVo">
select g.plan_code            as planCode,
       g.full_name            as planName,
       gb.batch_no            as batchNo,
       g.ticket_amount        as amount,
       de.TICKETS_EVERY_GROUP as ticketsEveryGroup
  from game_plans g, GAME_BATCH_IMPORT gb, GAME_BATCH_IMPORT_DETAIL de
 where 1 = 1
   and g.plan_code = gb.plan_code
   and g.plan_code = de.plan_code
      
   and de.status = 1

</select>
<select id="getPlanListTemp" parameterType="String" resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">

select p.plan_code as planCode,
       p.full_name as planName,
       d.tickets  as actTickts,
       nvl(r3.trunk, 0) as trunk,
       nvl(r2.box, 0) as box,
       nvl(r1.pkg, 0) as pkg,
       nvl(r4.tickets, 0) as  tickets
  from game_plans p
 inner join (select plan_code,sum(tickets_every_batch) tickets from game_batch_import_detail group by plan_code)
 d on d.plan_code = p.plan_code
  left join (select t1.plan_code, count(*) pkg
               from wh_ticket_package t1
               left join wh_ticket_box b1
                 on (t1.plan_code = b1.plan_code and
                    t1.batch_no = b1.batch_no and t1.trunk_no = b1.trunk_no and
                    t1.box_no = b1.box_no)
              where t1.is_full = 1
                and b1.is_full = 0
                and t1.status = 11
         and t1.current_warehouse =#{houseCode}
              group by t1.plan_code) r1
    on d.plan_code = r1.plan_code
  left join (select t2.plan_code, count(*) box
               from wh_ticket_box t2
               left join wh_ticket_trunk b2
                 on (t2.plan_code = b2.plan_code and
                    t2.batch_no = b2.batch_no and t2.trunk_no = b2.trunk_no)
              where t2.is_full = 1
                and b2.is_full = 0
                and t2.status = 11
             and t2.current_warehouse =#{houseCode}
              group by t2.plan_code) r2
    on d.plan_code = r2.plan_code
  left join (select t3.plan_code, count(*) trunk
               from wh_ticket_trunk t3
              where t3.is_full = 1
                and t3.status = 11
             and t3.current_warehouse =#{houseCode}
              group by t3.plan_code) r3
    on d.plan_code = r3.plan_code
  left join (select t4.plan_code, sum(d4.tickets_every_pack) tickets
               from wh_ticket_package t4
               left join game_batch_import_detail d4
                 on t4.plan_code = d4.plan_code
                and t4.batch_no = d4.batch_no
              where t4.status = 11
                and t4.is_full = 1
           and t4.current_warehouse =#{houseCode}
              group by t4.plan_code) r4
    on d.plan_code = r4.plan_code

</select>
<select id="getPlanListTempDiff" parameterType="String"  resultType="cls.pilottery.web.goodsIssues.model.GoodsIssueDetailVo">

select p.plan_code as planCode,
       p.full_name as planName,
       d.tickets as receivableTickets,
       nvl(r4.tickets, 0) as receivabedTickets,
       d.tickets - nvl(r4.tickets, 0) as  diff
  from game_plans p
 inner join (select plan_code, sum(tickets_every_batch) tickets
               from game_batch_import_detail
              group by plan_code) d
    on d.plan_code = p.plan_code

  left join (select t4.plan_code, sum(d4.tickets_every_pack) tickets
               from wh_ticket_package t4
               left join game_batch_import_detail d4
                 on t4.plan_code = d4.plan_code
                and t4.batch_no = d4.batch_no
              where t4.status = 11
                and t4.is_full = 1
             and t4.current_warehouse = #{houseCode}
              group by t4.plan_code) r4
    on d.plan_code = r4.plan_code

</select>
<select id="getRemarkByRefo" parameterType="String" resultType="cls.pilottery.web.goodsreceipts.model.WhGoodsReceipt">
 select org.sgr_no       as sgrNo,
       org.RECEIPT_END_TIME           as sendDate,
      
       org.status              as status,
       org.ACT_RECEIPT_TICKETS as actReceiptTickets,
       org.act_receipt_amount  as actReceiptAmount,
       org.receipt_type        as receiptType,
       org.receipt_tickets     as receiptTickets,
       org.REF_NO              as refNo,
        org.remark as remark
       from 
  WH_GOODS_RECEIPT  org where 1=1 and  org.ref_no=#{refNo}
       
</select>
</mapper>
