<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.lottery.dao.ExpirydateDao">
	<resultMap type="cls.pilottery.oms.lottery.model.SaleGamepayinfo"
		id="saleGamepayinfo">
		<id column="GUI_PAY_FLOW" property="id" />
		<result column="SALE_TSN" property="saleTsn" />
		<result column="GAME_CODE" property="gameCode" />
		<result column="ISSUE_NUMBER" property="issueNumber" />
		<result column="PAY_AMOUNT" property="payAmount" />
		<result column="PAY_TAX" property="payTax" />
		<result column="PAY_AMOUNT_AFTER_TAX" property="payamountAftertax" />
		<result column="WINNERNAME" property="winnerName" />
		<result column="GENDER" property="gender" />
		<result column="CERT_TYPE" property="certType" />
		<result column="CERT_NO" property="certNo" />
		<result column="AGE" property="age" />
		<result column="CONTACT" property="contact" />
		<result column="PAYER" property="payer" />
		<result column="PAY_TIME" property="payTime" />
		<result column="PAY_ADDR" property="payAddr" />
		<result column="IS_SUCCESS" property="isSucess" />
		<result column="ORG_CODE" property="agencyCode" />
		<result column="HTML_TEXT" property="htmlText" />
		<result column="pay_tsn" property="htmlText" />
	</resultMap>
	<select id="getSaleGamepaycount" parameterType="cls.pilottery.oms.lottery.form.SaleGamepayinfoForm"
		resultType="Integer">
		select count(1)
		from SALE_GAMEPAYINFO s
		left join INF_GAMES ga
		on
		s.game_code = ga.game_code
		where 1=1

		<if test="payer != null and payer!=''">
			and s.PAYER_NAME = #{payer}  
        </if>
		<if test="startpayTime != null and startpayTime!=''">  
           <![CDATA[ and s.pay_time >= to_date(#{startpayTime},'yyyy-MM-dd HH24:MI:SS')  ]]>
		</if>
		<if test="endpayTime!=null and endpayTime!=''">
         <![CDATA[  and s.pay_time<=to_date(#{endpayTime},'yyyy-MM-dd HH24:MI:SS') ]]>
		</if>
		<if test="areaCode!=null and areaCode!=''">
			<if test="areaCode!=0">
				and s.ORG_CODE like #{ areaCode}||'%'
			</if>
		</if>
	</select>
	<select id="getSaleGameList" parameterType="cls.pilottery.oms.lottery.form.SaleGamepayinfoForm"
		resultType="cls.pilottery.oms.lottery.vo.SaleGamepayinfoVo">
		select *
		from (select b.*,rownum rn from(select s.PAYER_NAME as payer,
		s.gui_pay_flow as id,
		s.pay_time as payTime,
		s.sale_tsn as saleTsn,
		ga.short_name as playName,
		s.pay_amount as payAmount,
		s.IS_SUCCESS as isSucess,
		s.ORG_CODE as
		agencyCode
		from SALE_GAMEPAYINFO s
		left join INF_GAMES ga
		on s.game_code = ga.game_code
		where 1=1
		<if test="payer != null and payer!=''">
			and s.PAYER_NAME = #{payer}  
        </if>
		<if test="startpayTime != null and startpayTime!=''">  
           <![CDATA[ and s.pay_time >= to_date(#{startpayTime},'yyyy-MM-dd HH24:MI:SS')  ]]>
		</if>
		<if test="endpayTime!=null and endpayTime!=''">
         <![CDATA[  and s.pay_time<=to_date(#{endpayTime},'yyyy-MM-dd  HH24:MI:SS') ]]>
		</if>
		<if test="areaCode!=null and areaCode!=''">
			<if test="areaCode!=0">
				and s.ORG_CODE like #{ areaCode}||'%'
			</if>
		</if>
order by s.GUI_PAY_FLOW desc
		)b ) where
    <![CDATA[
     rn >
    ${beginNum} and rn <= ${endNum}
    ]]>
	</select>
	<select id="getTicketpay" parameterType="Long" resultType="String">
		select F_GET_SALE_GUIPAY_SEQ(#{pcode}) id from dual
   </select>
	<insert id="insertSalegame" parameterType="cls.pilottery.oms.lottery.form.ExpirydateForm">
		insert into SALE_GAMEPAYINFO (
		GUI_PAY_FLOW,SALE_TSN,APPLYFLOW_SALE,
		GAME_CODE,ISSUE_NUMBER,PAY_AMOUNT,
		PAY_TAX,PAY_AMOUNT_AFTER_TAX,WINNERNAME,
		GENDER,CERT_TYPE,CERT_NO,
		birthdate,ORG_CODE,PAYER_ADMIN,PAY_TIME,PAYER_NAME
		<if test="contact!=null and contact!=''">
			,CONTACT
        </if>
		<if test="htmlText!=null and htmlText!=''">
			,HTML_TEXT
        </if>
        <if test="tsn!=null and tsn!=''">
        ,PAY_TSN
        </if>
        <if test="issuenumbrend!=null and issuenumbrend!=''" >
        ,ISSUE_NUMBER_END
        </if>
        ,IS_SUCCESS
		) values
		(#{guipayFlow},#{tsnquery},#{reqfnticket},
		#{gameCode},#{issuenumber},#{payAmount},
		#{payTax},#{payamountAftertax},#{name},
		#{sex},#{cardType},#{carId},
		#{birthdate},#{payagencycode},#{payerAdmin},sysdate,#{realname}
		<if test="contact!=null and contact!=''">
			,#{contact}
        </if>
		<if test="htmlText!=null and htmlText!=''">
			,#{htmlText}
        </if>
 		<if test="tsn!=null and tsn!=''">
        ,#{tsn}
        </if>
        <if test="issuenumbrend!=null and issuenumbrend!=''">
        ,#{issuenumbrend}
        </if>
        ,1
		)
	</insert>
	<select id="getSalegameById" parameterType="String"
		resultType="cls.pilottery.oms.lottery.model.SaleGamepayinfo">
		select t.gui_pay_flow as id,
		t.pay_tsn as payTsn,
		t.sale_tsn
		as saleTsn,
		t.applyflow_sale as applyflowSale,
		t.game_code as gameCode,
		t.issue_number as issueNumber,
		t.pay_amount as payAmount,
		t.pay_tax as
		payTax,
		t.pay_amount_after_tax as payamountAftertax,
		t.winnername as
		winnerName,
		t.ORG_CODE as agencyCode,
		t.cert_no as certNo,
		t.html_text as htmlText,
		t.ISSUE_NUMBER_END as issuenumbrend,
		 ga.short_name as playname,
		   t.pay_time as payTime,
		  to_char(t.ORG_CODE,'00000000') as agencyCodeFormart
		from SALE_GAMEPAYINFO t left join  inf_games ga on t.game_code=ga.game_code
		where 1 = 1 and
		trim(t.gui_pay_flow)=#{id}
   </select>
    <select id="getReconciliationCount" parameterType="cls.pilottery.oms.lottery.form.ReconciliationForm" resultType="Integer">
    	select count(1)
		from MIS_REPORT_AGENCY fm where 1=1
		<if test="agencyCode!=null and agencyCode!=0">
			and fm.agency_code=#{agencyCode}
		</if>
    </select>
	<select id="getReconciliationList" parameterType="cls.pilottery.oms.lottery.form.ReconciliationForm"
		resultType="cls.pilottery.oms.lottery.model.ReconciliationVo">
	select * from (select b.*,rownum rn from (select fm.FUND_HIS_CODE as id,
       fm.agency_code   as agencyCode,
       fm.agency_name   as agencyName,
       fm.fund_amount   as operAmount,
       fm.count_date    as operTime,
       fm.fund_type     as state
  from MIS_REPORT_AGENCY fm  where 1=1
		<if test="agencyCode!=null and agencyCode!=0">
			and	fm.agency_code=#{agencyCode}
		</if>
		 order by fm.count_date desc
		)b ) where
		<![CDATA[
     rn >
    ${beginNum} and rn <= ${endNum}
    ]]>
	</select>
	<select id="getSalegameByTsn"  parameterType="String" resultType="cls.pilottery.oms.lottery.model.SaleGamepayinfo">
	  select t.gui_pay_flow as id,
    t.pay_tsn as payTsn,
    t.sale_tsn
    as saleTsn,
    t.applyflow_sale as applyflowSale,
    t.game_code as gameCode,
    t.issue_number as issueNumber,
    t.pay_amount as payAmount,
    t.pay_tax as
    payTax,
    t.pay_amount_after_tax as payamountAftertax,
    t.winnername as
    winnerName,
    t.ORG_CODE as agencyCode,
    t.cert_no as certNo,
    t.html_text as htmlText,
    ga.short_name as playname,
    t.ISSUE_NUMBER_END as issuenumbrend,
    t.pay_time as payTime,
    to_char(t.ORG_CODE,'000000') as agencyCodeFormart,
    t.cert_type as certType
    from SALE_GAMEPAYINFO t left join  inf_games ga on t.game_code=ga.game_code
		where 1 = 1 and  t.SALE_TSN=#{tsn}
	</select>
	<select id="getPrizeName" parameterType="Map" resultType="String">
	select t.prule_name 
  		from v_gp_prize_rule_current t
 		where t.game_code = #{gameCode}
  		 and t.prule_level =#{prizecode}
	</select>
</mapper>
