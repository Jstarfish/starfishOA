<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.oms.business.dao.TerminalDao">
 <resultMap type="cls.pilottery.web.area.model.AreaParent" id="parentResult">
		<constructor>
	  		<idArg javaType="Long" column="AGENCY_CODE"/>
	  		<arg javaType="String" column="AGENCY_NAME"/>
	  </constructor>	  
	</resultMap>
 	<resultMap type="cls.pilottery.oms.business.model.Terminal" id="terminalResult">
		<id column="TERMINAL_CODE" property="terminalCode" />	
		<result column="TERMINAL_CODE_TOCHAR" property="terminalCodeToChar" />	
		<result column="AGENCY_CODE_TOCHAR" property="agencyCodeToChar"/>
		<result column="AGENCY_NAME" property="agencyName"/>
		<result column="UNIQUE_CODE" property="uniqueCode" />
		<result column="TERM_TYPE_ID" property="terminalType" />
		<result column="MAC_ADDRESS" property="macAddress" />	
		<result column="AGENCY_CODE" property="agencyCode"/>
		<!-- 复杂类型 -->
		<result column="STATUS" property="terminalStatus" javaType="cls.pilottery.oms.business.model.TerminalStatus" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.TerminalStatusTypeHandler" />
		<result column="TRAINING_MODE" property="trainingMode" javaType="cls.pilottery.oms.business.model.TerminalYesNoType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.TerminalYesNoTypeTypeHandler"/>
		<result column="TERMINAL_FOR_PAYMENT" property="forPayment" javaType="cls.pilottery.oms.business.model.TerminalYesNoType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.TerminalYesNoTypeTypeHandler"/>
		<result column="ENABLE_TELLER_LOGON" property="enableTellerLogon" javaType="cls.pilottery.oms.business.model.TerminalYesNoType" jdbcType="NUMERIC" typeHandler="cls.pilottery.oms.business.model.TerminalYesNoTypeTypeHandler"/>
			<!-- 关联查询	 -->
			
		
	</resultMap>
		<resultMap type="cls.pilottery.oms.business.model.TerminalType" id="terminalTypeResult">
		<id column="TERM_TYPE_ID" property="typeCode" />
		<result column="TERM_TYPE_DESC" property="typeName" />
	</resultMap>
	
	<!-- 	推荐码 -->
	<select id="recomandNum" parameterType="String" resultType="java.lang.String">
		SELECT #{agencyCode} || lpad(MIN(serial_no), 2, '0')
	     FROM (SELECT level serial_no
	             FROM dual
	     <![CDATA[ CONNECT BY level < 100
	           MINUS
	           SELECT to_number(substr(terminal_code, 9, 2)) serial_no
	             FROM saler_terminal
	            WHERE agency_code = #{agencyCode}) ]]>
	</select>
	<select id="selectTerminalLimitInCity" parameterType="String" resultType="Integer">
    	 select inf_areas.TERMINAL_NUMBER_LIMIT 
    	   from saler_agency, inf_areas
    	  where saler_agency.agency_code = #{agencyCode} and inf_areas.area_code = saler_agency.area_code    	  
    </select>
    <select id="selectTerminalCountInCity" parameterType="long" resultType="Integer" >
	  select count(saler_terminal.terminal_code)
	  		from saler_agency, saler_terminal
	  where
	        saler_agency.area_code = #{areaCode} and saler_agency.agency_code = saler_terminal.agency_code	
	        and   (saler_agency.STATUS=1 or saler_agency.STATUS=2) and (saler_terminal.STATUS=1 or saler_terminal.STATUS=2)
	</select>
	
		<update id="insertTerminal" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.Terminal">
		 {call P_OM_TERMINAL_CREATE(
		 	#{terminalCode,mode=IN,jdbcType=NUMERIC},
		 	#{agencyParent.code,mode=IN,jdbcType=NUMERIC},
		 	#{terminalStatus,mode=IN,javaType=cls.pilottery.oms.business.model.TerminalStatus,jdbcType=NUMERIC,typeHandler=cls.pilottery.oms.business.model.TerminalStatusTypeHandler},
		 	#{trainingMode,mode=IN,jdbcType=NUMERIC,javaType=cls.pilottery.oms.business.model.TerminalYesNoType,typeHandler=cls.pilottery.oms.business.model.TerminalYesNoTypeTypeHandler},
		 	#{macAddress,mode=IN,jdbcType=VARCHAR},
		 	#{uniqueCode,mode=IN,jdbcType=VARCHAR},
		 	#{terminalType,mode=IN,jdbcType=NUMERIC},
		 	#{softNo,mode=IN,jdbcType=VARCHAR},
		 	#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	    #{c_errmsg,mode=OUT,jdbcType=VARCHAR},
    	    #{terminalCode,mode=OUT,jdbcType=NUMERIC}
		  )	
		 }	
		
	</update>
	
	<select id="selectSameMacCount" parameterType="java.lang.String" resultType="Integer" >
		SELECT count(1)
		FROM SALER_TERMINAL
	    WHERE upper(MAC_ADDRESS) = upper('${macAddress}')		
	    and STATUS != 3
		  	
	</select>	
		<select id="countTerminalList" parameterType="cls.pilottery.oms.business.form.TerminalForm" resultType="Integer" >
		SELECT count(1)
		FROM SALER_TERMINAL left join saler_agency on saler_terminal.agency_code = saler_agency.agency_code
      	left join inf_areas on Saler_Agency.Area_Code = inf_areas.area_code
      	where 1=1 
		  <if test="areaCode != null and areaCode!=0">
			 AND (inf_areas.area_code = #{areaCode} or inf_areas.father_area = #{areaCode})
		  </if>
          <if test="agencyCode != null">
 			 and SALER_AGENCY.agency_code = ${agencyCode}
		  </if>
		  <if test="agencyName != null and agencyName != ''">
		     and SALER_AGENCY.agency_name like '%'||#{agencyName}||'%'
		  </if>
		  <if test="agencyStatus != null and agencyStatus.value != 0">
		     and  SALER_AGENCY.STATUS = ${agencyStatus.value}
		  </if>
          <if test="terminalCode != null">
		 	and TERMINAL_CODE = ${terminalCode}
		  </if>
		  <if test="terminalUniqueCode != null and terminalUniqueCode != ''">
		    and UNIQUE_CODE = #{terminalUniqueCode}
		  </if>
		  <if test="terminalMAC != null and terminalMAC != ''">
		    and upper(MAC_ADDRESS) = upper('${terminalMAC}')
		  </if>
		  <if test="terminalStatus != null and terminalStatus.value != 0">
		 	and SALER_TERMINAL.STATUS = ${terminalStatus.value}
		  </if>	
	</select>
	<select id="queryTerminalList" parameterType="cls.pilottery.oms.business.form.TerminalForm" resultMap="terminalResult">
		select * from (
		select a.*,rownum rn from (
		SELECT  
			   SALER_TERMINAL.terminal_code,
               SALER_TERMINAL.terminal_code TERMINAL_CODE_TOCHAR, 
               SALER_TERMINAL.agency_code AGENCY_CODE_TOCHAR, 
               SALER_TERMINAL.unique_code, 
               SALER_TERMINAL.term_type_id, 
               SALER_TERMINAL.mac_address, 
               SALER_TERMINAL.security_id, 
               SALER_TERMINAL.status, 
               SALER_TERMINAL.training_mode, 
               SALER_TERMINAL.terminal_for_payment, 
               SALER_TERMINAL.is_logging, 
               SALER_TERMINAL.latest_login_teller_code, 
               SALER_TERMINAL.trans_seq, 
               SALER_AGENCY.AGENCY_NAME
		FROM
      	SALER_TERMINAL left join saler_agency on saler_terminal.agency_code = saler_agency.agency_code
      	left join inf_areas on Saler_Agency.Area_Code = inf_areas.area_code
      	where 1=1 
				 <if test="areaCode != null and areaCode!=0">
				      AND (inf_areas.area_code = #{areaCode} or inf_areas.father_area = #{areaCode})
				 </if>
	              <if test="agencyCode != null">
		 			and SALER_AGENCY.agency_code = ${agencyCode}
				  </if>
				  <if test="agencyName != null and agencyName != ''">
				   and SALER_AGENCY.agency_name like '%${agencyName}%'
				  </if>
				  <if test="agencyStatus != null and agencyStatus.value != 0">
				   and  SALER_AGENCY.STATUS = ${agencyStatus.value}
				  </if>
          <if test="terminalCode != null">
		 	and TERMINAL_CODE = ${terminalCode}
		  </if>
		  <if test="terminalUniqueCode != null and terminalUniqueCode != ''">
		    and UNIQUE_CODE = #{terminalUniqueCode}
		  </if>
		  <if test="terminalMAC != null and terminalMAC != ''">
		    and upper(MAC_ADDRESS) = upper('${terminalMAC}')
		  </if>
		  <if test="terminalStatus != null and terminalStatus.value != 0">
		 	and SALER_TERMINAL.STATUS = ${terminalStatus.value}
		  </if>
		  and (saler_terminal.status = 1 or saler_terminal.status = 2)
		  <![CDATA[ order by TERMINAL_CODE) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
		<!-- 启用、禁用、清退用这个函数 -->
	<update id="updateStatus" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.Terminal" >
		{call p_om_terminal_status_ctrl(
			#{terminalCode,mode=IN,jdbcType=NUMERIC},
			#{terminalStatus.value,mode=IN,jdbcType=NUMERIC},
			#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	    #{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		)}
	</update>
		<select id="selectTerminalByCode" parameterType="long" resultMap="terminalResult">
		SELECT SALER_TERMINAL.*, SALER_AGENCY.AGENCY_NAME, SALER_TERMINAL.terminal_code TERMINAL_CODE_TOCHAR
		FROM
			SALER_TERMINAL, SALER_AGENCY
		WHERE SALER_TERMINAL.TERMINAL_CODE=#{code} AND SALER_TERMINAL.AGENCY_CODE = SALER_AGENCY.AGENCY_CODE
	</select>
	
	<select id="selectTerminalTypes" resultMap="terminalTypeResult">
		SELECT TERM_TYPE_ID, TERM_TYPE_DESC
		FROM INF_TERMINAL_TYPES
	</select>	
	
	
	<update id="updateTerminal" statementType="CALLABLE" parameterType="cls.pilottery.oms.business.model.Terminal" >
		{call p_om_terminal_modify(
			#{terminalCode,mode=IN,jdbcType=NUMERIC},
			#{trainingMode.value,mode=IN,jdbcType=NUMERIC},
			#{macAddress,mode=IN,jdbcType=VARCHAR},
			#{uniqueCode,mode=IN,jdbcType=VARCHAR},
			#{terminalType,mode=IN,jdbcType=NUMERIC},
			#{c_errcode,mode=OUT,jdbcType=NUMERIC},
    	    #{c_errmsg,mode=OUT,jdbcType=VARCHAR}
		)}
		
	</update>
	
	<select id="selectTellerLimitInOrg" parameterType="String" resultType="Integer">
       select inf_areas.TELLER_NUMBER_LIMIT 
    	 from saler_agency, inf_areas
    	where saler_agency.agency_code = #{agencyCode} and inf_areas.area_code = saler_agency.area_code   	  
    </select>
    <select id="selectTellerCountInOrg" parameterType="String" resultType="Integer" >
	  	select count(1) from saler_teller
		join saler_agency using (agency_code)
		where area_code = (select area_code from saler_agency where agency_code = #{agencyCode})   
		and (saler_agency.STATUS=1 or saler_agency.STATUS=2)  and (saler_teller.STATUS=1 or saler_teller.STATUS=2)  
	</select>
	
</mapper>
