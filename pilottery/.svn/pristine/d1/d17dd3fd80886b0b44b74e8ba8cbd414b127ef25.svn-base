create or replace procedure p_cncp_ticket_fail
/****************************************************************/
   -- 出票失败
   -- add by chen zhen @ 2016-09-20
/*************************************************************/
(
  --------------输入----------------
  p_flow                              in char,          -- 申请流水

  --------------输入----------------
  c_error_code                        out number,        -- 错误码
  c_error_msg                         out varchar2       -- 错误内容

 ) is

  v_be_balance               number(28);                 -- 修改前账户余额
  v_af_balance               number(28);                 -- 修改后账户余额
  v_be_frozen_balance        number(28);                 -- 修改前账户冻结余额
  v_af_frozen_balance        number(28);                 -- 修改后账户冻结余额
  
  v_dealer                   cncp_inf_dealers.dealer_code%type;
  v_amount                   number(28);
  

begin

  dbtool.set_success(errcode => c_error_code, errmesg => c_error_msg);
  
  -- 修改记录状态为出票失败
  update cncp_trade_sale
     set order_status = ecncp_dealer_order_status.ticket_fail,
         ticket_time = sysdate
   where sale_flow = p_flow
  returning
    dealer_code, order_amount
  into
    v_dealer, v_amount;

  -- 退款
  p_cncp_dealer_fund_change(v_dealer, ecncp_flow_type.refund, v_amount, 0, p_flow, v_be_balance, v_af_balance, v_be_frozen_balance, v_af_frozen_balance);

  commit;

exception
  when others then
    rollback;
    c_error_code := -1;
    c_error_msg := error_msg.err_common_1 || sqlerrm;

end;
