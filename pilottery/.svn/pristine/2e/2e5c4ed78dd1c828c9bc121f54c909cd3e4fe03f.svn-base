<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cls.pilottery.fbs.dao.TeamDao">
	<resultMap type="cls.pilottery.fbs.model.Team" id="team">
		<id column="TEAM_CODE" property="teamCode" />
		<result column="COUNTRY_CODE" property="countryCode" />
		<result column="FULL_NAME" property="fullName" />
		<result column="SHORT_NAME" property="shortName" />
		<result column="REMARK" property="remark" />
	</resultMap>
	
	<!-- 分页记录总数 -->
	<select id="getTeamCount" parameterType="cls.pilottery.fbs.model.Team" resultType="Integer">
		select count(1) from FBS_COMPETITION_TEAM
	</select>
	
 	<!-- 部门列表 -->
	<select id="getTeamList" parameterType="cls.pilottery.fbs.model.Team"
		resultType="cls.pilottery.fbs.model.Team">
		select * from (
		select a.*,rownum rn from (
			select t.TEAM_CODE    as teamCode,
			       c.country_name as countryName,
			       t.FULL_NAME    as fullName,
			       t.SHORT_NAME   as shortName,
			       t.REMARK       as remark
			  from FBS_COMPETITION_TEAM t
			  left join fbs_country c
			    on t.country_code = c.country_code
			 where 1 = 1
			order by TEAM_CODE
	<![CDATA[ ) a ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>
	
	<!-- 获取国家信息 -->
	<select id="getCountry"  resultType="cls.pilottery.fbs.model.Country">
		select u.COUNTRY_CODE as countryCode, u.COUNTRY_NAME as countryName
  		from FBS_COUNTRY u where 1 = 1
	</select>
	
	<insert id="addTeam" parameterType="cls.pilottery.fbs.model.Team">
        INSERT INTO FBS_COMPETITION_TEAM (TEAM_CODE,SHORT_NAME,FULL_NAME,COUNTRY_CODE
        <if test="remark != null and remark != ''">
	  		,REMARK
	  	</if>
        )
        VALUES (#{teamCode},#{shortName},#{fullName},#{countryCode}
        <if test="remark != null and remark != ''">
	  		,#{remark}
	  	</if>
	  	)
	</insert>
	
	<select id="haveMatch" parameterType="string" resultType="Integer">
        SELECT COUNT(*) FROM FBS_MATCH WHERE 1 = 1
		   AND HOME_TEAM_CODE = #{teamCode}
		    or GUEST_TEAM_CODE = #{teamCode}
    </select>
    
    <delete id="deleteTeam" parameterType="cls.pilottery.fbs.model.Team">
        DELETE from FBS_COMPETITION_TEAM WHERE TEAM_CODE =#{teamCode}
    </delete>
    
    <select id="getMatchList" parameterType="string" resultType="cls.pilottery.fbs.model.Match">
        select t.match_code       as matchCode,
		       t.match_date       as matchDate,
		       t.home_team_code   as homeTeamCode,
		       t.guest_team_code  as guestTeamCode,
		       t.fh_home_score    as homeScore,
		       t.full_guest_score as guestScore,
		       t.win_los_score    as winLosScore,
		       t.FULL_TIME_RESULT as fullTimeResult,
		       f1.full_name       as homeTeamName,
		       f2.full_name       as guestTeamName
		  from FBS_MATCH t
		  left join fbs_competition_team f1
		    on t.home_team_code = f1.team_code
		  left join fbs_competition_team f2
		    on t.guest_team_code = f2.team_code
		 where f1.team_code = #{teamCode}
		    or f2.team_code = #{teamCode}
    </select>
    
    <select id="getTeamByCode" parameterType="String" resultMap="team">
		select t.team_code,
			   t.short_name,
		       t.full_name,
		       t.country_code,
		       t.remark,
		       c.country_name as countryName
		  from fbs_competition_team t
		  left join fbs_country c
		    on t.country_code = c.country_code
		 where t.team_code = #{teamCode}
    </select>
    
    <update id="modifyTeam" parameterType="cls.pilottery.fbs.model.Team">
        UPDATE fbs_competition_team
		   SET full_name    = #{fullName},
		   	   short_name   = #{shortName},
		       country_code = #{countryCode}
		  	<if test="remark != null and remark != ''">
		  		,remark  = #{remark}
		  	</if>
		 WHERE team_code = #{teamCode}
    </update>
    
    <select id="getMaxTeamCode" resultType="Integer">
    	select max(team_code) from fbs_competition_team
    </select>
    
    <select id="getMatchNumber" parameterType="String" resultType="cls.pilottery.fbs.model.Match">
    	with total as
		 (select count(1) totalCount,
		         sum(decode(FULL_TIME_RESULT, 3, 1, 0)) flatCount
		    from FBS_MATCH
		   where (HOME_TEAM_CODE = 1 or GUEST_TEAM_CODE = #{teamCode})),
		win as
		 (select sum(win_cnt) winCount, sum(score) score
		    from (select count(1) win_cnt, sum(FULL_HOME_SCORE) score
		            from FBS_MATCH
		           where HOME_TEAM_CODE = #{teamCode}
		             and FULL_TIME_RESULT = 1
		          union
		          select count(1) win_cnt, sum(FULL_GUEST_SCORE) score
		            from FBS_MATCH
		           where GUEST_TEAM_CODE = #{teamCode}
		             and FULL_TIME_RESULT = 2))
		select totalCount,
		       flatCount,
		       winCount,
		       score,
		       totalCount - flatCount - winCount as failCount
		  from total, win
    </select>
    
</mapper>
