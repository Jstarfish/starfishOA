<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cls.pilottery.web.capital.dao.InstitutionAcctDao">
	<resultMap id="InstitutionAcctMap" type="cls.pilottery.web.capital.model.InstitutionAccount">
		<id column="ORG_CODE" property="orgCode" jdbcType="CHAR" />
		<result column="ACC_TYPE" property="accType" jdbcType="DECIMAL" />
		<result column="ACC_NAME" property="accName" jdbcType="VARCHAR" />
		<result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
		<result column="ACC_STATUS" property="accStatus" jdbcType="DECIMAL" />
		<result column="ACC_NO" property="accNo" jdbcType="CHAR" />
		<result column="CREDIT_LIMIT" property="creditLimit" jdbcType="DECIMAL" />
		<result column="ACCOUNT_BALANCE" property="accountBalance" jdbcType="DECIMAL" />
		<result column="FROZEN_BALANCE" property="frozenBalance" jdbcType="DECIMAL" />
		<result column="CHECK_CODE" property="checkCode" jdbcType="VARCHAR" />
		 <collection property="institutionCommRate"
			ofType="cls.pilottery.web.capital.model.InstitutionCommRate">
			<id column="ORG_CODE" property="orgCode" jdbcType="CHAR" />
			<result column="PLAN_CODE" property="planCode" jdbcType="VARCHAR" />
			<result column="SALE_COMM" property="saleComm" jdbcType="DECIMAL" />
			<result column="PAY_COMM" property="payComm" jdbcType="DECIMAL" />
		</collection> 
	</resultMap>

	<!-- 代理商账户信息列表 -->
	<select id="getInstitutionAcctList" parameterType="cls.pilottery.web.capital.form.InstitutionAcctForm"
		resultMap="InstitutionAcctMap">
		select * from (
		select tab.*,rownum rn from (SELECT
		A.ORG_CODE,
		A.ACC_NAME,
		A.ACC_STATUS,
		A.ACC_NO,
		A.CREDIT_LIMIT,
		A.ACCOUNT_BALANCE,
		B.ORG_NAME,
		C.PLAN_CODE,
		C.SALE_COMM,
		C.PAY_COMM
		FROM ACC_ORG_ACCOUNT A
		LEFT
		JOIN
		INF_ORGS b ON (A.ORG_CODE = B.ORG_CODE)
		LEFT JOIN
		GAME_ORG_COMM_RATE C ON (A.ORG_CODE = C.ORG_CODE)
		WHERE 1 = 1
		<if test="orgCode != null and orgCode != ''">
			AND A.ORG_CODE = #{orgCode}
		</if>
		 <if test="orgName != null and orgName != ''">
			and B.ORG_NAME = #{orgName}
		</if> 
			and A.ACC_STATUS!=2
			and b.org_status = 1
			ORDER BY A.ORG_CODE DESC
		<![CDATA[ ) TAB ) where rn > ${beginNum} and rn <= ${endNum} ]]>
	</select>

	<!-- 分页记录总数 -->
	<select id="getInstitutionAcctCount" parameterType="cls.pilottery.web.capital.form.InstitutionAcctForm"
		resultType="Integer">
		SELECT count(1)
		FROM ACC_ORG_ACCOUNT a left join INF_ORGS b ON (A.ORG_CODE = B.ORG_CODE)
		WHERE 1 = 1
		<if test="orgCode != null and orgCode != ''">
			AND a.ORG_CODE = #{orgCode}
		</if>
		<if test="orgName != null and orgName != ''">
			and b.ORG_NAME = #{orgName}
		</if> 
	</select>

	 <select id="getInstitutionAcctInfo" parameterType="String"
		resultType="cls.pilottery.web.capital.model.InstitutionAccountModel">
		select a.org_code as orgcode,
		       a.credit_limit as creditlimit,
		       b.org_name as orgname,
		       d.plan_code as plancode,
		       nvl(c.sale_comm, 0) as salecomm,
		       nvl(c.pay_comm, 0) as paycomm,
		       d.full_name as planname
		  from game_plans d
		 cross join inf_orgs b
		  left join game_org_comm_rate c
		    on d.plan_code = c.plan_code
		   and c.org_code = b.org_code
		  left join acc_org_account a
		    on (a.org_code = b.org_code and a.acc_status = 1)
		 where d.plan_code in
		       (select plan_code
		          from game_batch_import_detail
		         where game_batch_import_detail.status = 1)
				and a.org_code = #{orgCode}
	</select>

	 <select id="getInstitutionAcctInfo2" parameterType="String"
		resultType="cls.pilottery.web.capital.model.InstitutionAccountModel">
		select a.org_code as orgcode,
           a.credit_limit as creditlimit,
           b.org_name as orgname
      from acc_org_account a
     left join inf_orgs b
        on (a.org_code = b.org_code and a.acc_status = 1)
		where a.org_code = #{orgCode}
	</select>
	
	<!-- 删除管理商账户 -->
	<update id="deleteupdeSatus" parameterType="String">
		UPDATE ACC_ORG_ACCOUNT SET ACC_STATUS =2 WHERE ORG_CODE=#{orgCode} 
	</update>

	<update id="updateInstitutionLimit" parameterType="map">
		UPDATE ACC_ORG_ACCOUNT SET CREDIT_LIMIT =#{creditLimit} WHERE ORG_CODE=#{orgCode} 
	</update>
	
</mapper>